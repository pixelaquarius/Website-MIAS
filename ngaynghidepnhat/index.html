<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Công Cụ Tính Ngày Nghỉ Phép - InnoTech</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-image: url('https://images.unsplash.com/photo-1517048676732-2d45ab40b106?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3w0NzEyNjZ8MHwxfHNlYXJjaHwxNXx8bGVhdmUlMjBvZmZpY2V8ZW58MHx8fHwxNjk5MTYwNzEzfDA&ixlib=rb-4.0.3&q=80&w=1080');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        /* Ẩn các view ban đầu */
        #formView, #countdownView, #historyView {
            display: none;
        }
        .container-card {
            background-color: rgba(255, 255, 255, 0.9);
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            max-width: 32rem;
            width: 100%;
        }
        /* CSS cho Modal (Thêm mới) */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 100; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.5); 
            padding-top: 60px;
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 2.5rem;
            border: 1px solid #888;
            width: 90%;
            max-width: 500px;
            border-radius: 0.5rem;
            animation-name: fadeIn;
            animation-duration: 0.3s;
            position: relative;
        }
        .close-btn {
            color: #aaa;
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
        }
        .close-btn:hover,
        .close-btn:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        @keyframes fadeIn {
            from {opacity: 0; transform: scale(0.95);}
            to {opacity: 1; transform: scale(1);}
        }
    </style>
</head>
<body>

    <!-- [THÊM MỚI] Hộp chứa thông báo (Toast) -->
    <div id="message-box-container" class="fixed top-5 right-5 z-50 w-64">
        <!-- Messages will be injected here -->
    </div>

    <div class="container-card">
        <!-- Header Công Ty -->
        <header class="flex items-center justify-center mb-6">
            <div class="p-3 bg-blue-600 rounded-lg text-white">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9" />
                </svg>
            </div>
            <h1 class="ml-4 text-3xl font-bold text-gray-800">InnoTech Solutions</h1>
        </header>

        <!-- View: Form Chính -->
        <main id="formView">
            <h2 class="text-2xl font-semibold text-center text-gray-700 mb-2">Tìm ngày nghỉ đẹp nhất của bạn</h2>
            <p class="text-center text-gray-500 mb-6">Dựa trên thần số học, hãy để chúng tôi tìm ngày nghỉ lý tưởng cho bạn!</p>
            <form id="vacationForm">
                <div class="mb-4">
                    <label for="name" class="block text-sm font-medium text-gray-600 mb-1">Họ và tên</label>
                    <input type="text" id="name" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Nguyễn Văn A" required>
                </div>
                <div class="mb-4">
                    <label for="dob" class="block text-sm font-medium text-gray-600 mb-1">Ngày sinh</label>
                    <input type="date" id="dob" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div class="mb-6">
                    <label for="position" class="block text-sm font-medium text-gray-600 mb-1">Vị trí công việc</label>
                    <input type="text" id="position" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Nhân viên Marketing" required>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-300">Tính toán ngay</button>
            </form>
             <!-- [THÊM MỚI] Nút xem Lịch sử -->
            <div class="text-center mt-4">
                 <button type="button" id="showHistoryBtn" class="text-sm text-blue-600 hover:underline">Xem lịch sử tính toán</button>
            </div>
        </main>

        <!-- View: Đếm Ngược (Trang Con) -->
        <section id="countdownView" class="text-center">
            <h2 class="text-2xl font-semibold text-gray-800 mb-2">Chúc mừng, <span id="countdownName" class="text-blue-600"></span>!</h2>
            <p class="text-gray-600 mb-6">Đây là thời gian đếm ngược đến ngày nghỉ hoàn hảo của bạn:</p>
            
            <div id="countdownTimer" class="flex justify-center space-x-4 text-gray-800 mb-8">
                <div class="text-center bg-gray-100 p-4 rounded-lg w-20">
                    <div id="days" class="text-4xl font-bold">00</div>
                    <div class="text-sm text-gray-500">Ngày</div>
                </div>
                <div class="text-center bg-gray-100 p-4 rounded-lg w-20">
                    <div id="hours" class="text-4xl font-bold">00</div>
                    <div class="text-sm text-gray-500">Giờ</div>
                </div>
                <div class="text-center bg-gray-100 p-4 rounded-lg w-20">
                    <div id="minutes" class="text-4xl font-bold">00</div>
                    <div class="text-sm text-gray-500">Phút</div>
                </div>
                <div class="text-center bg-gray-100 p-4 rounded-lg w-20">
                    <div id="seconds" class="text-4xl font-bold">00</div>
                    <div class="text-sm text-gray-500">Giây</div>
                </div>
            </div>

            <p class="text-lg font-medium">Ngày nghỉ của bạn là: <strong id="vacationDateDisplay" class="text-blue-600"></strong></p>
            
            <!-- Thư Cảm Ơn -->
            <div class="mt-8 bg-blue-50 border border-blue-200 p-4 rounded-lg text-left shadow-sm">
                <h4 class="font-semibold text-lg text-blue-700">Một lời cảm ơn từ InnoTech...</h4>
                <p class="text-gray-700 mt-2">
                    Cảm ơn <strong id="thankYouName" class="text-blue-700"></strong>, vì tất cả những nỗ lực và cống hiến của bạn. Chúng tôi trân trọng thời gian bạn đã đồng hành cùng công ty.
                </p>
                <p class="text-gray-700 mt-2">
                    Chúc bạn có một kỳ nghỉ thật sảng khoái, nạp đầy năng lượng và có những trải nghiệm tuyệt vời. Mong sớm được thấy bạn quay trở lại với những ý tưởng mới!
                </p>
            </div>

            <!-- Nhóm nút -->
            <div class="mt-6 flex flex-col sm:flex-row justify-center gap-3">
                <button id="showAnalysisBtn" class="bg-gray-600 text-white py-2 px-5 rounded-lg font-semibold hover:bg-gray-700 transition duration-300 flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    Xem phân tích thần số học
                </button>
                
                <button id="copyLinkBtn" class="bg-green-600 text-white py-2 px-5 rounded-lg font-semibold hover:bg-green-700 transition duration-300 flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                    </svg>
                    Sao chép link kỷ niệm
                </button>
            </div>
            
             <!-- [CẬP NHẬT] Link "Quay lại trang chủ" -->
            <a href="/" class="inline-block mt-6 text-sm text-blue-600 hover:underline">Quay lại trang chủ</a>
        </section>

        <!-- [CẬP NHẬT] View: Lịch Sử (Thay thế cho submittedView) -->
        <section id="historyView" class="text-left">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6 text-center">Lịch sử tính toán</h2>
            
            <div id="historyListContainer" class="max-h-64 overflow-y-auto bg-gray-50 border border-gray-200 rounded-lg p-3">
                <!-- Lịch sử sẽ được chèn vào đây bằng JS -->
                <p id="noHistoryText" class="text-gray-500 text-center">Chưa có lịch sử nào.</p>
                <ul id="historyList" class="divide-y divide-gray-200">
                    <!-- Ví dụ: 
                    <li class="py-2">
                        <a href="#" class="block hover:bg-gray-100 p-2 rounded-lg">
                            <div class="font-semibold text-blue-600">Nguyễn Văn A</div>
                            <div class="text-sm text-gray-600">Ngày nghỉ: 08-12-2025 (normal)</div>
                        </a>
                    </li>
                    -->
                </ul>
            </div>

            <div class="text-center mt-6">
                <button id="clearHistoryBtn" class="text-sm text-red-500 hover:underline font-medium">Xóa lịch sử</button>
                <button id="backToFormBtn" class="ml-4 bg-blue-600 text-white py-2 px-5 rounded-lg font-semibold hover:bg-blue-700 transition duration-300">
                    Quay lại
                </button>
            </div>
        </section>

    </div>

    <!-- Modal Phân Tích Thần Số Học -->
    <div id="analysisModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="closeModalBtn">&times;</span>
            <h3 class="text-2xl font-bold text-blue-600 mb-4">Phân Tích Thần Số Học Của Bạn</h3>
            
            <div class="mb-4">
                <p class="text-gray-600">Con số chủ đạo của bạn là: <strong id="lifePathNumber" class="text-xl text-blue-700"></strong></p>
            </div>
            
            <div class="mb-4">
                <h4 class="font-semibold text-lg text-gray-800 mb-2">Tính cách của bạn:</h4>
                <p id="personality" class="text-gray-700 whitespace-pre-line"></p>
            </div>
            
            <div>
                <h4 class="font-semibold text-lg text-gray-800 mb-2">Tại sao lại chọn ngày này?</h4>
                <p id="dateReasoning" class="text-gray-700 whitespace-pre-line"></p>
            </div>
        </div>
    </div>

    <!-- Modal Thông Báo Bất Ngờ (Troll Popup) -->
    <div id="trollModal" class="modal">
        <div class="modal-content text-center">
            <span class="close-btn" id="closeTrollModalBtn">&times;</span>
            <div class="flex justify-center mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-20 w-20 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
            </div>
            <h3 id="trollTitle" class="text-3xl font-bold text-red-600 mb-4">THÔNG BÁO KHẨN!</h3>
            
            <p id="trollMessage" class="text-lg text-gray-700 leading-relaxed"></p>

            <button id="closeTrollModalBtn2" class="mt-6 bg-blue-600 text-white py-2 px-5 rounded-lg font-semibold hover:bg-blue-700 transition duration-300">
                Tôi... đã hiểu...
            </button>
        </div>
    </div>


    <script>
        // [CẬP NHẬT] Thay đổi key
        const HISTORY_STORAGE_KEY = 'companyVacationHistory';

        // --- Logic Hiển thị Thông báo (Toast) ---
        /**
         * Hiển thị thông báo toast ở góc trên bên phải.
         * @param {string} message - Nội dung thông báo.
         * @param {string} [type='success'] - 'success' (xanh) hoặc 'error' (đỏ).
         */
        function showMessage(message, type = 'success') {
            const container = document.getElementById('message-box-container');
            const msgId = 'msg-' + Date.now();
            const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
            
            const msgDiv = document.createElement('div');
            msgDiv.id = msgId;
            msgDiv.className = `p-4 rounded-lg text-white font-semibold shadow-lg mb-2 ${bgColor} transition-all duration-300 transform translate-x-10 opacity-0`;
            msgDiv.textContent = message;
            
            container.appendChild(msgDiv);
            
            setTimeout(() => {
                msgDiv.classList.remove('translate-x-10', 'opacity-0');
            }, 10);

            setTimeout(() => {
                msgDiv.classList.add('opacity-0', 'translate-y-2');
                setTimeout(() => {
                    if (msgDiv) {
                        msgDiv.remove();
                    }
                }, 500);
            }, 3000);
        }

        // --- Logic Sao Chép Link ---
        /**
         * Sao chép URL hiện tại vào clipboard.
         */
        function copyLinkToClipboard() {
            const linkToCopy = window.location.href;
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = linkToCopy;
            tempTextArea.style.position = 'absolute';
            tempTextArea.style.left = '-9999px';
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            tempTextArea.setSelectionRange(0, 99999);
            
            try {
                document.execCommand('copy');
                showMessage('Đã sao chép link!', 'success');
            } catch (err) {
                console.error('Không thể sao chép link: ', err);
                showMessage('Lỗi! Không thể sao chép.', 'error');
            }
            
            document.body.removeChild(tempTextArea);
        }


        // --- Logic Thần Số Học (Numerology Logic) ---

        /**
         * Rút gọn một chuỗi số thành một chữ số hoặc số master (11, 22).
         */
        function reduceDigits(str, checkMaster = false) {
            let sum = str.split('').reduce((acc, digit) => acc + parseInt(digit), 0);
            if (checkMaster && (sum === 11 || sum === 22)) {
                return sum;
            }
            if (sum > 9) {
                return reduceDigits(sum.toString(), checkMaster);
            }
            return sum;
        }

        /**
         * Tính số chủ đạo (Life Path Number) từ ngày sinh.
         */
        function calculateLifePath(dobString) {
            const [year, month, day] = dobString.split('-');
            const yearReduced = reduceDigits(year);
            const monthReduced = reduceDigits(month);
            const dayReduced = reduceDigits(day);
            const total = yearReduced + monthReduced + dayReduced;
            return reduceDigits(total.toString(), true);
        }

        /**
         * Cung cấp phân tích dựa trên số chủ đạo.
         */
        function getNumerologyAnalysis(lifePath) {
            const analysis = {
                personality: "",
                reasoning: ""
            };

            switch (lifePath) {
                case 1:
                    analysis.personality = "Bạn là người có số 1, người tiên phong, độc lập và đầy tham vọng. Bạn có tố chất lãnh đạo bẩm sinh và luôn muốn đứng đầu.";
                    analysis.reasoning = "Ngày 1 (hoặc 10, 19, 28 - rút gọn về 1) là ngày của sự khởi đầu mới. Đây là lúc năng lượng của bạn mạnh nhất để bắt đầu một kỳ nghỉ, tự thưởng cho bản thân sau những nỗ lực dẫn dắt.";
                    break;
                case 2:
                    analysis.personality = "Bạn là người có số 2, người của sự hợp tác, ngoại giao và nhạy cảm. Bạn trân trọng các mối quan hệ và sự hài hòa.";
                    analysis.reasoning = "Ngày 2 (hoặc 11, 20, 29) mang năng lượng của sự kết nối. Đây là ngày lý tưởng để bạn nghỉ ngơi, dành thời gian cho những người thân yêu và tái tạo lại cảm xúc.";
                    break;
                case 3:
                    analysis.personality = "Bạn là người có số 3, người sáng tạo, giao tiếp tốt và có khiếu hài hước. Bạn luôn lạc quan và truyền cảm hứng cho người khác.";
                    analysis.reasoning = "Ngày 3 (hoặc 12, 21, 30) là ngày của sự thể hiện bản thân. Kỳ nghỉ vào ngày này sẽ giúp bạn bùng nổ sáng tạo, vui chơi và tận hưởng cuộc sống.";
                    break;
                case 4:
                    analysis.personality = "Bạn là người có số 4, người của sự ổn định, thực tế và chăm chỉ. Bạn là nền tảng vững chắc của mọi tổ chức.";
                    analysis.reasoning = "Ngày 4 (hoặc 13, 22, 31) là ngày của sự tổ chức. Bạn xứng đáng có một kỳ nghỉ có kế hoạch, vững chắc vào ngày này để 'xây dựng' lại năng lượng của mình.";
                    break;
                case 5:
                    analysis.personality = "Bạn là người có số 5, người yêu tự do, phiêu lưu và thích sự thay đổi. Bạn tò mò và luôn tìm kiếm những trải nghiệm mới.";
                    analysis.reasoning = "Ngày 5 (hoặc 14, 23) là ngày của sự tự do và thay đổi. Một kỳ nghỉ vào ngày này sẽ thỏa mãn khao khát phiêu lưu, khám phá những điều mới mẻ của bạn.";
                    break;
                case 6:
                    analysis.personality = "Bạn là người có số 6, người của gia đình, trách nhiệm và lòng trắc ẩn. Bạn luôn quan tâm và chăm sóc cho người khác.";
                    analysis.reasoning = "Ngày 6 (hoặc 15, 24) là ngày của tình yêu thương và gia đình. Đây là thời điểm hoàn hảo để bạn nghỉ ngơi, chăm sóc bản thân và những người bạn yêu thương.";
                    break;
                case 7:
                    analysis.personality = "Bạn là người có số 7, người nội tâm, thông thái và thích phân tích. Bạn cần không gian riêng để suy ngẫm và chiêm nghiệm.";
                    analysis.reasoning = "Ngày 7 (hoặc 16, 25) là ngày của tâm linh và nội tâm. Kỳ nghỉ vào ngày này sẽ cho bạn không gian yên tĩnh cần thiết để suy ngẫm, học hỏi và kết nối sâu sắc với bản thân.";
                    break;
                case 8:
                    analysis.personality = "Bạn là người có số 8, người quyền lực, tham vọng và có khả năng điều hành. Bạn tập trung vào thành công vật chất và sự nghiệp.";
                    analysis.reasoning = "Ngày 8 (hoặc 17, 26) là ngày của sự thịnh vượng và quyền lực. Một kỳ nghỉ vào ngày này là sự tưởng thưởng xứng đáng cho những nỗ lực của bạn, giúp bạn nạp lại năng lượng để đạt được những thành tựu lớn hơn.";
                    break;
                case 9:
                    analysis.personality = "Bạn là người có số 9, người nhân ái, lý tưởng và có tầm nhìn rộng. Bạn muốn cống hiến và giúp đỡ thế giới.";
                    analysis.reasoning = "Ngày 9 (hoặc 18, 27) là ngày của sự hoàn thành và cho đi. Đây là lúc để bạn kết thúc một chu kỳ làm việc, nghỉ ngơi và suy ngẫm về những giá trị lớn lao hơn trong cuộc sống.";
                    break;
                case 11:
                    analysis.personality = "Bạn là người có số Master 11/2, người có trực giác cực kỳ nhạy bén và khả năng truyền cảm hứng. Bạn mang một năng lượng tâm linh mạnh mẽ.";
                    analysis.reasoning = "Ngày 11 (hoặc 29) là ngày 'Master' mang năng lượng của sự khai sáng. Một kỳ nghỉ vào ngày này sẽ giúp bạn kết nối với trực giác của mình ở mức độ sâu hơn.";
                    break;
                case 22:
                    analysis.personality = "Bạn là người có số Master 22/4, 'Master Builder'. Bạn có khả năng biến những ước mơ lớn lao thành hiện thực một cách thực tế.";
                    analysis.reasoning = "Ngày 22 (hoặc 4, 13, 31) là ngày 'Master' của sự kiến tạo. Kỳ nghỉ vào ngày này sẽ giúp bạn sạc lại năng lượng để tiếp tục 'xây dựng' những dự án vĩ đại của mình.";
                    break;
                default:
                    analysis.personality = "Không tìm thấy phân tích.";
                    analysis.reasoning = "Không tìm thấy lý do.";
            }
            return analysis;
        }

        /**
         * Tính ngày nghỉ dựa trên số chủ đạo HOẶC TROLL.
         */
        function calculateVacationDate(dob) {
            const lifePath = calculateLifePath(dob);
            const today = new Date();
            let vacationDate;
            let fate;

            const rand = Math.random(); 

            if (rand < 0.8) {
                // 80% cơ hội: Bình thường (Thần số học + Random năm)
                fate = 'normal';
                const vacationDayOfMonth = lifePath;
                const randomYearOffset = Math.floor(Math.random() * 11); // 0-10
                const targetYear = today.getFullYear() + randomYearOffset;
                const targetMonth = today.getMonth() + 1;
                vacationDate = new Date(targetYear, targetMonth, vacationDayOfMonth);

            } else if (rand < 0.9) {
                // 10% cơ hội: Nghỉ ngày mai
                fate = 'tomorrow';
                vacationDate = new Date(today.getTime() + (24 * 60 * 60 * 1000));
            } else {
                // 10% cơ hội: Troll 999 năm
                fate = 'troll_999';
                vacationDate = new Date(today.getFullYear() + 999, today.getMonth(), today.getDate());
            }
            
            return { date: vacationDate, fate: fate, lifePath: lifePath };
        }

        // --- Logic Điều Hướng Trang (View Logic) ---

        const formView = document.getElementById('formView');
        const countdownView = document.getElementById('countdownView');
        const historyView = document.getElementById('historyView'); // [CẬP NHẬT]

        function showView(view) {
            formView.style.display = 'none';
            countdownView.style.display = 'none';
            historyView.style.display = 'none'; // [CẬP NHẬT]
            view.style.display = 'block';
        }

        /**
         * Hiển thị trang đếm ngược.
         */
        function showCountdownView(dateString, name) {
            document.getElementById('countdownName').textContent = name;
            document.getElementById('thankYouName').textContent = name;
            
            const [year, month, day] = dateString.split('-').map(Number);
            const vacationDate = new Date(year, month - 1, day);

            const displayDate = vacationDate.toLocaleDateString('vi-VN', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
            document.getElementById('vacationDateDisplay').textContent = displayDate;
            
            showView(countdownView);

            // Xử lý Modal Phân Tích
            const urlParams = new URLSearchParams(window.location.search);
            const lifePath = parseInt(urlParams.get('lp'));
            const fate = urlParams.get('fate');
            
            if (lifePath) {
                const analysis = getNumerologyAnalysis(lifePath);
                document.getElementById('lifePathNumber').textContent = lifePath;
                document.getElementById('personality').textContent = analysis.personality;
                document.getElementById('dateReasoning').textContent = analysis.reasoning;
            }

            // Kích hoạt popup troll nếu cần
            if (fate === 'tomorrow' || fate === 'troll_999') {
                showTrollPopup(fate, name, displayDate);
            }

            startCountdown(dateString);
        }

        /**
         * [THÊM MỚI] Hiển thị trang lịch sử.
         */
        function showHistoryView() {
            showView(historyView);
            const historyList = document.getElementById('historyList');
            const noHistoryText = document.getElementById('noHistoryText');
            historyList.innerHTML = ''; // Xóa cũ

            const history = JSON.parse(localStorage.getItem(HISTORY_STORAGE_KEY) || '[]');

            if (history.length === 0) {
                noHistoryText.style.display = 'block';
            } else {
                noHistoryText.style.display = 'none';
                history.forEach(entry => {
                    const li = document.createElement('li');
                    li.className = 'py-2';
                    
                    const a = document.createElement('a');
                    const params = `?date=${entry.date}&name=${encodeURIComponent(entry.name)}&lp=${entry.lifePath}&fate=${entry.fate}`;
                    a.href = window.location.pathname + params;
                    a.className = 'block hover:bg-gray-100 p-2 rounded-lg transition-colors';
                    
                    a.innerHTML = `
                        <div class="font-semibold text-blue-600">${entry.name}</div>
                        <div class="text-sm text-gray-600">Ngày nghỉ: ${entry.date} (${entry.fate})</div>
                    `;
                    
                    li.appendChild(a);
                    historyList.appendChild(li);
                });
            }
        }

        /**
         * Hiển thị popup troll.
         */
        function showTrollPopup(fate, name, displayDate) {
            const modal = document.getElementById('trollModal');
            const title = document.getElementById('trollTitle');
            const message = document.getElementById('trollMessage');

            if (fate === 'tomorrow') {
                title.textContent = "BẤT NGỜ CHƯA!";
                message.innerHTML = `Xin chào <strong class="text-blue-600">${name}</strong>,<br><br>Sếp vừa xem xét trường hợp của bạn và quyết định... cho bạn <strong class="text-red-600">NGHỈ LUÔN NGÀY MAI</strong>!<br><br>Hãy nhanh chóng chuẩn bị hồ sơ bàn giao công việc. Chúc may mắn!`;
            } else if (fate === 'troll_999') {
                title.textContent = "TIN CỰC VUI!";
                message.innerHTML = `Xin chào <strong class="text-blue-600">${name}</strong>,<br><br>Với những cống hiến của bạn, công ty quyết định <strong class="text-red-600">gia hạn hợp đồng</strong> cho bạn thêm 999 năm.<br><br>Ngày nghỉ lý tưởng tiếp theo của bạn được chốt là: <strong class="text-blue-600">${displayDate}</strong>. Hãy tiếp tục làm việc chăm chỉ nhé!`;
            }

            setTimeout(() => {
                modal.style.display = 'block';
            }, 1000); 
        }

        // --- Logic Đếm Ngược (Countdown Logic) ---
        let countdownInterval;
        function startCountdown(targetDate) {
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }

            const [year, month, day] = targetDate.split('-').map(Number);
            const countDownDate = new Date(year, month - 1, day).getTime();

            countdownInterval = setInterval(() => {
                const now = new Date().getTime();
                const distance = countDownDate - now;

                if (distance < 0) {
                    clearInterval(countdownInterval);
                    document.getElementById('countdownTimer').innerHTML = '<p class="text-2xl font-bold text-green-600">Chúc bạn có kỳ nghỉ vui vẻ!</p>';
                    return;
                }

                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                const z = (n) => n < 10 ? '0' + n : n;

                document.getElementById('days').textContent = z(days);
                document.getElementById('hours').textContent = z(hours);
                document.getElementById('minutes').textContent = z(minutes);
                document.getElementById('seconds').textContent = z(seconds);

            }, 1000);
        }

        // --- Xử Lý Sự Kiện (Event Handlers) ---

        // Xử lý khi nộp form
        document.getElementById('vacationForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const name = document.getElementById('name').value;
            const dob = document.getElementById('dob').value;
            const position = document.getElementById('position').value;

            const { date: vacationDate, fate, lifePath } = calculateVacationDate(dob);
            
            const year = vacationDate.getFullYear();
            const month = (vacationDate.getMonth() + 1).toString().padStart(2, '0');
            const day = vacationDate.getDate().toString().padStart(2, '0');
            const vacationDateISO = `${year}-${month}-${day}`;
            
            // [CẬP NHẬT] Lưu vào lịch sử (array)
            let history = JSON.parse(localStorage.getItem(HISTORY_STORAGE_KEY) || '[]');
            const newEntry = {
                date: vacationDateISO,
                name: name,
                position: position,
                lifePath: lifePath,
                fate: fate,
                timestamp: new Date().toISOString()
            };
            history.unshift(newEntry); // Thêm vào đầu danh sách
            localStorage.setItem(HISTORY_STORAGE_KEY, JSON.stringify(history));

            // Chuyển hướng
            window.location.href = window.location.pathname + `?date=${vacationDateISO}&name=${encodeURIComponent(name)}&lp=${lifePath}&fate=${fate}`;
        });

        // --- Logic Khởi Động (Initialization Logic) ---
        
        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const paramDate = urlParams.get('date');
            const paramName = urlParams.get('name');
            
            // [CẬP NHẬT] Logic load trang
            if (paramDate && paramName) {
                // Nếu có tham số URL -> Hiển thị trang đếm ngược
                showCountdownView(paramDate, paramName);
            } else {
                // Nếu không -> Hiển thị trang form
                showView(formView);
            }
            
            // Gán sự kiện cho các nút modal Phân tích
            const analysisModal = document.getElementById('analysisModal');
            const showBtn = document.getElementById('showAnalysisBtn');
            const closeAnalysisBtn = document.getElementById('closeModalBtn');
            const copyBtn = document.getElementById('copyLinkBtn'); 

            if (showBtn) {
                showBtn.onclick = () => {
                    analysisModal.style.display = 'block';
                }
            }
            if (closeAnalysisBtn) {
                closeAnalysisBtn.onclick = () => {
                    analysisModal.style.display = 'none';
                }
            }
            if (copyBtn) {
                copyBtn.onclick = copyLinkToClipboard;
            }

            // Gán sự kiện cho các nút modal Troll
            const trollModal = document.getElementById('trollModal');
            const closeTrollBtn = document.getElementById('closeTrollModalBtn');
            const closeTrollBtn2 = document.getElementById('closeTrollModalBtn2');

            const closeTroll = () => {
                trollModal.style.display = 'none';
            };
            if(closeTrollBtn) closeTrollBtn.onclick = closeTroll;
            if(closeTrollBtn2) closeTrollBtn2.onclick = closeTroll;

            // [THÊM MỚI] Gán sự kiện cho các nút Lịch sử
            const showHistoryBtn = document.getElementById('showHistoryBtn');
            const backToFormBtn = document.getElementById('backToFormBtn');
            const clearHistoryBtn = document.getElementById('clearHistoryBtn');

            if(showHistoryBtn) {
                showHistoryBtn.onclick = showHistoryView;
            }
            if(backToFormBtn) {
                backToFormBtn.onclick = () => {
                    showView(formView);
                };
            }
            if(clearHistoryBtn) {
                clearHistoryBtn.onclick = () => {
                    // Yêu cầu xác nhận (vì đây là hành động nguy hiểm)
                    if (confirm('Bạn có chắc muốn xóa toàn bộ lịch sử không?')) {
                        localStorage.removeItem(HISTORY_STORAGE_KEY);
                        showHistoryView(); // Cập nhật lại view
                        showMessage('Đã xóa lịch sử.', 'success');
                    }
                };
            }

            // Đóng modal khi nhấp ra ngoài
            window.onclick = (event) => {
                if (event.target == analysisModal) {
                    analysisModal.style.display = 'none';
                }
                if (event.target == trollModal) {
                    trollModal.style.display = 'none';
                }
            }
        });

    </script>
</body>
</html>
