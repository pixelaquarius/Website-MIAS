<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Công Cụ Tính Ngày Nghỉ Phép - InnoTech</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            /* Thêm hình nền nghỉ việc */
            background-image: url('https://images.unsplash.com/photo-1517048676732-2d45ab40b106?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3w0NzEyNjZ8MHwxfHNlYXJjaHwxNXx8bGVhdmUlMjBvZmZpY2V8ZW58MHx8fHwxNjk5MTYwNzEzfDA&ixlib=rb-4.0.3&q=80&w=1080'); /* Thay đổi URL hình ảnh tại đây */
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        /* Ẩn các view ban đầu */
        #formView, #countdownView, #submittedView {
            display: none;
        }
        .container-card {
            background-color: rgba(255, 255, 255, 0.9); /* Làm mờ nền trắng để dễ đọc hơn */
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            max-width: 32rem; /* Giới hạn chiều rộng để dễ đọc */
            width: 100%;
        }
        /* CSS cho Modal (Thêm mới) */
        .modal {
            display: none; /* Ẩn mặc định */
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            padding-top: 60px;
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 24px;
            border: 1px solid #888;
            width: 90%;
            max-width: 600px;
            border-radius: 0.75rem;
            position: relative;
            animation: fadeIn 0.3s;
        }
        .close-btn {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-btn:hover,
        .close-btn:focus {
            color: black;
        }
        @keyframes fadeIn {
            from {opacity: 0; transform: scale(0.95);}
            to {opacity: 1; transform: scale(1);}
        }
    </style>
</head>
<body>

    <!-- [THÊM MỚI] Hộp chứa thông báo (Toast) -->
    <div id="message-box-container" class="fixed top-5 right-5 z-50 w-64">
        <!-- Messages will be injected here -->
    </div>

    <div class="container-card">
        <!-- Header Công Ty --><header class="flex items-center justify-center mb-6">
            <div class="p-3 bg-blue-600 rounded-lg text-white">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9" />
                </svg>
            </div>
            <h1 class="ml-4 text-3xl font-bold text-gray-800">InnoTech Solutions</h1>
        </header>

        <!-- View 1: Form Đăng Ký --><main id="formView">
            <h2 class="text-2xl font-semibold text-center text-gray-700 mb-2">Tìm ngày nghỉ đẹp nhất của bạn</h2>
            <p class="text-center text-gray-500 mb-6">Dựa trên thần số học, hãy để chúng tôi tìm ngày nghỉ lý tưởng cho bạn!</p>
            <form id="vacationForm">
                <div class="mb-4">
                    <label for="name" class="block text-sm font-medium text-gray-600 mb-1">Họ và tên</label>
                    <input type="text" id="name" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Nguyễn Văn A" required>
                </div>
                <div class="mb-4">
                    <label for="dob" class="block text-sm font-medium text-gray-600 mb-1">Ngày sinh</label>
                    <input type="date" id="dob" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div class="mb-6">
                    <label for="position" class="block text-sm font-medium text-gray-600 mb-1">Vị trí công việc</label>
                    <input type="text" id="position" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Nhân viên Marketing" required>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-300">Tính toán ngay</button>
            </form>
        </main>

        <!-- View 2: Trang "SubHTML" - Đếm Ngược --><section id="countdownView" class="text-center">
            <h2 class="text-2xl font-semibold text-gray-800 mb-2">Chúc mừng, <span id="countdownName" class="text-blue-600"></span>!</h2>
            <p class="text-gray-600 mb-6">Đây là thời gian đếm ngược đến ngày nghỉ hoàn hảo của bạn:</p>
            
            <div id="countdownTimer" class="flex justify-center space-x-4 text-gray-800 mb-8">
                <div class="text-center bg-gray-100 p-4 rounded-lg w-20">
                    <div id="days" class="text-4xl font-bold">00</div>
                    <div class="text-sm text-gray-500">Ngày</div>
                </div>
                <div class="text-center bg-gray-100 p-4 rounded-lg w-20">
                    <div id="hours" class="text-4xl font-bold">00</div>
                    <div class="text-sm text-gray-500">Giờ</div>
                </div>
                <div class="text-center bg-gray-100 p-4 rounded-lg w-20">
                    <div id="minutes" class="text-4xl font-bold">00</div>
                    <div class="text-sm text-gray-500">Phút</div>
                </div>
                <div class="text-center bg-gray-100 p-4 rounded-lg w-20">
                    <div id="seconds" class="text-4xl font-bold">00</div>
                    <div class="text-sm text-gray-500">Giây</div>
                </div>
            </div>

            <p class="text-lg font-medium">Ngày nghỉ của bạn là: <strong id="vacationDateDisplay" class="text-blue-600"></strong></p>
            
            <!-- [THÊM MỚI] Thư Cảm Ơn -->
            <div class="mt-8 bg-blue-50 border border-blue-200 p-4 rounded-lg text-left shadow-sm">
                <h4 class="font-semibold text-lg text-blue-700">Một lời cảm ơn từ InnoTech...</h4>
                <p class="text-gray-700 mt-2">
                    Cảm ơn <strong id="thankYouName" class="text-blue-700"></strong>, vì tất cả những nỗ lực và cống hiến của bạn. Chúng tôi trân trọng thời gian bạn đã đồng hành cùng công ty.
                </p>
                <p class="text-gray-700 mt-2">
                    Chúc bạn có một kỳ nghỉ thật sảng khoái, nạp đầy năng lượng và có những trải nghiệm tuyệt vời. Mong sớm được thấy bạn quay trở lại với những ý tưởng mới!
                </p>
            </div>

            <!-- [CẬP NHẬT] Nhóm nút -->
            <div class="mt-6 flex flex-col sm:flex-row justify-center gap-3">
                <!-- Nút mở Modal (Cập nhật với icon) -->
                <button id="showAnalysisBtn" class="bg-gray-600 text-white py-2 px-5 rounded-lg font-semibold hover:bg-gray-700 transition duration-300 flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    Xem phân tích thần số học
                </button>
                
                <!-- [THÊM MỚI] Nút Copy Link -->
                <button id="copyLinkBtn" class="bg-green-600 text-white py-2 px-5 rounded-lg font-semibold hover:bg-green-700 transition duration-300 flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                    </svg>
                    Sao chép link kỷ niệm
                </button>
            </div>
            
            <a href="/" class="inline-block mt-6 text-sm text-blue-600 hover:underline">Quay lại trang chủ</a>
        </section>

        <!-- View 3: Đã Đăng Ký --><section id="submittedView" class="text-center">
            <h2 class="text-2xl font-semibold text-gray-800 mb-2">Bạn đã đăng ký!</h2>
            <p class="text-gray-600 mb-6">Xin chào <span id="submittedName" class="font-semibold"></span>, bạn đã tìm ngày nghỉ của mình trước đó. Hãy chuẩn bị cho kỳ nghỉ nhé!</p>
            <button id="viewCountdownBtn" class="bg-blue-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-blue-700 transition duration-300">
                Xem lại đồng hồ đếm ngược
            </button>
        </section>
    </div>

    <!-- Modal Phân Tích Thần Số Học (Thêm mới) -->
    <div id="analysisModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="closeModalBtn">&times;</span>
            <h3 class="text-2xl font-bold text-blue-600 mb-4">Phân Tích Thần Số Học Của Bạn</h3>
            
            <div class="mb-4">
                <p class="text-lg">Số chủ đạo của bạn là: <strong id="lifePathNumberDisplay" class="text-gray-800"></strong></p>
            </div>
            
            <div class="mb-4">
                <h4 class="text-lg font-semibold text-gray-700 mb-2">Đặc điểm tính cách của bạn:</h4>
                <p id="personalityAnalysis" class="text-gray-600"></p>
            </div>
            
            <div>
                <h4 class="text-lg font-semibold text-gray-700 mb-2">Tại sao chúng tôi chọn ngày này cho bạn:</h4>
                <p id="dateReasoning" class="text-gray-600"></p>
            </div>
        </div>
    </div>


    <script>
        const STORAGE_KEY = 'companyVacationFinder';

        // --- [THÊM MỚI] Logic Hiển thị Thông báo (Toast) ---
        /**
         * Hiển thị thông báo toast ở góc trên bên phải.
         * @param {string} message - Nội dung thông báo.
         * @param {string} [type='success'] - 'success' (xanh) hoặc 'error' (đỏ).
         */
        function showMessage(message, type = 'success') {
            const container = document.getElementById('message-box-container');
            const msgId = 'msg-' + Date.now();
            const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
            
            const msgDiv = document.createElement('div');
            msgDiv.id = msgId;
            // Lớp Tailwind cho hiệu ứng
            msgDiv.className = `p-4 rounded-lg text-white font-semibold shadow-lg mb-2 ${bgColor} transition-all duration-300 transform translate-x-10 opacity-0`;
            msgDiv.textContent = message;
            
            container.appendChild(msgDiv);
            
            // Animate vào
            setTimeout(() => {
                msgDiv.classList.remove('translate-x-10', 'opacity-0');
            }, 10);

            // Animate ra và tự hủy
            setTimeout(() => {
                msgDiv.classList.add('opacity-0', 'translate-y-2');
                setTimeout(() => {
                    if (msgDiv) {
                        msgDiv.remove();
                    }
                }, 500);
            }, 3000);
        }

        // --- [THÊM MỚI] Logic Sao Chép Link ---
        /**
         * Sao chép URL hiện tại vào clipboard.
         */
        function copyLinkToClipboard() {
            const linkToCopy = window.location.href;
            
            // Tạo một textarea tạm thời để giữ text
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = linkToCopy;
            tempTextArea.style.position = 'absolute';
            tempTextArea.style.left = '-9999px'; // Ẩn nó đi
            document.body.appendChild(tempTextArea);
            
            // Chọn và sao chép
            tempTextArea.select();
            tempTextArea.setSelectionRange(0, 99999); // Cho di động
            
            try {
                document.execCommand('copy');
                showMessage('Đã sao chép link!', 'success');
            } catch (err) {
                console.error('Không thể sao chép link: ', err);
                showMessage('Lỗi! Không thể sao chép.', 'error');
            }
            
            // Dọn dẹp
            document.body.removeChild(tempTextArea);
        }


        // --- Logic Thần Số Học (Numerology Logic) ---

        /**
         * Rút gọn một chuỗi số thành một chữ số hoặc số master (11, 22).
         * @param {string} str - Chuỗi số (ví dụ: "1995" hoặc "23").
         * @param {boolean} [checkMaster=false] - Có kiểm tra số master (11, 22) không.
         * @returns {number} - Số đã rút gọn.
         */
        function reduceDigits(str, checkMaster = false) {
            let sum = str.split('').reduce((acc, digit) => acc + parseInt(digit), 0);

            if (checkMaster && (sum === 11 || sum === 22)) {
                return sum;
            }
            if (sum > 9) {
                return reduceDigits(sum.toString(), checkMaster);
            }
            return sum;
        }

        /**
         * Tính số chủ đạo (Life Path Number) từ ngày sinh.
         * @param {string} dobString - Ngày sinh dạng "YYYY-MM-DD".
         * @returns {number} - Số chủ đạo (1-9, 11, hoặc 22).
         */
        function calculateLifePath(dobString) {
            const [year, month, day] = dobString.split('-');

            const yearReduced = reduceDigits(year);
            const monthReduced = reduceDigits(month);
            const dayReduced = reduceDigits(day);

            const total = yearReduced + monthReduced + dayReduced;
            
            // Lần rút gọn cuối cùng kiểm tra số master
            return reduceDigits(total.toString(), true);
        }

        /**
         * Cung cấp phân tích dựa trên số chủ đạo. (Thêm mới)
         * @param {number} lifePath - Số chủ đạo (1-9, 11, 22).
         * @returns {object} - { personality: string, reasoning: string }
         */
        function getNumerologyAnalysis(lifePath) {
            const analysis = {
                personality: "",
                reasoning: ""
            };

            switch (lifePath) {
                case 1:
                    analysis.personality = "Bạn là người tiên phong, độc lập và có tố chất lãnh đạo. Bạn đầy tham vọng, quyết đoán và thích tự mình giải quyết vấn đề.";
                    analysis.reasoning = "Ngày nghỉ được chọn (ngày 1 của tháng) tượng trưng cho sự khởi đầu mới. Đây là cơ hội để bạn 'sạc' lại năng lượng lãnh đạo và bắt đầu một dự án cá nhân mới mà bạn hằng ấp ủ.";
                    break;
                case 2:
                    analysis.personality = "Bạn là người nhạy cảm, giàu lòng trắc ẩn và là nhà ngoại giao bẩm sinh. Bạn coi trọng sự hợp tác, hòa bình và các mối quan hệ.";
                    analysis.reasoning = "Ngày 2 là ngày của sự kết nối. Ngày nghỉ này lý tưởng để bạn hàn gắn hoặc củng cố các mối quan hệ, dành thời gian chất lượng cho người thân yêu và tìm lại sự cân bằng nội tâm.";
                    break;
                case 3:
                    analysis.personality = "Bạn là người sáng tạo, lạc quan và có khả năng giao tiếp tuyệt vời. Bạn truyền cảm hứng và mang lại niềm vui cho những người xung quanh.";
                    analysis.reasoning = "Ngày 3 là ngày của sự thể hiện. Hãy dùng ngày nghỉ này để theo đuổi một sở thích sáng tạo (vẽ, viết, chơi nhạc) hoặc đơn giản là đi giao lưu, kết nối và lan tỏa năng lượng tích cực của bạn.";
                    break;
                case 4:
                    analysis.personality = "Bạn là người thực tế, có tổ chức, đáng tin cậy và chăm chỉ. Bạn là nền tảng vững chắc của bất kỳ tổ chức nào.";
                    analysis.reasoning = "Ngày 4 tượng trưng cho sự ổn định. Sau thời gian làm việc chăm chỉ, ngày nghỉ này là để bạn xây dựng lại 'nền móng' của mình: nghỉ ngơi, dọn dẹp nhà cửa, hoặc lập kế hoạch cho tương lai một cách có hệ thống.";
                    break;
                case 5:
                    analysis.personality = "Bạn là người yêu tự do, thích phiêu lưu và tò mò. Bạn dễ thích nghi và luôn tìm kiếm những trải nghiệm mới.";
                    analysis.reasoning = "Ngày 5 là ngày của sự tự do và thay đổi. Ngày nghỉ này hoàn hảo cho một chuyến đi ngẫu hứng, thử một điều gì đó hoàn toàn mới, hoặc đơn giản là thoát khỏi mọi lịch trình để làm bất cứ điều gì bạn muốn.";
                    break;
                case 6:
                    analysis.personality = "Bạn là người có trách nhiệm, giàu tình yêu thương và luôn chăm sóc người khác. Bạn coi trọng gia đình và sự hòa hợp trong cộng đồng.";
                    analysis.reasoning = "Ngày 6 là ngày của gia đình và trách nhiệm. Hãy dùng ngày nghỉ này để chăm sóc bản thân (điều bạn thường quên) hoặc dành trọn vẹn thời gian để vun đắp cho tổ ấm và những người bạn yêu thương.";
                    break;
                case 7:
                    analysis.personality = "Bạn là nhà phân tích, có trực giác tốt và là người tìm kiếm tri thức. Bạn thích dành thời gian một mình để suy ngẫm và tìm hiểu sâu về thế giới.";
                    analysis.reasoning = "Ngày 7 là ngày của tâm linh và trí tuệ. Đây là ngày nghỉ lý tưởng để bạn 'ẩn mình', đọc một cuốn sách hay, thiền, hoặc đi dạo một mình trong thiên nhiên để kết nối lại với tiếng nói bên trong bạn.";
                    break;
                case 8:
                    analysis.personality = "Bạn là người mạnh mẽ, có uy quyền và có tư duy về thành công, vật chất. Bạn có khả năng điều hành và tổ chức xuất sắc.";
                    analysis.reasoning = "Ngày 8 là ngày của sức mạnh và sự thịnh vượng. Ngày nghỉ này là để bạn tận hưởng thành quả của mình (ví dụ: một bữa tối sang trọng) hoặc lập kế hoạch chiến lược cho các mục tiêu tài chính tiếp theo của bạn.";
                    break;
                case 9:
                    analysis.personality = "Bạn là người nhân ái, có lý tưởng và luôn quan tâm đến lợi ích cộng đồng. Bạn là một nhà nhân đạo bẩm sinh.";
                    analysis.reasoning = "Ngày 9 là ngày của sự hoàn thành và cho đi. Ngày nghỉ này là cơ hội để bạn nhìn lại những gì đã qua, buông bỏ những điều cũ và có thể làm một việc tốt cho cộng đồng hoặc người khác.";
                    break;
                case 11:
                    analysis.personality = "Bạn là người có trực giác cực kỳ nhạy bén (Số Master). Bạn có khả năng truyền cảm hứng và tầm nhìn sâu sắc, nhưng cũng dễ bị căng thẳng.";
                    analysis.reasoning = "Ngày 11 (Master) là ngày của sự khai sáng tâm linh. Ngày nghỉ này là thời điểm hoàn hảo để bạn tin tưởng vào trực giác của mình. Hãy làm điều gì đó giúp bạn kết nối với mục đích cao cả hơn, như thiền định hoặc viết nhật ký.";
                    break;
                case 22:
                    analysis.personality = "Bạn là 'Kiến trúc sư bậc thầy' (Số Master). Bạn có khả năng biến những giấc mơ lớn thành hiện thực, kết hợp lý tưởng (11) với tính thực tế (4).";
                    analysis.reasoning = "Ngày 22 (Master) là ngày của sự kiến tạo. Ngày nghỉ này là để bạn nghỉ ngơi một cách có mục đích, lên kế hoạch chi tiết cho 'dự án lớn' tiếp theo của bạn, dù đó là sự nghiệp hay cuộc sống cá nhân.";
                    break;
                default:
                    analysis.personality = "Số của bạn rất đặc biệt, hãy tận hưởng ngày nghỉ!";
                    analysis.reasoning = "Ngày nghỉ này được chọn để bạn có thời gian thư giãn và tái tạo năng lượng.";
            }
            return analysis;
        }

        /**
         * Tính ngày nghỉ dựa trên số chủ đạo.
         * Logic: Lấy ngày (của tháng sau) bằng số chủ đạo.
         * @param {string} dob - Ngày sinh "YYYY-MM-DD".
         * @returns {Date} - Đối tượng Date của ngày nghỉ.
         */
        function calculateVacationDate(dob) {
            const lifePath = calculateLifePath(dob); // Sẽ là 1-9, 11, hoặc 22
            
            // Ngày nghỉ trong tháng sẽ là số chủ đạo (ví dụ: lifePath 8 -> ngày 8)
            // lifePath 11 -> ngày 11, lifePath 22 -> ngày 22
            const vacationDayOfMonth = lifePath;

            const today = new Date();
            // Đặt ngày nghỉ vào tháng sau
            const vacationDate = new Date(today.getFullYear(), today.getMonth() + 1, vacationDayOfMonth);
            
            return vacationDate;
        }

        // --- Logic Điều Hướng Trang (View Logic) ---

        const formView = document.getElementById('formView');
        const countdownView = document.getElementById('countdownView');
        const submittedView = document.getElementById('submittedView');

        function showView(view) {
            formView.style.display = 'none';
            countdownView.style.display = 'none';
            submittedView.style.display = 'none';
            view.style.display = 'block';
        }

        /**
         * Hiển thị trang đếm ngược.
         * @param {string} dateString - Ngày nghỉ dạng "YYYY-MM-DD".
         * @param {string} name - Tên người dùng.
         */
        function showCountdownView(dateString, name) {
            document.getElementById('countdownName').textContent = name;
            document.getElementById('thankYouName').textContent = name; // [THÊM MỚI] Cập nhật tên trong thư cảm ơn
            
            // SỬA LỖI: Phân tích chuỗi YYYY-MM-DD thành ngày cục bộ (local)
            // Tránh new Date('YYYY-MM-DD') vì nó hiểu là UTC
            const [year, month, day] = dateString.split('-').map(Number);
            const vacationDate = new Date(year, month - 1, day); 

            const displayDate = vacationDate.toLocaleDateString('vi-VN', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
            document.getElementById('vacationDateDisplay').textContent = displayDate;
            
            showView(countdownView);

            // Xử lý Modal (Thêm mới)
            const urlParams = new URLSearchParams(window.location.search);
            const lifePath = parseInt(urlParams.get('lp')); // Lấy số chủ đạo từ URL
            
            if (lifePath) {
                const analysis = getNumerologyAnalysis(lifePath);
                document.getElementById('lifePathNumberDisplay').textContent = lifePath;
                document.getElementById('personalityAnalysis').textContent = analysis.personality;
                document.getElementById('dateReasoning').textContent = analysis.reasoning;
            }

            // Bắt đầu đếm ngược
            startCountdown(dateString);
        }

        /**
         * Hiển thị trang "Đã đăng ký".
         * @param {object} storedData - Dữ liệu từ localStorage.
         */
        function showSubmittedView(storedData) {
            document.getElementById('submittedName').textContent = storedData.name;
            showView(submittedView);

            document.getElementById('viewCountdownBtn').onclick = () => {
                // Điều hướng đến trang "subhtml" (trang countdown)
                // SỬA LỖI: Cần cung cấp đường dẫn đầy đủ (pathname), không chỉ query string
                // THÊM MỚI: Truyền cả lifePath (lp) qua URL
                window.location.href = window.location.pathname + `?date=${storedData.date}&name=${encodeURIComponent(storedData.name)}&lp=${storedData.lifePath}`;
            };
        }

        // --- Logic Đếm Ngược (Countdown Logic) ---

        let countdownInterval;
        function startCountdown(targetDate) {
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }

            // SỬA LỖI: Phân tích ngày target thành ngày cục bộ
            // const countDownDate = new Date(targetDate).getTime(); // Lỗi: Đây là UTC
            const [year, month, day] = targetDate.split('-').map(Number);
            const countDownDate = new Date(year, month - 1, day).getTime(); // Chuẩn: 00:00 giờ địa phương

            countdownInterval = setInterval(() => {
                const now = new Date().getTime();
                const distance = countDownDate - now;

                if (distance < 0) {
                    clearInterval(countdownInterval);
                    document.getElementById('countdownTimer').innerHTML = '<p class="text-2xl font-bold text-green-600">Chúc bạn có kỳ nghỉ vui vẻ!</p>';
                    return;
                }

                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                // Thêm số 0 đằng trước nếu nhỏ hơn 10
                const z = (n) => n < 10 ? '0' + n : n;

                document.getElementById('days').textContent = z(days);
                document.getElementById('hours').textContent = z(hours);
                document.getElementById('minutes').textContent = z(minutes);
                document.getElementById('seconds').textContent = z(seconds);

            }, 1000);
        }

        // --- Xử Lý Sự Kiện (Event Handlers) ---

        // Xử lý khi nộp form
        document.getElementById('vacationForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const name = document.getElementById('name').value;
            const dob = document.getElementById('dob').value;
            const position = document.getElementById('position').value;

            // Tính toán
            const vacationDate = calculateVacationDate(dob);
            
            // SỬA LỖI: Chuyển ngày cục bộ thành chuỗi YYYY-MM-DD mà không bị ảnh hưởng bởi múi giờ
            // const vacationDateISO = vacationDate.toISOString().split('T')[0]; // Lỗi: Bị ảnh hưởng bởi UTC
            const year = vacationDate.getFullYear();
            const month = (vacationDate.getMonth() + 1).toString().padStart(2, '0');
            const day = vacationDate.getDate().toString().padStart(2, '0');
            const vacationDateISO = `${year}-${month}-${day}`;
            
            // Tính toán số chủ đạo (Thêm mới)
            const lifePath = calculateLifePath(dob);

            // Lưu trữ (giả lập "ID máy")
            const storedData = {
                date: vacationDateISO,
                name: name,
                position: position,
                lifePath: lifePath // Thêm số chủ đạo vào bộ nhớ
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(storedData));

            // Chuyển hướng sang trang "subhtml" (countdown)
            // SỬA LỖI: Cần cung cấp đường dẫn đầy đủ (pathname), không chỉ query string
            // THÊM MỚI: Truyền cả lifePath (lp) qua URL
            window.location.href = window.location.pathname + `?date=${vacationDateISO}&name=${encodeURIComponent(name)}&lp=${lifePath}`;
        });

        // --- Logic Khởi Động (Initialization Logic) ---
        
        // Tự động điều hướng khi tải trang
        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const paramDate = urlParams.get('date');
            const paramName = urlParams.get('name');
            
            const storedData = JSON.parse(localStorage.getItem(STORAGE_KEY) || 'null');

            if (paramDate && paramName) {
                // Đây là trang "subhtml" (countdown)
                showCountdownView(paramDate, paramName);
            } else if (storedData) {
                // Người dùng đã đăng ký trước đó
                showSubmittedView(storedData);
            } else {
                // Người dùng mới, hiển thị form
                showView(formView);
            }
            
            // Xử lý sự kiện cho Modal (Thêm mới)
            const modal = document.getElementById('analysisModal');
            const showBtn = document.getElementById('showAnalysisBtn');
            const closeBtn = document.getElementById('closeModalBtn');
            const copyBtn = document.getElementById('copyLinkBtn'); // [THÊM MỚI]

            if (showBtn) {
                showBtn.onclick = () => {
                    modal.style.display = 'block';
                }
            }
            if (closeBtn) {
                closeBtn.onclick = () => {
                    modal.style.display = 'none';
                }
            }
            // [THÊM MỚI] Gán sự kiện cho nút copy
            if (copyBtn) {
                copyBtn.onclick = copyLinkToClipboard;
            }

            window.onclick = (event) => {
                if (event.target == modal) {
                    modal.style.display = 'none';
                }
            }
        });

    </script>
</body>
</html>
