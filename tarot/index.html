<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ứng Dụng Bóc Bài Tarot Nâng Cao</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Màu nền nhẹ nhàng */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        .app-container {
            background-color: #ffffff;
            border-radius: 1.5rem; /* Bo tròn các góc */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); /* Đổ bóng nhẹ nhàng */
            padding: 2rem;
            width: 100%;
            max-width: 700px; /* Chiều rộng tối đa cho không gian lịch sử */
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
        }
        .card-display-area {
            width: 100%;
            display: flex;
            justify-content: center;
            margin-bottom: 1rem;
        }
        .card {
            width: 150px; /* Kích thước lá bài */
            height: 250px;
            background-color: #2c3e50; /* Màu mặt sau lá bài */
            border-radius: 0.75rem; /* Bo tròn lá bài */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 1.25rem;
            font-weight: bold;
            text-align: center;
            padding: 10px;
            box-sizing: border-box;
            transition: transform 0.3s ease-in-out, background-color 0.3s ease-in-out;
            border: 3px solid #f39c12; /* Viền vàng cam nổi bật */
            overflow: hidden; /* Đảm bảo nội dung không tràn ra ngoài viền bo */
            position: relative; /* Cho phép định vị hình ảnh bên trong */
        }
        .card.drawn {
            background-color: #ecf0f1; /* Màu mặt trước lá bài */
            color: #2c3e50;
            border-color: #3498db; /* Viền xanh khi đã bóc */
        }
        .card-image {
            width: 100%;
            height: 100%;
            object-fit: contain; /* Đảm bảo hình ảnh vừa với khung */
            border-radius: 0.75rem;
        }
        .card-text-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 10px;
            box-sizing: border-box;
            font-size: 1.1rem;
            font-weight: bold;
            text-align: center;
            color: #2c3e50; /* Màu chữ trên lá bài đã bóc */
            word-break: break-word; /* Ngắt từ khi quá dài */
        }
        .current-spread-display {
            display: flex;
            gap: 1rem;
            justify-content: center;
            min-height: 160px; /* Đảm bảo không gian cho 3 lá bài đang bóc */
            width: 100%;
            margin-top: 1rem;
            flex-wrap: wrap; /* Cho phép xuống dòng trên màn hình nhỏ */
        }
        .current-spread-card {
            width: 100px;
            height: 160px;
            background-color: #ecf0f1; /* Sẽ được ghi đè bằng màu HSL */
            border-radius: 0.5rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #2c3e50;
            font-size: 0.75rem; /* Kích thước chữ nhỏ hơn */
            text-align: center;
            padding: 5px; /* Giảm padding */
            box-sizing: border-box;
            border: 2px solid #3498db;
            word-wrap: break-word; /* Đảm bảo ngắt từ */
            transition: transform 0.2s ease-in-out;
            line-height: 1.2; /* Tối ưu khoảng cách dòng */
        }
        .current-spread-card .card-name-text {
            padding: 5px; /* Thêm padding cho text */
        }

        .button-area {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }
        .button-area button {
            background-color: #3498db; /* Nút màu xanh */
            color: white;
            padding: 0.75rem 2rem;
            border-radius: 9999px; /* Nút hình bầu dục */
            font-size: 1.125rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease-in-out, transform 0.2s ease-in-out;
            border: none;
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4); /* Bóng nhẹ cho nút */
        }
        .button-area button:hover:not(:disabled) {
            background-color: #2980b9; /* Màu xanh đậm hơn khi hover */
            transform: translateY(-2px); /* Hiệu ứng nổi lên */
        }
        .button-area button:active:not(:disabled) {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(52, 152, 219, 0.4);
        }
        .button-area button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        .history-container {
            width: 100%;
            max-height: 350px; /* Chiều cao tối đa cho vùng lịch sử */
            overflow-y: auto; /* Cho phép cuộn khi quá nhiều lá bài */
            border: 1px solid #e0e0e0;
            border-radius: 0.75rem;
            padding: 1rem;
            background-color: #f9fafb;
        }
        .history-spread-group {
            border: 1px solid #dcdcdc;
            border-radius: 0.75rem;
            padding: 0.75rem;
            margin-bottom: 1.5rem;
            background-color: #ffffff;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        .history-spread-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            font-weight: bold;
            color: #4a4a4a;
            font-size: 0.95rem;
        }
        .history-spread-cards {
            display: flex;
            flex-wrap: wrap; /* Cho phép xuống dòng trên màn hình nhỏ */
            gap: 0.75rem; /* Khoảng cách giữa các lá bài lịch sử */
            justify-content: center;
        }
        .history-card-item {
            width: 80px; /* Kích thước nhỏ hơn cho lá bài lịch sử */
            height: 120px;
            background-color: #ecf0f1; /* Sẽ được ghi đè bằng màu HSL */
            border-radius: 0.5rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #2c3e50;
            font-size: 0.65rem; /* Kích thước chữ nhỏ hơn cho tên lá bài */
            text-align: center;
            padding: 5px; /* Giảm padding */
            box-sizing: border-box;
            border: 2px solid #3498db;
            word-wrap: break-word; /* Đảm bảo ngắt từ */
            transition: transform 0.2s ease-in-out;
            line-height: 1.2; /* Tối ưu khoảng cách dòng */
        }
        .history-card-item .card-name-text {
            padding: 3px; /* Thêm padding cho text */
        }

        .message-box {
            background-color: #e74c3c; /* Màu đỏ cho thông báo lỗi/hướng dẫn */
            color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            font-size: 1rem;
            text-align: center;
            opacity: 0;
            transform: translateY(-10px);
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            max-width: 80%;
        }
        .message-box.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* Responsive adjustments */
        @media (max-width: 640px) {
            .app-container {
                padding: 1.5rem;
                gap: 1rem;
            }
            .card {
                width: 120px;
                height: 200px;
                font-size: 1rem;
            }
            .current-spread-card {
                width: 80px;
                height: 130px;
                font-size: 0.65rem;
                padding: 3px;
            }
            .button-area button {
                padding: 0.6rem 1.2rem;
                font-size: 0.9rem;
            }
            .history-card-item {
                width: 60px;
                height: 90px;
                font-size: 0.55rem;
                padding: 2px;
            }
            .history-spread-cards {
                gap: 0.5rem;
            }
            .history-spread-header {
                font-size: 0.85rem;
                flex-direction: column; /* Xếp chồng ngày và bộ khi màn hình nhỏ */
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <h1 class="text-3xl font-extrabold text-gray-800 mb-4">Ứng Dụng Bóc Bài Tarot</h1>
        <div class="card-display-area">
            <div id="current-card" class="card">
                <img id="card-back-img" class="card-image" src="https://placehold.co/150x250/000000/FFFFFF?text=BÓC+BÀI" alt="Mặt sau lá bài Tarot">
            </div>
        </div>

        <div id="current-spread-display" class="current-spread-display">
            <!-- Các lá bài đang bóc trong lượt hiện tại sẽ hiển thị ở đây -->
        </div>

        <div class="button-area">
            <button id="draw-button">Bóc Bài</button>
            <button id="complete-spread-button" disabled>Hoàn Tất Lượt Bóc</button>
        </div>
        <div class="message-box" id="message-box"></div>
        <h2 class="text-xl font-bold text-gray-700 mt-4">Lịch Sử Các Lượt Bóc:</h2>
        <div id="history-container" class="history-container">
            <!-- Các lượt bóc đã hoàn tất sẽ được thêm vào đây -->
        </div>
    </div>

    <script>
        // Danh sách đầy đủ 78 lá bài Tarot (Major Arcana và Minor Arcana)
        const allTarotCards = [
            "0 - The Fool", "I - The Magician", "II - The High Priestess", "III - The Empress",
            "IV - The Emperor", "V - The Hierophant", "VI - The Lovers", "VII - The Chariot",
            "VIII - Strength", "IX - The Hermit", "X - Wheel of Fortune", "XI - Justice",
            "XII - The Hanged Man", "XIII - Death", "XIV - Temperance", "XV - The Devil",
            "XVI - The Tower", "XVII - The Star", "XVIII - The Moon", "XIX - The Sun",
            "XX - Judgement", "XXI - The World",

            "Ace of Wands", "Two of Wands", "Three of Wands", "Four of Wands", "Five of Wands",
            "Six of Wands", "Seven of Wands", "Eight of Wands", "Nine of Wands", "Ten of Wands",
            "Page of Wands", "Knight of Wands", "Queen of Wands", "King of Wands",

            "Ace of Cups", "Two of Cups", "Three of Cups", "Four of Cups", "Five of Cups",
            "Six of Cups", "Seven of Cups", "Eight of Cups", "Nine of Cups", "Ten of Cups",
            "Page of Cups", "Knight of Cups", "Queen of Cups", "King of Cups",

            "Ace of Swords", "Two of Swords", "Three of Swords", "Four of Swords", "Five of Swords",
            "Six of Swords", "Seven of Swords", "Eight of Swords", "Nine of Swords", "Ten of Swords",
            "Page of Swords", "Knight of Swords", "Queen of Swords", "King of Swords",

            "Ace of Pentacles", "Two of Pentacles", "Three of Pentacles", "Four of Pentacles",
            "Five of Pentacles", "Six of Pentacles", "Seven of Pentacles", "Eight of Pentacles",
            "Nine of Pentacles", "Ten of Pentacles", "Page of Pentacles", "Knight of Pentacles",
            "Queen of Pentacles", "King of Pentacles"
        ];

        let currentDeck = []; // Bộ bài hiện tại để bóc
        let currentDrawnCards = []; // Các lá bài đã bóc trong lượt hiện tại (tối đa 3)
        let historySpreads = []; // Lịch sử các bộ 3 lá bài đã hoàn tất

        const currentCardElement = document.getElementById('current-card');
        const cardBackImg = document.getElementById('card-back-img');
        const drawButton = document.getElementById('draw-button');
        const completeSpreadButton = document.getElementById('complete-spread-button');
        const messageBox = document.getElementById('message-box');
        const currentSpreadDisplay = document.getElementById('current-spread-display');
        const historyContainer = document.getElementById('history-container');

        /**
         * Hàm tạo màu HSL ngẫu nhiên dựa trên tên lá bài.
         * @param {string} cardName - Tên lá bài.
         * @returns {string} Chuỗi màu HSL (ví dụ: 'hsl(120, 75%, 65%)').
         */
        function getCardColorHSL(cardName) {
            const seed = cardName.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
            const hue = (seed * 137.508) % 360; // Golden angle approximation for color distribution
            const saturation = 70 + (seed % 30); // Random saturation between 70-99
            const lightness = 60 + (seed % 20); // Random lightness between 60-79
            return `hsl(${hue}, ${saturation}%, ${lightness}%)`;
        }

        /**
         * Hàm hiển thị thông báo trong hộp thông báo.
         * @param {string} message - Nội dung thông báo.
         * @param {string} type - Loại thông báo ('success', 'error', 'info').
         */
        function showMessage(message, type = 'info') {
            messageBox.textContent = message;
            messageBox.className = 'message-box show'; // Reset class
            if (type === 'error') {
                messageBox.classList.add('bg-red-500');
            } else if (type === 'success') {
                messageBox.classList.add('bg-green-500');
            } else {
                messageBox.classList.add('bg-blue-500');
            }
            setTimeout(() => {
                messageBox.classList.remove('show');
            }, 3000); // Ẩn sau 3 giây
        }

        /**
         * Hàm xáo trộn bộ bài.
         * Tạo một bản sao ngẫu nhiên của bộ bài gốc (tất cả 78 lá).
         */
        function shuffleDeck() {
            currentDeck = [...allTarotCards]; // Bắt đầu với một bản sao đầy đủ của bộ bài gốc
            for (let i = currentDeck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [currentDeck[i], currentDeck[j]] = [currentDeck[j], currentDeck[i]]; // Hoán đổi vị trí
            }
            showMessage("Bộ bài đã được xáo trộn!", "success");
        }

        /**
         * Hàm cập nhật hiển thị của lá bài hiện tại (lá lớn nhất).
         * @param {string} cardName - Tên của lá bài được hiển thị.
         */
        function updateCurrentCardDisplay(cardName) {
            currentCardElement.classList.add('drawn');
            const cardColor = getCardColorHSL(cardName);

            // Xóa hình ảnh mặt sau nếu có
            if (cardBackImg) {
                cardBackImg.style.display = 'none'; // Ẩn mặt sau
            }

            // Đặt màu nền cho lá bài chính
            currentCardElement.style.backgroundColor = cardColor;

            // Thêm lớp phủ văn bản để hiển thị tên lá bài rõ ràng hơn
            let textOverlay = currentCardElement.querySelector('.card-text-overlay');
            if (!textOverlay) {
                textOverlay = document.createElement('div');
                textOverlay.classList.add('card-text-overlay');
                currentCardElement.appendChild(textOverlay);
            }
            textOverlay.textContent = cardName;
        }

        /**
         * Hàm cập nhật hiển thị của các lá bài đang bóc trong lượt hiện tại (3 lá nhỏ phía dưới).
         */
        function updateCurrentSpreadDisplay() {
            currentSpreadDisplay.innerHTML = ''; // Xóa nội dung cũ
            currentDrawnCards.forEach(cardName => {
                const cardDiv = document.createElement('div');
                cardDiv.classList.add('current-spread-card');
                cardDiv.style.backgroundColor = getCardColorHSL(cardName); // Đặt màu nền cho lá bài nhỏ

                const cardNameSpan = document.createElement('span');
                cardNameSpan.classList.add('card-name-text');
                cardNameSpan.textContent = cardName; // Hiển thị đầy đủ tên lá bài
                cardDiv.appendChild(cardNameSpan);
                currentSpreadDisplay.appendChild(cardDiv);
            });
        }

        /**
         * Hàm cập nhật hiển thị của toàn bộ lịch sử các lượt bóc.
         */
        function updateHistoryDisplay() {
            historyContainer.innerHTML = ''; // Xóa tất cả lịch sử cũ để vẽ lại
            // Duyệt ngược để hiển thị bộ mới nhất lên trên
            historySpreads.slice().reverse().forEach((spread, index) => {
                const spreadGroupDiv = document.createElement('div');
                spreadGroupDiv.classList.add('history-spread-group');

                const headerDiv = document.createElement('div');
                headerDiv.classList.add('history-spread-header');
                headerDiv.innerHTML = `
                    <span>Bộ ${historySpreads.length - index}</span>
                    <span>${spread.timestamp}</span>
                `;
                spreadGroupDiv.appendChild(headerDiv);

                const cardsDiv = document.createElement('div');
                cardsDiv.classList.add('history-spread-cards');

                spread.cards.forEach(cardName => {
                    const cardItemDiv = document.createElement('div');
                    cardItemDiv.classList.add('history-card-item');
                    cardItemDiv.style.backgroundColor = getCardColorHSL(cardName); // Đặt màu nền cho lá lịch sử

                    const cardNameSpan = document.createElement('span');
                    cardNameSpan.classList.add('card-name-text');
                    cardNameSpan.textContent = cardName; // Hiển thị đầy đủ tên lá bài
                    cardItemDiv.appendChild(cardNameSpan);
                    cardsDiv.appendChild(cardItemDiv);
                });
                spreadGroupDiv.appendChild(cardsDiv);
                historyContainer.appendChild(spreadGroupDiv); // Thêm vào cuối để duy trì thứ tự đảo ngược
            });
            historyContainer.scrollTop = 0; // Cuộn lên đầu để thấy bộ mới nhất
        }

        /**
         * Hàm để bóc một lá bài.
         */
        function drawCard() {
            if (currentDrawnCards.length >= 3) {
                showMessage("Bạn đã bóc đủ 3 lá trong lượt này. Vui lòng nhấn 'Hoàn Tất Lượt Bóc'.", "info");
                return;
            }

            if (currentDeck.length === 0) {
                showMessage("Bộ bài trống! Đang xáo trộn lại...", "error");
                shuffleDeck(); // Xáo bài lại nếu hết bài
            }

            // Chọn một lá bài ngẫu nhiên từ bộ bài hiện tại
            const randomIndex = Math.floor(Math.random() * currentDeck.length);
            const drawnCard = currentDeck.splice(randomIndex, 1)[0]; // Bóc lá bài và loại bỏ khỏi bộ bài
            currentDrawnCards.push(drawnCard); // Thêm vào danh sách lá đang bóc trong lượt

            updateCurrentCardDisplay(drawnCard); // Hiển thị lá bài lớn
            updateCurrentSpreadDisplay(); // Cập nhật hàng 3 lá đang bóc

            if (currentDrawnCards.length === 3) {
                drawButton.disabled = true; // Vô hiệu hóa nút bóc bài
                completeSpreadButton.disabled = false; // Kích hoạt nút hoàn tất
                showMessage("Bạn đã bóc đủ 3 lá! Nhấn 'Hoàn Tất Lượt Bóc' để lưu và bắt đầu lượt mới.", "success");
            } else {
                drawButton.textContent = `Bóc Bài (Lá ${currentDrawnCards.length + 1} / 3)`;
            }
        }

        /**
         * Hàm hoàn tất lượt bóc bài hiện tại và lưu vào lịch sử.
         */
        function completeSpread() {
            if (currentDrawnCards.length === 3) {
                const timestamp = new Date().toLocaleString('vi-VN', {
                    year: 'numeric', month: '2-digit', day: '2-digit',
                    hour: '2-digit', minute: '2-digit', second: '2-digit',
                    hour12: false
                });
                historySpreads.push({
                    timestamp: timestamp,
                    cards: [...currentDrawnCards] // Tạo bản sao để tránh thay đổi sau này
                });

                currentDrawnCards = []; // Xóa các lá bài trong lượt hiện tại
                currentSpreadDisplay.innerHTML = ''; // Xóa hiển thị lượt hiện tại

                updateHistoryDisplay(); // Cập nhật lịch sử tổng
                resetGameVisuals(); // Đặt lại giao diện chính và nút bấm
                shuffleDeck(); // Xáo bài cho lượt mới

                showMessage("Lượt bóc đã được lưu vào lịch sử!", "success");
            } else {
                showMessage("Bạn chưa bóc đủ 3 lá để hoàn tất lượt.", "error");
            }
        }

        /**
         * Hàm đặt lại giao diện của trò chơi (không ảnh hưởng lịch sử).
         */
        function resetGameVisuals() {
            // Đặt lại hiển thị lá bài hiện tại về mặt sau
            currentCardElement.classList.remove('drawn');
            currentCardElement.style.backgroundColor = ''; // Xóa màu nền đã đặt
            if (cardBackImg) {
                cardBackImg.style.display = 'block';
            }
            let textOverlay = currentCardElement.querySelector('.card-text-overlay');
            if (textOverlay) {
                textOverlay.remove();
            }

            drawButton.textContent = "Bóc Bài";
            drawButton.disabled = false;
            completeSpreadButton.disabled = true;
        }

        // Khởi tạo trò chơi khi tải trang
        document.addEventListener('DOMContentLoaded', () => {
            drawButton.addEventListener('click', drawCard);
            completeSpreadButton.addEventListener('click', completeSpread);
            shuffleDeck(); // Xáo bài lần đầu khi khởi động ứng dụng
            resetGameVisuals(); // Đảm bảo giao diện ban đầu đúng
        });
    </script>
</body>
</html>
