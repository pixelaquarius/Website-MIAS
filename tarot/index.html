<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ứng Dụng Bóc Bài Tarot – An toàn với Vercel</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#f0f4f8; margin:0; padding:20px; display:flex; min-height:100vh; align-items:center; justify-content:center; }
    .app-container { background:#fff; border-radius:1.5rem; box-shadow:0 10px 25px rgba(0,0,0,.1); padding:2rem; width:100%; max-width:700px; display:flex; flex-direction:column; gap:1.5rem; align-items:center; }
    .card { width:150px; height:250px; background:#2c3e50; border-radius:.75rem; box-shadow:0 4px 10px rgba(0,0,0,.2); display:flex; align-items:center; justify-content:center; color:#fff; font-weight:700; border:3px solid #f39c12; position:relative; overflow:hidden; transition:.3s; }
    .card.drawn { background:#ecf0f1; color:#2c3e50; border-color:#3498db; }
    .card-image { width:100%; height:100%; object-fit:contain; border-radius:.75rem; }
    .card-text-overlay { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; padding:10px; text-align:center; color:#2c3e50; font-weight:800; }
    .current-spread-display { display:flex; gap:1rem; justify-content:center; flex-wrap:wrap; min-height:180px; width:100%; }
    .current-spread-card { width:calc(33.33% - .67rem); max-width:100px; height:160px; background:#ecf0f1; border-radius:.5rem; border:2px solid #3498db; display:flex; align-items:center; justify-content:center; text-align:center; font-size:.75rem; padding:5px; line-height:1.2; }
    @media (max-width:640px){ .current-spread-card{ width:calc(50% - .5rem); } }
    .button-area { display:flex; gap:1rem; }
    .button-area button { background:#3498db; color:#fff; padding:.75rem 2rem; border:none; border-radius:9999px; font-weight:800; box-shadow:0 5px 15px rgba(52,152,219,.4); cursor:pointer; }
    .button-area button:disabled { background:#ccc; cursor:not-allowed; box-shadow:none; }
    .ai-reading-area { width:100%; background:#f5f5f5; border-radius:.75rem; padding:1.25rem; box-shadow:0 5px 15px rgba(0,0,0,.05); }
    .ai-reading-actions { display:flex; flex-wrap:wrap; gap:.75rem; justify-content:center; margin-top:.75rem; }
    .ai-reading-actions button { background:#f39c12; color:#fff; padding:.6rem 1.2rem; border:none; border-radius:9999px; font-weight:700; }
    .ai-reading-actions button.bg-blue-500 { background:#3b82f6; }
    .ai-reading-actions button.bg-red-500 { background:#ef4444; }
    .ai-response-sections { display:flex; flex-direction:column; gap:1rem; margin-top:1rem; }
    .ai-card-interpretation, .ai-overall-interpretation, .ai-suggestions { background:#e8f0fe; border:1px solid #a7c5ed; border-radius:.5rem; padding:.8rem; font-size:.95rem; }
    .history-container { width:100%; max-height:350px; overflow:auto; background:#f9fafb; border:1px solid #e0e0e0; border-radius:.75rem; padding:1rem; }
    .history-spread-group { background:#fff; border:1px solid #dcdcdc; border-radius:.75rem; padding:.75rem; margin-bottom:1rem; box-shadow:0 2px 8px rgba(0,0,0,.05); }
    .history-spread-cards { display:flex; flex-wrap:wrap; gap:.75rem; justify-content:center; }
    .history-card-item { width:80px; height:120px; background:#ecf0f1; border-radius:.5rem; border:2px solid #3498db; display:flex; align-items:center; justify-content:center; font-size:.65rem; text-align:center; padding:5px; line-height:1.2; }
    .message-box { background:#e74c3c; color:#fff; padding:1rem; border-radius:.5rem; opacity:0; transform:translateY(-8px); transition:.3s; text-align:center; }
    .message-box.show { opacity:1; transform:translateY(0); }
  </style>
</head>
<body>
  <div class="app-container">
    <h1 class="text-3xl font-extrabold text-gray-800">Ứng Dụng Bóc Bài Tarot</h1>

    <!-- Chọn số lá -->
    <div class="w-full bg-gray-50 p-4 rounded-lg shadow-sm">
      <h3 class="font-bold text-gray-700 mb-2">Chọn số lá bài:</h3>
      <div class="flex flex-wrap gap-x-4 gap-y-2 justify-center">
        <label><input type="radio" name="spread-type" value="1" checked> 1 Lá Tổng Quan</label>
        <label><input type="radio" name="spread-type" value="3"> 3 Lá Nội Dung Sắp Tới</label>
        <label><input type="radio" name="spread-type" value="5"> 5 Lá Cả Cuộc Đời</label>
      </div>
    </div>

    <!-- Lá lớn -->
    <div class="card-display-area">
      <div id="current-card" class="card">
        <img id="card-back-img" class="card-image" src="https://placehold.co/150x250/000000/FFFFFF?text=B%C3%93C+B%C3%80I" alt="Mặt sau lá bài">
      </div>
    </div>

    <!-- 3/5 lá đang bóc -->
    <div id="current-spread-display" class="current-spread-display"></div>

    <!-- Nút -->
    <div class="button-area">
      <button id="draw-button">Bóc Bài</button>
      <button id="complete-spread-button" disabled>Hoàn Tất Lượt Bóc</button>
    </div>

    <div class="message-box" id="message-box"></div>

    <!-- Đọc bài AI -->
    <div class="ai-reading-area">
      <h3 class="text-lg font-bold text-gray-700">Đọc Bài Bằng AI</h3>

      <div class="mb-3">
        <div class="flex gap-4 justify-center">
          <label><input type="radio" name="question-type" value="manual" checked> Tự nhập câu hỏi</label>
          <label><input type="radio" name="question-type" value="guided"> Chọn theo hướng dẫn</label>
        </div>
      </div>

      <textarea id="question-input" class="w-full p-2 border rounded-lg" placeholder="Nhập câu hỏi (vd: Sự nghiệp 3 tháng tới?)"></textarea>

      <div id="guided-question-options" class="hidden mt-2">
        <select id="topic-select" class="w-full p-2 border rounded-lg mb-2">
          <option value="">-- Chọn Chủ Đề --</option>
          <option value="Tình yêu và mối quan hệ">Tình yêu và mối quan hệ</option>
          <option value="Sự nghiệp và công việc">Sự nghiệp và công việc</option>
          <option value="Tài chính và tiền bạc">Tài chính và tiền bạc</option>
          <option value="Sức khỏe và tinh thần">Sức khỏe và tinh thần</option>
          <option value="Phát triển cá nhân">Phát triển cá nhân</option>
        </select>
        <select id="timeframe-select" class="w-full p-2 border rounded-lg mb-2">
          <option value="">-- Chọn Thời Gian --</option>
          <option value="hiện tại">Hiện tại</option>
          <option value="trong 3 tháng tới">3 tháng tới</option>
          <option value="trong 6 tháng tới">6 tháng tới</option>
          <option value="trong 1 năm tới">1 năm tới</option>
        </select>
        <input id="additional-question" class="w-full p-2 border rounded-lg" placeholder="Câu hỏi bổ sung (nếu có)"/>
      </div>

      <div class="ai-reading-actions">
        <button id="get-ai-reading-button" disabled>Nhận Giải Thích Từ AI</button>
        <button id="coi-sau-them-btn" disabled class="bg-blue-500">Coi Sâu Thêm</button>
        <button id="boc-bai-moi-btn" disabled class="bg-red-500">Bóc Bài Mới</button>
      </div>

      <div id="ai-response-display" class="ai-response-sections">
        <div id="loading-ai-response" class="hidden italic text-center text-gray-600">Đang phân tích...</div>

        <div id="ai-card-interpretations-container" class="hidden">
          <h4 class="font-bold text-gray-700">Giải thích từng lá:</h4>
          <div id="ai-card-interpretations-row" class="flex gap-2 flex-wrap"></div>
        </div>

        <div id="ai-overall-interpretation" class="ai-overall-interpretation hidden">
          <h4 class="font-bold text-gray-700 mb-1">Tổng Quan:</h4>
          <p id="overall-text"></p>
        </div>

        <div id="ai-suggestions" class="ai-suggestions hidden">
          <h4 class="font-bold text-gray-700 mb-1">Gợi Ý / Bước Tiếp:</h4>
          <p id="suggestions-text"></p>
        </div>
      </div>
    </div>

    <h2 class="text-xl font-bold text-gray-700">Lịch Sử Các Lượt Bóc</h2>
    <div id="history-container" class="history-container"></div>
  </div>

  <script>
    // ====== Bộ bài 78 lá ======
    const allTarotCards = [
      "0 - The Fool","I - The Magician","II - The High Priestess","III - The Empress",
      "IV - The Emperor","V - The Hierophant","VI - The Lovers","VII - The Chariot",
      "VIII - Strength","IX - The Hermit","X - Wheel of Fortune","XI - Justice",
      "XII - The Hanged Man","XIII - Death","XIV - Temperance","XV - The Devil",
      "XVI - The Tower","XVII - The Star","XVIII - The Moon","XIX - The Sun",
      "XX - Judgement","XXI - The World",
      "Ace of Wands","Two of Wands","Three of Wands","Four of Wands","Five of Wands",
      "Six of Wands","Seven of Wands","Eight of Wands","Nine of Wands","Ten of Wands",
      "Page of Wands","Knight of Wands","Queen of Wands","King of Wands",
      "Ace of Cups","Two of Cups","Three of Cups","Four of Cups","Five of Cups",
      "Six of Cups","Seven of Cups","Eight of Cups","Nine of Cups","Ten of Cups",
      "Page of Cups","Knight of Cups","Queen of Cups","King of Cups",
      "Ace of Swords","Two of Swords","Three of Swords","Four of Swords","Five of Swords",
      "Six of Swords","Seven of Swords","Eight of Swords","Nine of Swords","Ten of Swords",
      "Page of Swords","Knight of Swords","Queen of Swords","King of Swords",
      "Ace of Pentacles","Two of Pentacles","Three of Pentacles","Four of Pentacles",
      "Five of Pentacles","Six of Pentacles","Seven of Pentacles","Eight of Pentacles",
      "Nine of Pentacles","Ten of Pentacles","Page of Pentacles","Knight of Pentacles",
      "Queen of Pentacles","King of Pentacles"
    ];

    // ====== State & DOM ======
    let currentDeck = [];
    let currentDrawnCards = [];
    let historySpreads = [];
    let numCardsToDraw = 1;

    const currentCardElement = document.getElementById('current-card');
    const cardBackImg = document.getElementById('card-back-img');
    const drawButton = document.getElementById('draw-button');
    const completeSpreadButton = document.getElementById('complete-spread-button');
    const messageBox = document.getElementById('message-box');
    const currentSpreadDisplay = document.getElementById('current-spread-display');
    const historyContainer = document.getElementById('history-container');

    const spreadTypeRadios = document.querySelectorAll('input[name="spread-type"]');
    const questionTypeRadios = document.querySelectorAll('input[name="question-type"]');
    const questionInput = document.getElementById('question-input');
    const guidedQuestionOptions = document.getElementById('guided-question-options');
    const topicSelect = document.getElementById('topic-select');
    const timeframeSelect = document.getElementById('timeframe-select');
    const additionalQuestionInput = document.getElementById('additional-question');

    const getAiReadingButton = document.getElementById('get-ai-reading-button');
    const coiSauThemBtn = document.getElementById('coi-sau-them-btn');
    const bocBaiMoiBtn = document.getElementById('boc-bai-moi-btn');

    const aiCardInterpretationsContainer = document.getElementById('ai-card-interpretations-container');
    const aiCardInterpretationsRow = document.getElementById('ai-card-interpretations-row');
    const aiOverallInterpretation = document.getElementById('ai-overall-interpretation');
    const overallText = document.getElementById('overall-text');
    const aiSuggestions = document.getElementById('ai-suggestions');
    const suggestionsText = document.getElementById('suggestions-text');
    const loadingAiResponse = document.getElementById('loading-ai-response');

    // ====== Helpers ======
    function getCardColorHSL(name){
      const seed = [...name].reduce((a,c)=>a+c.charCodeAt(0),0);
      const hue = (seed*137.508)%360, sat=70+(seed%30), light=60+(seed%20);
      return `hsl(${hue}, ${sat}%, ${light}%)`;
    }
    function showMessage(msg,type='info'){
      messageBox.textContent = msg;
      messageBox.className = 'message-box show';
      messageBox.style.backgroundColor = type==='error' ? '#ef4444' : (type==='success' ? '#10b981' : '#3b82f6');
      setTimeout(()=>messageBox.classList.remove('show'), 2500);
    }
    function shuffleDeck(){
      currentDeck = [...allTarotCards];
      for (let i=currentDeck.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [currentDeck[i],currentDeck[j]] = [currentDeck[j],currentDeck[i]];
      }
      showMessage('Bộ bài đã được xáo!', 'success');
    }
    function updateCurrentCardDisplay(cardName){
      currentCardElement.classList.add('drawn');
      currentCardElement.style.backgroundColor = getCardColorHSL(cardName);
      if (cardBackImg) cardBackImg.style.display='none';
      let overlay = currentCardElement.querySelector('.card-text-overlay');
      if (!overlay) {
        overlay = document.createElement('div');
        overlay.className = 'card-text-overlay';
        currentCardElement.appendChild(overlay);
      }
      overlay.textContent = cardName;
    }
    function updateCurrentSpreadDisplay(){
      currentSpreadDisplay.innerHTML='';
      currentDrawnCards.forEach(name=>{
        const d=document.createElement('div');
        d.className='current-spread-card';
        d.style.backgroundColor=getCardColorHSL(name);
        d.innerHTML=`<span class="card-name-text">${name}</span>`;
        currentSpreadDisplay.appendChild(d);
      });
    }
    function updateHistoryDisplay(){
      historyContainer.innerHTML='';
      historySpreads.slice().reverse().forEach((spread,idx)=>{
        const wrap=document.createElement('div'); wrap.className='history-spread-group';
        wrap.innerHTML=`<div class="flex justify-between text-sm font-bold text-gray-600 mb-2">
            <span>Bộ ${historySpreads.length-idx}</span><span>${spread.timestamp}</span></div>`;
        const cardsDiv=document.createElement('div'); cardsDiv.className='history-spread-cards';
        spread.cards.forEach(n=>{
          const c=document.createElement('div'); c.className='history-card-item';
          c.style.backgroundColor=getCardColorHSL(n); c.innerHTML=`<span class="card-name-text">${n}</span>`;
          cardsDiv.appendChild(c);
        });
        wrap.appendChild(cardsDiv); historyContainer.appendChild(wrap);
      });
      historyContainer.scrollTop=0;
    }
    function resetGameVisuals(){
      currentCardElement.classList.remove('drawn');
      currentCardElement.style.backgroundColor='';
      if (cardBackImg) cardBackImg.style.display='block';
      const ov=currentCardElement.querySelector('.card-text-overlay'); if (ov) ov.remove();
      drawButton.textContent='Bóc Bài';
      drawButton.disabled=false;
      completeSpreadButton.disabled=true;
      getAiReadingButton.disabled=true;
      coiSauThemBtn.disabled=true;
      bocBaiMoiBtn.disabled=true;
      clearAiResponseDisplay();
      questionInput.value='';
      topicSelect.value=''; timeframeSelect.value=''; additionalQuestionInput.value='';
    }
    function clearAiResponseDisplay(){
      aiCardInterpretationsRow.innerHTML='';
      aiCardInterpretationsContainer.classList.add('hidden');
      aiOverallInterpretation.classList.add('hidden'); overallText.textContent='';
      aiSuggestions.classList.add('hidden'); suggestionsText.textContent='';
      loadingAiResponse.classList.add('hidden');
    }

    // ====== Game actions ======
    function drawCard(){
      if (currentDrawnCards.length >= numCardsToDraw){
        showMessage(`Bạn đã bóc đủ ${numCardsToDraw} lá.`, 'info'); return;
      }
      if (!currentDeck.length) shuffleDeck();
      const idx = Math.floor(Math.random()*currentDeck.length);
      const card = currentDeck.splice(idx,1)[0];
      currentDrawnCards.push(card);
      updateCurrentCardDisplay(card);
      updateCurrentSpreadDisplay();
      if (currentDrawnCards.length === numCardsToDraw){
        drawButton.disabled=true; completeSpreadButton.disabled=false; getAiReadingButton.disabled=false;
        showMessage(`Đủ ${numCardsToDraw} lá. Bạn có thể 'Nhận Giải Thích Từ AI' hoặc 'Hoàn tất'.`, 'success');
      } else {
        drawButton.textContent = `Bóc Bài (Lá ${currentDrawnCards.length+1}/${numCardsToDraw})`;
      }
    }
    function completeSpread(){
      if (currentDrawnCards.length !== numCardsToDraw){
        // Trường hợp bấm "Bóc Bài Mới" sau khi đã lưu
        if (currentDrawnCards.length===0 && historySpreads.length>0){
          resetGameVisuals(); shuffleDeck(); showMessage('Bắt đầu lượt mới.', 'info'); return;
        }
        showMessage(`Chưa đủ ${numCardsToDraw} lá.`, 'error'); return;
      }
      const ts = new Date().toLocaleString('vi-VN',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false});
      historySpreads.push({ timestamp: ts, cards:[...currentDrawnCards], spreadType:numCardsToDraw });
      currentDrawnCards=[]; currentSpreadDisplay.innerHTML='';
      updateHistoryDisplay(); resetGameVisuals(); shuffleDeck();
      showMessage('Đã lưu vào lịch sử.', 'success');
    }

    // ====== Question builder ======
    function getUserQuestion(){
      const type = document.querySelector('input[name="question-type"]:checked').value;
      if (type==='manual') return (questionInput.value||'').trim();
      const parts=[];
      if (topicSelect.value) parts.push(`Chủ đề: ${topicSelect.value}.`);
      if (timeframeSelect.value) parts.push(`Thời gian muốn biết: ${timeframeSelect.value}.`);
      if (additionalQuestionInput.value.trim()) parts.push(`Câu hỏi cụ thể: ${additionalQuestionInput.value.trim()}.`);
      return parts.join(' ');
    }

    // ====== AI call via Vercel route ======
    async function getAiReading(){
      if (currentDrawnCards.length !== numCardsToDraw){ showMessage(`Hãy bóc đủ ${numCardsToDraw} lá trước.`, 'error'); return; }
      const userQuestion = getUserQuestion();
      if (!userQuestion){ showMessage('Vui lòng nhập/chọn câu hỏi.', 'error'); return; }

      clearAiResponseDisplay();
      loadingAiResponse.classList.remove('hidden');
      getAiReadingButton.disabled = true; coiSauThemBtn.disabled = true; bocBaiMoiBtn.disabled = true;

      try{
        const res = await fetch('/api/ai-reading', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ cards: currentDrawnCards, question: userQuestion })
        });
        const data = await res.json();
        if (!res.ok){ throw new Error(data?.error || 'AI error'); }

        // Render
        aiCardInterpretationsRow.innerHTML='';
        if (Array.isArray(data.cardInterpretations)){
          data.cardInterpretations.forEach(item=>{
            const div=document.createElement('div');
            div.className='ai-card-interpretation';
            div.innerHTML = `<strong>${item.cardName}:</strong> <div>${item.interpretation}</div>`;
            aiCardInterpretationsRow.appendChild(div);
          });
          aiCardInterpretationsContainer.classList.remove('hidden');
        }
        overallText.textContent = data.overallInterpretation || '';
        aiOverallInterpretation.classList.remove('hidden');
        suggestionsText.textContent = data.nextStepsSuggestion || '';
        aiSuggestions.classList.remove('hidden');

        coiSauThemBtn.disabled = false;
        bocBaiMoiBtn.disabled = false;
        showMessage('AI đã phản hồi.', 'success');
      } catch(err){
        showMessage(`Lỗi AI: ${err.message}`, 'error');
      } finally{
        loadingAiResponse.classList.add('hidden');
      }
    }

    // ====== Events ======
    document.addEventListener('DOMContentLoaded', ()=>{
      drawButton.addEventListener('click', drawCard);
      completeSpreadButton.addEventListener('click', completeSpread);
      getAiReadingButton.addEventListener('click', getAiReading);
      spreadTypeRadios.forEach(r=>r.addEventListener('change', e=>{
        numCardsToDraw = parseInt(e.target.value,10);
        currentDrawnCards=[]; currentSpreadDisplay.innerHTML='';
        resetGameVisuals(); shuffleDeck();
        showMessage(`Bạn đã chọn bóc ${numCardsToDraw} lá.`, 'info');
      }));
      questionTypeRadios.forEach(r=>r.addEventListener('change', e=>{
        const guided = e.target.value==='guided';
        if (guided){ guidedQuestionOptions.classList.remove('hidden'); questionInput.classList.add('hidden'); }
        else { guidedQuestionOptions.classList.add('hidden'); questionInput.classList.remove('hidden'); }
      }));

      coiSauThemBtn.addEventListener('click', ()=>{
        getAiReadingButton.disabled=false; coiSauThemBtn.disabled=true; bocBaiMoiBtn.disabled=true;
        clearAiResponseDisplay(); showMessage('Hỏi tiếp với bộ hiện tại.', 'info');
      });
      bocBaiMoiBtn.addEventListener('click', completeSpread);

      shuffleDeck(); resetGameVisuals();
    });
  </script>
</body>
</html>
