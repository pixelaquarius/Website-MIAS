<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ứng Dụng Bóc Bài Tarot Nâng Cao Với Tùy Chọn</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Màu nền nhẹ nhàng */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        .app-container {
            background-color: #ffffff;
            border-radius: 1.5rem; /* Bo tròn các góc */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); /* Đổ bóng nhẹ nhàng */
            padding: 2rem;
            width: 100%;
            max-width: 700px; /* Chiều rộng tối đa cho không gian lịch sử */
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
        }
        .card-display-area {
            width: 100%;
            display: flex;
            justify-content: center;
            margin-bottom: 1rem;
        }
        .card {
            width: 150px; /* Kích thước lá bài */
            height: 250px;
            background-color: #2c3e50; /* Màu mặt sau lá bài */
            border-radius: 0.75rem; /* Bo tròn lá bài */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 1.25rem;
            font-weight: bold;
            text-align: center;
            padding: 10px;
            box-sizing: border-box;
            transition: transform 0.3s ease-in-out, background-color 0.3s ease-in-out;
            border: 3px solid #f39c12; /* Viền vàng cam nổi bật */
            overflow: hidden; /* Đảm bảo nội dung không tràn ra ngoài viền bo */
            position: relative; /* Cho phép định vị hình ảnh bên trong */
        }
        .card.drawn {
            background-color: #ecf0f1; /* Màu mặt trước lá bài */
            color: #2c3e50;
            border-color: #3498db; /* Viền xanh khi đã bóc */
        }
        .card-image {
            width: 100%;
            height: 100%;
            object-fit: contain; /* Đảm bảo hình ảnh vừa với khung */
            border-radius: 0.75rem;
        }
        .card-text-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 10px;
            box-sizing: border-box;
            font-size: 1.1rem;
            font-weight: bold;
            text-align: center;
            color: #2c3e50; /* Màu chữ trên lá bài đã bóc */
            word-break: break-word; /* Ngắt từ khi quá dài */
        }
        .current-spread-display {
            display: flex;
            gap: 1rem;
            justify-content: center;
            align-items: flex-start; /* Căn trên cùng */
            min-height: 180px; /* Đảm bảo không gian cho 5 lá bài (2 hàng) */
            width: 100%;
            margin-top: 1rem;
            flex-wrap: wrap; /* Cho phép xuống dòng trên màn hình nhỏ */
        }
        .current-spread-card {
            width: calc(33.33% - 0.67rem); /* 3 cards per row, account for gap */
            max-width: 100px; /* Max width to keep them smaller */
            height: 160px;
            background-color: #ecf0f1; /* Will be overridden by HSL color */
            border-radius: 0.5rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #2c3e50;
            font-size: 0.75rem; /* Smaller font size */
            text-align: center;
            padding: 5px; /* Reduced padding */
            box-sizing: border-box;
            border: 2px solid #3498db;
            word-wrap: break-word; /* Ensure word wrapping */
            transition: transform 0.2s ease-in-out;
            line-height: 1.2; /* Optimize line height */
            flex-shrink: 0; /* Prevent shrinking */
        }
        @media (max-width: 640px) {
            .current-spread-card {
                width: calc(50% - 0.5rem); /* 2 cards per row on mobile */
                max-width: 100px;
            }
        }
        .current-spread-card .card-name-text {
            padding: 5px; /* Add padding for text */
        }

        .button-area {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }
        .button-area button {
            background-color: #3498db; /* Blue button */
            color: white;
            padding: 0.75rem 2rem;
            border-radius: 9999px; /* Pill shape */
            font-size: 1.125rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease-in-out, transform 0.2s ease-in-out;
            border: none;
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4); /* Soft shadow */
        }
        .button-area button:hover:not(:disabled) {
            background-color: #2980b9; /* Darker blue on hover */
            transform: translateY(-2px); /* Lift effect */
        }
        .button-area button:active:not(:disabled) {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(52, 152, 219, 0.4);
        }
        .button-area button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        .ai-reading-area {
            background-color: #f5f5f5;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-top: 1.5rem;
            width: 100%;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            min-height: 100px;
        }
        .ai-reading-area textarea {
            width: 100%;
            min-height: 80px;
            border: 1px solid #dcdcdc;
            border-radius: 0.5rem;
            padding: 0.75rem;
            font-size: 1rem;
            resize: vertical;
            margin-bottom: 1rem;
        }
        .ai-reading-area button {
            background-color: #f39c12; /* Orange button */
            color: white;
            padding: 0.6rem 1.5rem;
            border-radius: 9999px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease-in-out;
            border: none;
        }
        .ai-reading-area button:hover:not(:disabled) {
            background-color: #e67e22; /* Darker orange on hover */
        }
        .ai-reading-area button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        /* AI Response Sections */
        .ai-response-sections {
            margin-top: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            width: 100%;
        }
        .ai-response-cards-row {
            display: flex;
            gap: 0.75rem;
            justify-content: center;
            flex-wrap: wrap; /* Allow wrapping on small screens */
        }
        .ai-card-interpretation {
            flex: 1; /* Distribute space evenly */
            min-width: calc(33.33% - 0.5rem); /* 3 per row */
            background-color: #e8f0fe; /* Light blue background */
            border-radius: 0.5rem;
            border: 1px solid #a7c5ed;
            padding: 0.75rem;
            font-size: 0.9rem;
            line-height: 1.4;
            overflow-y: auto; /* Allow scrolling */
            max-height: 150px; /* Limit height */
        }
        @media (max-width: 640px) {
            .ai-card-interpretation {
                min-width: calc(50% - 0.375rem); /* 2 per row on mobile */
            }
        }
        .ai-card-interpretation h4 {
            font-weight: bold;
            margin-bottom: 0.5rem;
            color: #2c3e50;
        }
        .ai-overall-interpretation, .ai-suggestions {
            background-color: #e8f0fe;
            border-radius: 0.5rem;
            border: 1px solid #a7c5ed;
            padding: 1rem;
            font-size: 0.95rem;
            line-height: 1.5;
            overflow-y: auto; /* Allow scrolling */
            max-height: 180px; /* Limit height */
        }
        .ai-overall-interpretation h4, .ai-suggestions h4 {
            font-weight: bold;
            margin-bottom: 0.5rem;
            color: #2c3e50;
        }
        .ai-response.loading {
            text-align: center;
            font-style: italic;
            color: #555;
            padding: 1rem;
        }


        .history-container {
            width: 100%;
            max-height: 350px; /* Max height for history area */
            overflow-y: auto; /* Enable scrolling if too many cards */
            border: 1px solid #e0e0e0;
            border-radius: 0.75rem;
            padding: 1rem;
            background-color: #f9fafb;
        }
        .history-spread-group {
            border: 1px solid #dcdcdc;
            border-radius: 0.75rem;
            padding: 0.75rem;
            margin-bottom: 1.5rem;
            background-color: #ffffff;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        .history-spread-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            font-weight: bold;
            color: #4a4a4a;
            font-size: 0.95rem;
        }
        .history-spread-cards {
            display: flex;
            flex-wrap: wrap; /* Allow wrapping on small screens */
            gap: 0.75rem; /* Spacing between history cards */
            justify-content: center;
        }
        .history-card-item {
            width: calc(33.33% - 0.5rem); /* 3 cards per row */
            max-width: 80px; /* Max width for history cards */
            height: 120px;
            background-color: #ecf0f1; /* Will be overridden by HSL color */
            border-radius: 0.5rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #2c3e50;
            font-size: 0.65rem; /* Smaller font size for card name */
            text-align: center;
            padding: 5px; /* Reduced padding */
            box-sizing: border-box;
            border: 2px solid #3498db;
            word-wrap: break-word; /* Ensure word wrapping */
            transition: transform 0.2s ease-in-out;
            line-height: 1.2; /* Optimize line height */
            flex-shrink: 0;
        }
        @media (max-width: 640px) {
            .history-card-item {
                width: calc(50% - 0.375rem); /* 2 cards per row on mobile */
                max-width: 80px;
            }
            .history-spread-group {
                padding: 0.5rem;
            }
        }
        .history-card-item .card-name-text {
            padding: 3px; /* Add padding for text */
        }

        .message-box {
            background-color: #e74c3c; /* Red for error/info messages */
            color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            font-size: 1rem;
            text-align: center;
            opacity: 0;
            transform: translateY(-10px);
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            max-width: 80%;
        }
        .message-box.show {
            opacity: 1;
            transform: translateY(0);
        }

        .section-header {
            width: 100%;
            text-align: center;
            font-size: 1.1rem;
            font-weight: bold;
            color: #4a4a4a;
            margin-top: 0.5rem;
            margin-bottom: 0.75rem;
        }
        .radio-group label {
            margin-right: 1.5rem;
            font-weight: normal;
            cursor: pointer;
        }
        .radio-group input[type="radio"] {
            margin-right: 0.5rem;
            cursor: pointer;
        }

        .guided-question-options {
            display: none; /* Hidden by default */
            flex-direction: column;
            gap: 0.75rem;
            width: 100%;
        }
        .guided-question-options.active {
            display: flex;
        }
        .guided-question-options select,
        .guided-question-options input[type="text"] {
            width: 100%;
            padding: 0.6rem;
            border: 1px solid #dcdcdc;
            border-radius: 0.5rem;
            font-size: 0.95rem;
            background-color: white;
        }
        .ai-reading-area .input-group {
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <h1 class="text-3xl font-extrabold text-gray-800 mb-4">Ứng Dụng Bóc Bài Tarot</h1>

        <!-- Spread Options -->
        <div class="selection-area w-full bg-gray-50 p-4 rounded-lg shadow-sm">
            <h3 class="font-bold text-gray-700 mb-2">Chọn số lá bài:</h3>
            <div class="radio-group flex flex-wrap gap-x-4 gap-y-2 mb-4 justify-center">
                <label>
                    <input type="radio" name="spread-type" value="1" checked> 1 Lá Tổng Quan
                </label>
                <label>
                    <input type="radio" name="spread-type" value="3"> 3 Lá Nội Dung Sắp Tới
                </label>
                <label>
                    <input type="radio" name="spread-type" value="5"> 5 Lá Cả Cuộc Đời
                </label>
            </div>
        </div>

        <div class="card-display-area">
            <div id="current-card" class="card">
                <img id="card-back-img" class="card-image" src="https://placehold.co/150x250/000000/FFFFFF?text=BÓC+BÀI" alt="Mặt sau lá bài Tarot">
            </div>
        </div>

        <div id="current-spread-display" class="current-spread-display">
            <!-- Các lá bài đang bóc trong lượt hiện tại sẽ hiển thị ở đây -->
        </div>

        <div class="button-area">
            <button id="draw-button">Bóc Bài</button>
            <button id="complete-spread-button" disabled>Hoàn Tất Lượt Bóc</button>
        </div>
        <div class="message-box" id="message-box"></div>

        <div class="ai-reading-area">
            <h3 class="text-lg font-bold text-gray-700 mb-2">Đọc Bài Bằng AI</h3>
            <div class="input-group mb-4">
                <h4 class="font-semibold text-gray-600 mb-2">Loại câu hỏi:</h4>
                <div class="radio-group flex flex-wrap gap-x-4 gap-y-2 justify-center">
                    <label>
                        <input type="radio" name="question-type" value="manual" checked> Tự nhập câu hỏi
                    </label>
                    <label>
                        <input type="radio" name="question-type" value="guided"> Chọn theo hướng dẫn
                    </label>
                </div>
            </div>

            <textarea id="question-input" placeholder="Nhập câu hỏi của bạn cho bài Tarot (ví dụ: Tương lai tài chính của tôi sẽ ra sao?)" class="w-full p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-300"></textarea>

            <div id="guided-question-options" class="guided-question-options">
                <select id="topic-select" class="p-2 border rounded-lg">
                    <option value="">-- Chọn Chủ Đề --</option>
                    <option value="Tình yêu và mối quan hệ">Tình yêu và mối quan hệ</option>
                    <option value="Sự nghiệp và công việc">Sự nghiệp và công việc</option>
                    <option value="Tài chính và tiền bạc">Tài chính và tiền bạc</option>
                    <option value="Sức khỏe và tinh thần">Sức khỏe và tinh thần</option>
                    <option value="Phát triển cá nhân">Phát triển cá nhân</option>
                    <option value="Gia đình và bạn bè">Gia đình và bạn bè</option>
                    <option value="Học tập và kiến thức">Học tập và kiến thức</option>
                    <option value="Quyết định quan trọng">Quyết định quan trọng</option>
                    <option value="Khác">Khác</option>
                </select>
                <select id="timeframe-select" class="p-2 border rounded-lg">
                    <option value="">-- Chọn Thời Gian --</option>
                    <option value="hiện tại">Hiện tại</option>
                    <option value="trong 3 tháng tới">Tương lai 3 tháng tới</option>
                    <option value="trong 6 tháng tới">Tương lai 6 tháng tới</option>
                    <option value="trong 1 năm tới">Tương lai 1 năm tới</option>
                    <option value="trong tương lai xa">Tương lai xa</option>
                </select>
                <input type="text" id="additional-question" placeholder="Câu hỏi bổ sung (nếu có)" class="p-2 border rounded-lg">
            </div>

            <button id="get-ai-reading-button" disabled class="mt-4">Nhận Giải Thích Từ AI</button>
            <div id="ai-response-display" class="ai-response-sections">
                <!-- AI response will be structured here -->
                <div id="loading-ai-response" class="ai-response loading hidden">Đang phân tích...</div>

                <div id="ai-card-interpretations-container" class="hidden">
                    <h4 class="section-header">Giải thích từng lá bài:</h4>
                    <div id="ai-card-interpretations-row" class="ai-response-cards-row">
                        <!-- Individual card interpretations -->
                    </div>
                </div>

                <div id="ai-overall-interpretation" class="ai-overall-interpretation hidden">
                    <h4 class="section-header">Tổng Quan Lượt Bóc:</h4>
                    <p id="overall-text"></p>
                </div>
                <div id="ai-suggestions" class="ai-suggestions hidden">
                    <h4 class="section-header">Gợi Ý và Lời Khuyên:</h4>
                    <p id="suggestions-text"></p>
                </div>
            </div>
        </div>

        <h2 class="text-xl font-bold text-gray-700 mt-4">Lịch Sử Các Lượt Bóc:</h2>
        <div id="history-container" class="history-container">
            <!-- Các lượt bóc đã hoàn tất sẽ được thêm vào đây -->
        </div>
    </div>

    <script>
        // Danh sách đầy đủ 78 lá bài Tarot (Major Arcana và Minor Arcana)
        const allTarotCards = [
            "0 - The Fool", "I - The Magician", "II - The High Priestess", "III - The Empress",
            "IV - The Emperor", "V - The Hierophant", "VI - The Lovers", "VII - The Chariot",
            "VIII - Strength", "IX - The Hermit", "X - Wheel of Fortune", "XI - Justice",
            "XII - The Hanged Man", "XIII - Death", "XIV - Temperance", "XV - The Devil",
            "XVI - The Tower", "XVII - The Star", "XVIII - The Moon", "XIX - The Sun",
            "XX - Judgement", "XXI - The World",

            "Ace of Wands", "Two of Wands", "Three of Wands", "Four of Wands", "Five of Wands",
            "Six of Wands", "Seven of Wands", "Eight of Wands", "Nine of Wands", "Ten of Wands",
            "Page of Wands", "Knight of Wands", "Queen of Wands", "King of Wands",

            "Ace of Cups", "Two of Cups", "Three of Cups", "Four of Cups", "Five of Cups",
            "Six of Cups", "Seven of Cups", "Eight of Cups", "Nine of Cups", "Ten of Cups",
            "Page of Cups", "Knight of Cups", "Queen of Cups", "King of Cups",

            "Ace of Swords", "Two of Swords", "Three of Swords", "Four of Swords", "Five of Swords",
            "Six of Swords", "Seven of Swords", "Eight of Swords", "Nine of Swords", "Ten of Swords",
            "Page of Swords", "Knight of Swords", "Queen of Swords", "King of Swords",

            "Ace of Pentacles", "Two of Pentacles", "Three of Pentacles", "Four of Pentacles",
            "Five of Pentacles", "Six of Pentacles", "Seven of Pentacles", "Eight of Pentacles",
            "Nine of Pentacles", "Ten of Pentacles", "Page of Pentacles", "Knight of Pentacles",
            "Queen of Pentacles", "King of Pentacles"
        ];

        let currentDeck = []; // Current deck to draw from
        let currentDrawnCards = []; // Cards drawn in the current turn
        let historySpreads = []; // History of completed spreads

        let numCardsToDraw = 1; // Default to 1 card

        const currentCardElement = document.getElementById('current-card');
        const cardBackImg = document.getElementById('card-back-img');
        const drawButton = document.getElementById('draw-button');
        const completeSpreadButton = document.getElementById('complete-spread-button');
        const messageBox = document.getElementById('message-box');
        const currentSpreadDisplay = document.getElementById('current-spread-display');
        const historyContainer = document.getElementById('history-container');

        const spreadTypeRadios = document.querySelectorAll('input[name="spread-type"]');
        const questionTypeRadios = document.querySelectorAll('input[name="question-type"]');
        const questionInput = document.getElementById('question-input');
        const guidedQuestionOptions = document.getElementById('guided-question-options');
        const topicSelect = document.getElementById('topic-select');
        const timeframeSelect = document.getElementById('timeframe-select');
        const additionalQuestionInput = document.getElementById('additional-question');

        const getAiReadingButton = document.getElementById('get-ai-reading-button');
        const aiResponseDisplay = document.getElementById('ai-response-display');
        const loadingAiResponse = document.getElementById('loading-ai-response');
        const aiCardInterpretationsContainer = document.getElementById('ai-card-interpretations-container');
        const aiCardInterpretationsRow = document.getElementById('ai-card-interpretations-row');
        const aiOverallInterpretation = document.getElementById('ai-overall-interpretation');
        const overallText = document.getElementById('overall-text');
        const aiSuggestions = document.getElementById('ai-suggestions');
        const suggestionsText = document.getElementById('suggestions-text');

        // Exponential backoff parameters
        const MAX_RETRIES = 5;
        const INITIAL_BACKOFF_DELAY = 1000; // 1 second

        /**
         * Function to create a random HSL color based on the card name.
         * @param {string} cardName - The name of the card.
         * @returns {string} HSL color string (e.g., 'hsl(120, 75%, 65%)').
         */
        function getCardColorHSL(cardName) {
            const seed = cardName.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
            const hue = (seed * 137.508) % 360; // Golden angle approximation for color distribution
            const saturation = 70 + (seed % 30); // Random saturation between 70-99
            const lightness = 60 + (seed % 20); // Random lightness between 60-79
            return `hsl(${hue}, ${saturation}%, ${lightness}%)`;
        }

        /**
         * Function to display messages in the message box.
         * @param {string} message - The message content.
         * @param {string} type - Message type ('success', 'error', 'info').
         */
        function showMessage(message, type = 'info') {
            messageBox.textContent = message;
            messageBox.className = 'message-box show'; // Reset class
            if (type === 'error') {
                messageBox.classList.add('bg-red-500');
            } else if (type === 'success') {
                messageBox.classList.add('bg-green-500');
            } else {
                messageBox.classList.add('bg-blue-500');
            }
            setTimeout(() => {
                messageBox.classList.remove('show');
            }, 3000); // Hide after 3 seconds
        }

        /**
         * Function to shuffle the deck.
         * Creates a random copy of the original full 78-card deck.
         */
        function shuffleDeck() {
            currentDeck = [...allTarotCards]; // Start with a full copy of the original deck
            for (let i = currentDeck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [currentDeck[i], currentDeck[j]] = [currentDeck[j], currentDeck[i]]; // Swap positions
            }
            showMessage("Bộ bài đã được xáo trộn!", "success");
        }

        /**
         * Function to update the display of the current card (the largest one).
         * @param {string} cardName - The name of the card to display.
         */
        function updateCurrentCardDisplay(cardName) {
            currentCardElement.classList.add('drawn');
            const cardColor = getCardColorHSL(cardName);

            // Hide the back image if present
            if (cardBackImg) {
                cardBackImg.style.display = 'none';
            }

            // Set the background color for the main card
            currentCardElement.style.backgroundColor = cardColor;

            // Add text overlay to display the card name clearly
            let textOverlay = currentCardElement.querySelector('.card-text-overlay');
            if (!textOverlay) {
                textOverlay = document.createElement('div');
                textOverlay.classList.add('card-text-overlay');
                currentCardElement.appendChild(textOverlay);
            }
            textOverlay.textContent = cardName;
        }

        /**
         * Function to update the display of the cards currently being drawn.
         */
        function updateCurrentSpreadDisplay() {
            currentSpreadDisplay.innerHTML = ''; // Clear old content
            currentDrawnCards.forEach(cardName => {
                const cardDiv = document.createElement('div');
                cardDiv.classList.add('current-spread-card');
                cardDiv.style.backgroundColor = getCardColorHSL(cardName); // Set background color for the small card

                const cardNameSpan = document.createElement('span');
                cardNameSpan.classList.add('card-name-text');
                cardNameSpan.textContent = cardName; // Display full card name
                cardDiv.appendChild(cardNameSpan);
                currentSpreadDisplay.appendChild(cardDiv);
            });
        }

        /**
         * Function to update the display of the entire history of spreads.
         */
        function updateHistoryDisplay() {
            historyContainer.innerHTML = ''; // Clear all old history to redraw
            // Iterate in reverse to show the newest spread on top
            historySpreads.slice().reverse().forEach((spread, index) => {
                const spreadGroupDiv = document.createElement('div');
                spreadGroupDiv.classList.add('history-spread-group');

                const headerDiv = document.createElement('div');
                headerDiv.classList.add('history-spread-header');
                headerDiv.innerHTML = `
                    <span>Bộ ${historySpreads.length - index}</span>
                    <span>${spread.timestamp}</span>
                `;
                spreadGroupDiv.appendChild(headerDiv);

                const cardsDiv = document.createElement('div');
                cardsDiv.classList.add('history-spread-cards');

                spread.cards.forEach(cardName => {
                    const cardItemDiv = document.createElement('div');
                    cardItemDiv.classList.add('history-card-item');
                    cardItemDiv.style.backgroundColor = getCardColorHSL(cardName); // Set background color for history card

                    const cardNameSpan = document.createElement('span');
                    cardNameSpan.classList.add('card-name-text');
                    cardNameSpan.textContent = cardName; // Display full card name
                    cardItemDiv.appendChild(cardNameSpan);
                    cardsDiv.appendChild(cardItemDiv);
                });
                spreadGroupDiv.appendChild(cardsDiv);
                historyContainer.appendChild(spreadGroupDiv); // Add to the end to maintain reversed order
            });
            historyContainer.scrollTop = 0; // Scroll to the top to see the newest set
        }

        /**
         * Function to draw a card.
         */
        function drawCard() {
            if (currentDrawnCards.length >= numCardsToDraw) {
                showMessage(`Bạn đã bóc đủ ${numCardsToDraw} lá trong lượt này. Vui lòng nhấn 'Hoàn Tất Lượt Bóc'.`, "info");
                return;
            }

            if (currentDeck.length === 0) {
                showMessage("Bộ bài trống! Đang xáo trộn lại...", "error");
                shuffleDeck(); // Shuffle if out of cards
            }

            // Select a random card from the current deck
            const randomIndex = Math.floor(Math.random() * currentDeck.length);
            const drawnCard = currentDeck.splice(randomIndex, 1)[0]; // Draw the card and remove it from the deck
            currentDrawnCards.push(drawnCard); // Add to the list of cards drawn in the current turn

            updateCurrentCardDisplay(drawnCard); // Display the large card
            updateCurrentSpreadDisplay(); // Update the row of cards being drawn

            if (currentDrawnCards.length === numCardsToDraw) {
                drawButton.disabled = true; // Disable draw button
                completeSpreadButton.disabled = false; // Enable complete spread button
                getAiReadingButton.disabled = false; // Enable AI reading button
                showMessage(`Bạn đã bóc đủ ${numCardsToDraw} lá! Nhấn 'Hoàn Tất Lượt Bóc' để lưu và bắt đầu lượt mới, hoặc 'Nhận Giải Thích Từ AI' để xem bài.`, "success");
            } else {
                drawButton.textContent = `Bóc Bài (Lá ${currentDrawnCards.length + 1} / ${numCardsToDraw})`;
            }
        }

        /**
         * Function to complete the current spread and save it to history.
         */
        function completeSpread() {
            if (currentDrawnCards.length === numCardsToDraw) {
                const timestamp = new Date().toLocaleString('vi-VN', {
                    year: 'numeric', month: '2-digit', day: '2-digit',
                    hour: '2-digit', minute: '2-digit', second: '2-digit',
                    hour12: false
                });
                historySpreads.push({
                    timestamp: timestamp,
                    cards: [...currentDrawnCards], // Create a copy to prevent future changes
                    spreadType: numCardsToDraw // Store the spread type for history
                });

                currentDrawnCards = []; // Clear cards in the current turn
                currentSpreadDisplay.innerHTML = ''; // Clear current spread display
                clearAiResponseDisplay(); // Clear AI response sections
                questionInput.value = ''; // Clear question input
                resetGuidedQuestionInputs(); // Clear guided inputs

                updateHistoryDisplay(); // Update total history
                resetGameVisuals(); // Reset main interface and buttons
                shuffleDeck(); // Shuffle for a new turn

                showMessage("Lượt bóc đã được lưu vào lịch sử!", "success");
            } else {
                showMessage(`Bạn chưa bóc đủ ${numCardsToDraw} lá để hoàn tất lượt.`, "error");
            }
        }

        /**
         * Function to construct the user question based on selected type.
         */
        function getUserQuestion() {
            const questionType = document.querySelector('input[name="question-type"]:checked').value;
            if (questionType === 'manual') {
                return questionInput.value.trim();
            } else { // 'guided'
                const topic = topicSelect.value;
                const timeframe = timeframeSelect.value;
                const additional = additionalQuestionInput.value.trim();
                let questionParts = [];

                if (topic) {
                    questionParts.push(`Chủ đề: ${topic}.`);
                }
                if (timeframe) {
                    questionParts.push(`Thời gian muốn biết: ${timeframe}.`);
                }
                if (additional) {
                    questionParts.push(`Câu hỏi cụ thể: ${additional}.`);
                }

                if (questionParts.length === 0) {
                    return ""; // No guided question entered
                }
                return questionParts.join(" ");
            }
        }

        /**
         * Function to get AI reading for the current spread and user question.
         */
        async function getAiReading(retries = 0) {
            if (currentDrawnCards.length !== numCardsToDraw) {
                showMessage(`Vui lòng bóc đủ ${numCardsToDraw} lá bài trước khi yêu cầu AI đọc bài.`, "error");
                return;
            }

            const userQuestion = getUserQuestion();
            if (!userQuestion) {
                showMessage("Vui lòng nhập hoặc chọn câu hỏi của bạn.", "error");
                return;
            }

            clearAiResponseDisplay(); // Clear previous AI responses
            loadingAiResponse.classList.remove('hidden'); // Show loading indicator
            getAiReadingButton.disabled = true;

            const cardsString = currentDrawnCards.join(", ");
            const cardInterpretationsPrompt = currentDrawnCards.map((card, index) => `{ "cardName": "${card}", "interpretation": "Giải thích chi tiết cho lá bài ${index + 1} (${card}), bao gồm ý nghĩa của nó trong bối cảnh chung của bộ bài và liên quan đến câu hỏi. Có thể dài vài câu." }`).join(',');

            const prompt = `Bạn là một người đọc bài Tarot chuyên nghiệp. Tôi đã bóc được ${numCardsToDraw} lá bài Tarot: "${cardsString}". Câu hỏi của tôi là: "${userQuestion}".
            Vui lòng phân tích và đưa ra lời giải thích chi tiết, tập trung vào mối liên hệ giữa các lá bài và câu hỏi của tôi. Phản hồi của bạn phải theo định dạng JSON sau:
            {
              "cardInterpretations": [
                ${cardInterpretationsPrompt}
              ],
              "overallInterpretation": "Đây là phần tổng quan và tóm tắt ý nghĩa của cả ${numCardsToDraw} lá bài khi kết hợp lại, trả lời trực tiếp câu hỏi của người dùng. Hãy đưa ra cái nhìn sâu sắc và lời khuyên tổng thể dựa trên bộ bài.",
              "nextStepsSuggestion": "Dựa trên bài đọc, hãy đưa ra một hoặc hai gợi ý cụ thể về hành động tiếp theo mà người dùng có thể cân nhắc, hoặc gợi ý câu hỏi tiếp theo họ có thể đặt để làm rõ hơn vấn đề."
            }
            Đảm bảo phản hồi chỉ là một đối tượng JSON hợp lệ và không chứa bất kỳ văn bản nào khác ngoài JSON.`;

            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });
            const payload = {
                contents: chatHistory,
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "cardInterpretations": {
                                type: "ARRAY",
                                items: {
                                    type: "OBJECT",
                                    properties: {
                                        "cardName": { "type": "STRING" },
                                        "interpretation": { "type": "STRING" }
                                    }
                                }
                            },
                            "overallInterpretation": { "type": "STRING" },
                            "nextStepsSuggestion": { "type": "STRING" }
                        },
                        "propertyOrdering": ["cardInterpretations", "overallInterpretation", "nextStepsSuggestion"]
                    }
                }
            };
            const apiKey = ""; // Canvas will automatically provide the API key here.
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    if (response.status === 429 && retries < MAX_RETRIES) {
                        const delay = INITIAL_BACKOFF_DELAY * Math.pow(2, retries) + Math.random() * 1000;
                        console.warn(`Rate limit hit. Retrying in ${delay / 1000} seconds... (Attempt ${retries + 1})`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        return getAiReading(retries + 1); // Retry the call
                    } else {
                        throw new Error(`API request failed with status ${response.status}: ${response.statusText}`);
                    }
                }

                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const jsonText = result.candidates[0].content.parts[0].text;
                    try {
                        const parsedJson = JSON.parse(jsonText);
                        displayAiResponse(parsedJson);
                        showMessage("AI đã đưa ra lời giải thích!", "success");
                    } catch (parseError) {
                        console.error("Lỗi khi phân tích JSON từ AI:", parseError);
                        loadingAiResponse.textContent = "Lỗi: AI trả về định dạng không hợp lệ. Vui lòng thử lại.";
                        loadingAiResponse.classList.remove('hidden');
                        showMessage("Lỗi: Định dạng phản hồi AI không đúng.", "error");
                    }
                } else {
                    loadingAiResponse.textContent = "Không thể nhận được giải thích từ AI. Vui lòng thử lại.";
                    loadingAiResponse.classList.remove('hidden');
                    showMessage("Lỗi: Không có phản hồi từ AI.", "error");
                }
            } catch (error) {
                console.error("Lỗi khi gọi API AI:", error);
                loadingAiResponse.textContent = "Đã xảy ra lỗi khi kết nối với AI. Vui lòng thử lại sau.";
                loadingAiResponse.classList.remove('hidden');
                showMessage(`Lỗi: ${error.message}`, "error");
            } finally {
                loadingAiResponse.classList.add('hidden'); // Hide loading indicator
                getAiReadingButton.disabled = false;
            }
        }

        /**
         * Function to display the structured AI response into the designated areas.
         * @param {object} responseData - The parsed JSON response from the AI.
         */
        function displayAiResponse(responseData) {
            aiCardInterpretationsRow.innerHTML = ''; // Clear previous card interpretations
            responseData.cardInterpretations.forEach(card => {
                const cardInterpretationDiv = document.createElement('div');
                cardInterpretationDiv.classList.add('ai-card-interpretation');
                cardInterpretationDiv.innerHTML = `<h4>${card.cardName}:</h4><p>${card.interpretation}</p>`;
                aiCardInterpretationsRow.appendChild(cardInterpretationDiv);
            });
            aiCardInterpretationsContainer.classList.remove('hidden');
            aiCardInterpretationsRow.classList.remove('hidden');


            overallText.textContent = responseData.overallInterpretation;
            aiOverallInterpretation.classList.remove('hidden');

            suggestionsText.textContent = responseData.nextStepsSuggestion;
            aiSuggestions.classList.remove('hidden');
        }

        /**
         * Function to clear the AI response display sections.
         */
        function clearAiResponseDisplay() {
            aiCardInterpretationsRow.innerHTML = '';
            overallText.textContent = '';
            suggestionsText.textContent = '';

            aiCardInterpretationsContainer.classList.add('hidden');
            aiCardInterpretationsRow.classList.add('hidden');
            aiOverallInterpretation.classList.add('hidden');
            aiSuggestions.classList.add('hidden');
            loadingAiResponse.classList.add('hidden');
        }

        /**
         * Function to reset guided question inputs.
         */
        function resetGuidedQuestionInputs() {
            topicSelect.value = '';
            timeframeSelect.value = '';
            additionalQuestionInput.value = '';
        }

        /**
         * Function to reset the game visuals (does not affect history).
         */
        function resetGameVisuals() {
            // Reset the main card display to its back
            currentCardElement.classList.remove('drawn');
            currentCardElement.style.backgroundColor = ''; // Clear custom background color
            if (cardBackImg) {
                cardBackImg.style.display = 'block';
            }
            let textOverlay = currentCardElement.querySelector('.card-text-overlay');
            if (textOverlay) {
                textOverlay.remove();
            }

            drawButton.textContent = "Bóc Bài";
            drawButton.disabled = false;
            completeSpreadButton.disabled = true;
            getAiReadingButton.disabled = true; // Disable AI button until enough cards are drawn
            clearAiResponseDisplay(); // Clear AI response when resetting game visuals
        }

        // Event Listeners
        spreadTypeRadios.forEach(radio => {
            radio.addEventListener('change', (event) => {
                numCardsToDraw = parseInt(event.target.value);
                // Reset game visuals when spread type changes to avoid confusion
                currentDrawnCards = []; // Clear current drawn cards
                currentSpreadDisplay.innerHTML = ''; // Clear display
                resetGameVisuals(); // Reset buttons and main card
                shuffleDeck(); // Reshuffle for a clean start with new spread
                showMessage(`Bạn đã chọn bóc ${numCardsToDraw} lá.`, "info");
            });
        });

        questionTypeRadios.forEach(radio => {
            radio.addEventListener('change', (event) => {
                if (event.target.value === 'manual') {
                    questionInput.classList.remove('hidden');
                    guidedQuestionOptions.classList.remove('active');
                } else { // 'guided'
                    questionInput.classList.add('hidden');
                    guidedQuestionOptions.classList.add('active');
                }
            });
        });


        // Initialize the game when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            drawButton.addEventListener('click', drawCard);
            completeSpreadButton.addEventListener('click', completeSpread);
            getAiReadingButton.addEventListener('click', getAiReading); // Attach AI reading event

            // Set initial question type display
            const initialQuestionType = document.querySelector('input[name="question-type"]:checked').value;
            if (initialQuestionType === 'manual') {
                questionInput.classList.remove('hidden');
                guidedQuestionOptions.classList.remove('active');
            } else {
                questionInput.classList.add('hidden');
                guidedQuestionOptions.classList.add('active');
            }

            shuffleDeck(); // Shuffle the deck on initial load
            resetGameVisuals(); // Ensure initial display is correct
        });
    </script>
</body>
</html>
