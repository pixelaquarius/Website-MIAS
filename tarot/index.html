<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>·ª®ng D·ª•ng B√≥c B√†i Tarot ‚Äì Deep Mode nhi·ªÅu l·∫ßn</title>
  <script>
    /* N·∫øu trang KH√îNG ch·∫°y tr√™n Vercel c√πng project (vd: https://miastream.click/tarot/),
       h√£y b·∫≠t d√≤ng d∆∞·ªõi v√† ƒëi·ªÅn domain Vercel c·ªßa b·∫°n:
       window.__API_BASE = 'https://<your-project>.vercel.app/api';
    */
    // window.__API_BASE = 'https://your-project.vercel.app/api';
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#f0f4f8;margin:0;padding:20px;display:flex;min-height:100vh;align-items:center;justify-content:center}
    .app-container{background:#fff;border-radius:1.5rem;box-shadow:0 10px 25px rgba(0,0,0,.1);padding:2rem;width:100%;max-width:900px;display:flex;flex-direction:column;gap:1.1rem}
    .card{width:160px;height:260px;background:#2c3e50;border-radius:.75rem;box-shadow:0 4px 10px rgba(0,0,0,.2);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;border:3px solid #f39c12;position:relative;overflow:hidden;transition:.3s}
    .card.drawn{background:#ecf0f1;color:#2c3e50;border-color:#3498db}
    .card-image{width:100%;height:100%;object-fit:cover;border-radius:.75rem}
    .card-text-overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;padding:10px;text-align:center;color:#1f2937;font-weight:800}
    .current-spread-display{display:flex;gap:.75rem;justify-content:center;flex-wrap:wrap;min-height:180px;width:100%}
    .current-spread-card{width:110px;height:160px;background:#ecf0f1;border-radius:.6rem;border:2px solid #3498db;display:flex;align-items:center;justify-content:center;text-align:center;font-size:.75rem;padding:6px;line-height:1.2}
    .button-area{display:flex;gap:.6rem;flex-wrap:wrap;justify-content:center}
    .btn{background:#3498db;color:#fff;padding:.65rem 1.2rem;border:none;border-radius:9999px;font-weight:800;box-shadow:0 5px 15px rgba(52,152,219,.4);cursor:pointer}
    .btn.amber{background:#f59e0b}.btn.blue{background:#3b82f6}.btn.red{background:#ef4444}.btn.gray{background:#6b7280}
    .btn:disabled{background:#c8ccd1;cursor:not-allowed;box-shadow:none}
    .ai-reading-area{width:100%;background:#f5f5f5;border-radius:.75rem;padding:1.1rem;box-shadow:0 5px 15px rgba(0,0,0,.05)}
    .ai-reading-actions{display:flex;flex-wrap:wrap;gap:.6rem;justify-content:center;margin-top:.6rem}
    .ai-response-sections{display:flex;flex-direction:column;gap:.8rem;margin-top:.8rem}
    .ai-card-interpretation,.ai-overall-interpretation,.ai-suggestions{background:#e8f0fe;border:1px solid #a7c5ed;border-radius:.5rem;padding:.75rem;font-size:.95rem}
    .history-container{width:100%;max-height:420px;overflow:auto;background:#f9fafb;border:1px solid #e0e0e0;border-radius:.75rem;padding:.9rem}
    .history-spread-group{background:#fff;border:1px solid #dcdcdc;border-radius:.75rem;padding:.75rem;margin-bottom:.9rem;box-shadow:0 2px 8px rgba(0,0,0,.05);cursor:pointer}
    .history-badge{font-size:.7rem;padding:.15rem .45rem;border-radius:.4rem;background:#eef2ff;color:#3730a3;border:1px solid #c7d2fe}
    .history-row{display:flex;gap:.4rem;flex-wrap:nowrap;overflow:auto;padding-bottom:.25rem}
    .round-chip{flex:0 0 auto;display:flex;gap:.25rem;align-items:center;padding:.25rem .45rem;border-radius:.5rem;background:#f1f5f9;border:1px solid #e2e8f0;font-size:.72rem}
    .chip-card{padding:.1rem .3rem;border-radius:.3rem;border:1px solid #94a3b8;background:#e2e8f0}
    .message-box{background:#e74c3c;color:#fff;padding:.85rem;border-radius:.6rem;opacity:0;transform:translateY(-8px);transition:.25s;text-align:center}
    .message-box.show{opacity:1;transform:translateY(0)}
    .muted{color:#6b7280;font-size:.85rem}
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:50}
    .modal{background:#fff;width:min(900px,92vw);max-height:88vh;overflow:auto;border-radius:1rem;padding:1rem 1.1rem;box-shadow:0 20px 40px rgba(0,0,0,.25)}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem}
    .modal-title{font-weight:800;font-size:1.05rem}
    .close-btn{background:#ef4444;color:#fff;border:none;border-radius:.5rem;padding:.4rem .7rem;cursor:pointer}
    .round-block{border:1px solid #e5e7eb;border-radius:.6rem;padding:.6rem;margin:.4rem 0;background:#fafafa}
    .log-block{border:1px dashed #cbd5e1;border-radius:.6rem;padding:.6rem;background:#f8fafc}
  </style>
</head>
<body>
  <div class="app-container">
    <h1 class="text-2xl md:text-3xl font-extrabold text-gray-800 text-center">üîÆ ·ª®ng D·ª•ng B√≥c B√†i Tarot</h1>

    <div class="w-full bg-gray-50 p-4 rounded-lg shadow-sm">
      <h3 class="font-bold text-gray-700 mb-1">Ch·ªçn s·ªë l√° b√†i:</h3>
      <div class="flex flex-wrap gap-x-6 gap-y-2 justify-center">
        <label class="cursor-pointer"><input type="radio" name="spread-type" value="1" checked> 1 L√° T·ªïng Quan</label>
        <label class="cursor-pointer"><input type="radio" name="spread-type" value="3"> 3 L√° N·ªôi Dung S·∫Øp T·ªõi</label>
        <label class="cursor-pointer"><input type="radio" name="spread-type" value="5"> 5 L√° C·∫£ Cu·ªôc ƒê·ªùi</label>
      </div>
    </div>

    <div class="flex justify-center">
      <div id="current-card" class="card">
        <img id="card-back-img" class="card-image" src="https://placehold.co/160x260/111111/FFFFFF?text=B%C3%93C+B%C3%80I" alt="M·∫∑t sau l√° b√†i">
      </div>
    </div>

    <div id="current-spread-display" class="current-spread-display"></div>

    <div class="button-area">
      <button id="draw-button" class="btn">B√≥c B√†i</button>
      <button id="complete-spread-button" class="btn gray" disabled>Ho√†n T·∫•t</button>
      <button id="coi-sau-them-btn" class="btn amber" disabled>Coi S√¢u Th√™m</button>
      <button id="combine-summary-btn" class="btn blue" disabled>K·∫øt h·ª£p & T·ªïng quan</button>
      <button id="boc-bai-moi-btn" class="btn red" disabled>B√≥c B√†i M·ªõi</button>
    </div>

    <div class="message-box" id="message-box"></div>

    <div class="ai-reading-area">
      <h3 class="text-lg font-bold text-gray-700">ƒê·ªçc B√†i B·∫±ng AI</h3>

      <div class="flex gap-5 justify-center mb-2">
        <label><input type="radio" name="question-type" value="manual" checked> T·ª± nh·∫≠p c√¢u h·ªèi</label>
        <label><input type="radio" name="question-type" value="guided"> Ch·ªçn theo h∆∞·ªõng d·∫´n</label>
      </div>

      <textarea id="question-input" class="w-full p-2 border rounded-lg" placeholder="Nh·∫≠p c√¢u h·ªèi (vd: S·ª± nghi·ªáp 3 th√°ng t·ªõi?)"></textarea>

      <div id="guided-question-options" class="hidden mt-2">
        <select id="topic-select" class="w-full p-2 border rounded-lg mb-2">
          <option value="">-- Ch·ªçn Ch·ªß ƒê·ªÅ --</option>
          <option value="T√¨nh y√™u v√† m·ªëi quan h·ªá">T√¨nh y√™u v√† m·ªëi quan h·ªá</option>
          <option value="S·ª± nghi·ªáp v√† c√¥ng vi·ªác">S·ª± nghi·ªáp v√† c√¥ng vi·ªác</option>
          <option value="T√†i ch√≠nh v√† ti·ªÅn b·∫°c">T√†i ch√≠nh v√† ti·ªÅn b·∫°c</option>
          <option value="S·ª©c kh·ªèe v√† tinh th·∫ßn">S·ª©c kh·ªèe v√† tinh th·∫ßn</option>
          <option value="Ph√°t tri·ªÉn c√° nh√¢n">Ph√°t tri·ªÉn c√° nh√¢n</option>
          <option value="Gia ƒë√¨nh v√† b·∫°n b√®">Gia ƒë√¨nh v√† b·∫°n b√®</option>
          <option value="Quy·∫øt ƒë·ªãnh quan tr·ªçng">Quy·∫øt ƒë·ªãnh quan tr·ªçng</option>
        </select>
        <select id="timeframe-select" class="w-full p-2 border rounded-lg mb-2">
          <option value="">-- Ch·ªçn Th·ªùi Gian --</option>
          <option value="hi·ªán t·∫°i">Hi·ªán t·∫°i</option>
          <option value="trong 3 th√°ng t·ªõi">3 th√°ng t·ªõi</option>
          <option value="trong 6 th√°ng t·ªõi">6 th√°ng t·ªõi</option>
          <option value="trong 1 nƒÉm t·ªõi">1 nƒÉm t·ªõi</option>
        </select>
        <input id="additional-question" class="w-full p-2 border rounded-lg" placeholder="C√¢u h·ªèi b·ªï sung (n·∫øu c√≥)"/>
      </div>

      <p class="muted text-center">B·∫°n c√≥ th·ªÉ ƒë·ªïi ch·ªß ƒë·ªÅ ho·∫∑c nh·∫≠p c√¢u h·ªèi m·ªõi b·∫•t k·ª≥ l√∫c n√†o, k·ªÉ c·∫£ ƒëang ‚ÄúCoi s√¢u th√™m‚Äù.</p>

      <div class="ai-reading-actions">
        <button id="get-ai-reading-button" class="btn amber" disabled>Nh·∫≠n Gi·∫£i Th√≠ch T·ª´ AI</button>
      </div>

      <div id="ai-response-display" class="ai-response-sections">
        <div id="loading-ai-response" class="hidden italic text-center text-gray-600">ƒêang ph√¢n t√≠ch...</div>

        <div id="ai-card-interpretations-container" class="hidden">
          <h4 class="font-bold text-gray-700">Gi·∫£i th√≠ch t·ª´ng l√°:</h4>
          <div id="ai-card-interpretations-row" class="flex gap-2 flex-wrap"></div>
        </div>

        <div id="ai-overall-interpretation" class="ai-overall-interpretation hidden">
          <h4 class="font-bold text-gray-700 mb-1">T·ªïng Quan:</h4>
          <p id="overall-text"></p>
        </div>

        <div id="ai-suggestions" class="ai-suggestions hidden">
          <h4 class="font-bold text-gray-700 mb-1">G·ª£i √ù / B∆∞·ªõc Ti·∫øp:</h4>
          <p id="suggestions-text"></p>
        </div>
      </div>
    </div>

    <h2 class="text-xl font-bold text-gray-700">L·ªãch S·ª≠ C√°c L∆∞·ª£t B√≥c</h2>
    <div id="history-container" class="history-container"></div>
  </div>

  <div id="history-modal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">Chi ti·∫øt l·ªãch s·ª≠</div>
        <button id="modal-close-btn" class="close-btn">ƒê√≥ng</button>
      </div>
      <div id="modal-content"></div>
    </div>
  </div>

  <script>
    /* ==================== C·∫•u h√¨nh API ==================== */
    const API_BASE = (window.__API_BASE && window.__API_BASE.replace(/\/+$/,'')) || '/api';

    /* ==================== B·ªô b√†i ==================== */
    const allTarotCards = [
      "0 - The Fool","I - The Magician","II - The High Priestess","III - The Empress",
      "IV - The Emperor","V - The Hierophant","VI - The Lovers","VII - The Chariot",
      "VIII - Strength","IX - The Hermit","X - Wheel of Fortune","XI - Justice",
      "XII - The Hanged Man","XIII - Death","XIV - Temperance","XV - The Devil",
      "XVI - The Tower","XVII - The Star","XVIII - The Moon","XIX - The Sun",
      "XX - Judgement","XXI - The World",
      "Ace of Wands","Two of Wands","Three of Wands","Four of Wands","Five of Wands",
      "Six of Wands","Seven of Wands","Eight of Wands","Nine of Wands","Ten of Wands",
      "Page of Wands","Knight of Wands","Queen of Wands","King of Wands",
      "Ace of Cups","Two of Cups","Three of Cups","Four of Cups","Five of Cups",
      "Six of Cups","Seven of Cups","Eight of Cups","Nine of Cups","Ten of Cups",
      "Page of Cups","Knight of Cups","Queen of Cups","King of Cups",
      "Ace of Swords","Two of Swords","Three of Swords","Four of Swords","Five of Swords",
      "Six of Swords","Seven of Swords","Eight of Swords","Nine of Swords","Ten of Swords",
      "Page of Swords","Knight of Swords","Queen of Swords","King of Swords",
      "Ace of Pentacles","Two of Pentacles","Three of Pentacles","Four of Pentacles",
      "Five of Pentacles","Six of Pentacles","Seven of Pentacles","Eight of Pentacles",
      "Nine of Pentacles","Ten of Pentacles","Page of Pentacles","Knight of Pentacles",
      "Queen of Pentacles","King of Pentacles"
    ];

    /* ==================== State & DOM ==================== */
    let currentDeck=[], currentDrawnCards=[], historySpreads=[], numCardsToDraw=1;

    // Deep nhi·ªÅu l·∫ßn
    let deepMode=false, roundsCards=[], currentRoundIndex=1, sessionAiLogs=[], sessionCombinedSummary=null;

    const $ = id => document.getElementById(id);
    const currentCardElement = $('current-card');
    const cardBackImg = $('card-back-img');
    const drawButton = $('draw-button');
    const completeSpreadButton = $('complete-spread-button');
    const coiSauThemBtn = $('coi-sau-them-btn');
    const combineSummaryBtn = $('combine-summary-btn');
    const bocBaiMoiBtn = $('boc-bai-moi-btn');
    const messageBox = $('message-box');
    const currentSpreadDisplay = $('current-spread-display');
    const historyContainer = $('history-container');

    const spreadTypeRadios = document.querySelectorAll('input[name="spread-type"]');
    const questionTypeRadios = document.querySelectorAll('input[name="question-type"]');
    const questionInput = $('question-input');
    const guidedQuestionOptions = $('guided-question-options');
    const topicSelect = $('topic-select');
    const timeframeSelect = $('timeframe-select');
    const additionalQuestionInput = $('additional-question');

    const getAiReadingButton = $('get-ai-reading-button');

    const aiCardInterpretationsContainer = $('ai-card-interpretations-container');
    const aiCardInterpretationsRow = $('ai-card-interpretations-row');
    const aiOverallInterpretation = $('ai-overall-interpretation');
    const overallText = $('overall-text');
    const aiSuggestions = $('ai-suggestions');
    const suggestionsText = $('suggestions-text');
    const loadingAiResponse = $('loading-ai-response');

    const historyModal = $('history-modal');
    const modalCloseBtn = $('modal-close-btn');
    const modalContent = $('modal-content');

    /* ==================== Helpers ==================== */
    const nowTS = ()=> new Date().toLocaleString('vi-VN',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false});
    function getCardColorHSL(name){
      const seed=[...name].reduce((a,c)=>a+c.charCodeAt(0),0);
      const hue=(seed*137.508)%360, sat=70+(seed%30), light=60+(seed%20);
      return `hsl(${hue}, ${sat}%, ${light}%)`;
    }
    function showMessage(msg,type='info'){
      messageBox.textContent=msg;
      messageBox.className='message-box show';
      messageBox.style.backgroundColor = type==='error' ? '#ef4444' : (type==='success' ? '#10b981' : '#3b82f6');
      setTimeout(()=>messageBox.classList.remove('show'), 2600);
    }
    function shuffleDeck(){
      currentDeck=[...allTarotCards];
      for(let i=currentDeck.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [currentDeck[i],currentDeck[j]]=[currentDeck[j],currentDeck[i]]; }
      showMessage('B·ªô b√†i ƒë√£ ƒë∆∞·ª£c x√°o!', 'success');
    }
    function updateCurrentCardDisplay(cardName){
      currentCardElement.classList.add('drawn');
      currentCardElement.style.backgroundColor=getCardColorHSL(cardName);
      if(cardBackImg) cardBackImg.style.display='none';
      let overlay=currentCardElement.querySelector('.card-text-overlay');
      if(!overlay){ overlay=document.createElement('div'); overlay.className='card-text-overlay'; currentCardElement.appendChild(overlay); }
      overlay.textContent=cardName;
    }
    function updateCurrentSpreadDisplay(){
      currentSpreadDisplay.innerHTML='';
      currentDrawnCards.forEach(name=>{
        const d=document.createElement('div'); d.className='current-spread-card';
        d.style.backgroundColor=getCardColorHSL(name); d.innerHTML=`<span class="card-name-text">${name}</span>`;
        currentSpreadDisplay.appendChild(d);
      });
    }
    function clearAiResponseDisplay(){
      aiCardInterpretationsRow.innerHTML='';
      aiCardInterpretationsContainer.classList.add('hidden');
      aiOverallInterpretation.classList.add('hidden'); overallText.textContent='';
      aiSuggestions.classList.add('hidden'); suggestionsText.textContent='';
      loadingAiResponse.classList.add('hidden');
    }
    function resetQAInputs(){ questionInput.value=''; topicSelect.value=''; timeframeSelect.value=''; additionalQuestionInput.value=''; }
    function resetGameVisuals(){
      currentCardElement.classList.remove('drawn'); currentCardElement.style.backgroundColor='';
      if(cardBackImg) cardBackImg.style.display='block';
      const ov=currentCardElement.querySelector('.card-text-overlay'); if(ov) ov.remove();
      drawButton.textContent='B√≥c B√†i';
      drawButton.disabled=false; completeSpreadButton.disabled=true; getAiReadingButton.disabled=true;
      coiSauThemBtn.disabled=true; combineSummaryBtn.disabled=true; bocBaiMoiBtn.disabled=true;
      clearAiResponseDisplay(); resetQAInputs(); currentSpreadDisplay.innerHTML='';
    }

    /* ==================== History render ==================== */
    function renderDeepChips(rounds){
      const row=document.createElement('div'); row.className='history-row';
      rounds.forEach((cards, idx)=>{
        const chip=document.createElement('div'); chip.className='round-chip';
        const label=document.createElement('span'); label.className='font-semibold'; label.textContent=`L${idx+1}:`;
        chip.appendChild(label);
        cards.forEach(c=>{
          const cc=document.createElement('span'); cc.className='chip-card';
          cc.style.backgroundColor=getCardColorHSL(c); cc.textContent=c.split(' ')[0];
          chip.appendChild(cc);
        });
        row.appendChild(chip);
      });
      return row;
    }
    function updateHistoryDisplay(){
      historyContainer.innerHTML='';
      historySpreads.slice().map((e,i)=>({e,i})).reverse().forEach(({e,i}, displayIdx)=>{
        const wrap=document.createElement('div'); wrap.className='history-spread-group'; wrap.dataset.realIndex=i.toString();
        const head=document.createElement('div'); head.className='flex items-center justify-between text-sm font-bold text-gray-700';
        const badge=e.mode?.startsWith('deep')?`<span class="history-badge">Deep x${e.rounds?.length||2}</span>`:`<span class="history-badge">Single</span>`;
        head.innerHTML=`<span>B·ªô ${historySpreads.length-displayIdx}</span><span class="flex items-center gap-2">${badge}<span>${e.timestamp}</span></span>`;
        wrap.appendChild(head);
        if(e.mode?.startsWith('deep') && Array.isArray(e.rounds)){ wrap.appendChild(renderDeepChips(e.rounds)); }
        else { wrap.appendChild(renderDeepChips([e.cards||[]])); }
        historyContainer.appendChild(wrap);
      });
    }

    /* ==================== Modal ==================== */
    function openHistoryModal(index){
      const item=historySpreads[index]; if(!item) return; modalContent.innerHTML='';
      const title=document.createElement('div'); title.className='mb-2 text-sm text-gray-700';
      title.textContent=`${item.timestamp} ‚Ä¢ ${item.mode?.startsWith('deep')?'Deep':''} ${item.rounds?('x'+item.rounds.length):''}`;
      modalContent.appendChild(title);

      const addLogBlock=(l,wrap)=>{
        const log=document.createElement('div'); log.className='log-block mt-2 text-sm';
        log.innerHTML=`<div class="font-semibold">Q: ${l.question||'(kh√¥ng nh·∫≠p)'}</div>
                       <div><span class="font-semibold">T·ªïng quan:</span> ${l.overall||''}</div>
                       <div><span class="font-semibold">L·ªùi khuy√™n:</span> ${l.suggestion||''}</div>
                       <div class="text-xs text-gray-500 mt-1">${l.ts}</div>`;
        wrap.appendChild(log);
      };

      if(item.mode?.startsWith('deep') && Array.isArray(item.rounds)){
        item.rounds.forEach((cards, idx)=>{
          const rb=document.createElement('div'); rb.className='round-block';
          const h=document.createElement('div'); h.className='font-bold mb-1'; h.textContent=`L·∫ßn ${idx+1}`; rb.appendChild(h);
          rb.appendChild(renderDeepChips([cards]));
          (item.aiLogs||[]).filter(l=>Array.isArray(l.roundsIncluded)&&l.roundsIncluded.includes(idx+1)).forEach(l=>addLogBlock(l, rb));
          modalContent.appendChild(rb);
        });
        if(item.combinedSummary){
          const cb=document.createElement('div'); cb.className='round-block';
          const h=document.createElement('div'); h.className='font-bold mb-1'; h.textContent='T·ªïng h·ª£p (K·∫øt h·ª£p & T·ªïng quan)'; cb.appendChild(h);
          addLogBlock(item.combinedSummary, cb); modalContent.appendChild(cb);
        }
      } else {
        modalContent.appendChild(renderDeepChips([item.cards||[]]));
        (item.aiLogs||[]).forEach(l=>addLogBlock(l, modalContent));
      }
      $('history-modal').style.display='flex';
    }
    const closeHistoryModal=()=> $('history-modal').style.display='none';

    /* ==================== Game actions ==================== */
    function drawCard(){
      if(currentDrawnCards.length>=numCardsToDraw){ showMessage(`B·∫°n ƒë√£ b√≥c ƒë·ªß ${numCardsToDraw} l√°.`, 'info'); return; }
      if(!currentDeck.length) shuffleDeck();
      const idx=Math.floor(Math.random()*currentDeck.length);
      const card=currentDeck.splice(idx,1)[0];
      currentDrawnCards.push(card);
      updateCurrentCardDisplay(card);
      updateCurrentSpreadDisplay();

      if(currentDrawnCards.length===numCardsToDraw){
        drawButton.disabled=true; completeSpreadButton.disabled=false; getAiReadingButton.disabled=false; bocBaiMoiBtn.disabled=false;
        coiSauThemBtn.disabled=false;
        const completedRoundsCount = roundsCards.length + 1;
        combineSummaryBtn.disabled = !(deepMode && completedRoundsCount>=2);
        showMessage(`ƒê·ªß ${numCardsToDraw} l√°. B·∫°n c√≥ th·ªÉ 'AI' / 'Ho√†n t·∫•t' / 'Coi s√¢u th√™m' / 'K·∫øt h·ª£p'.`, 'success');
      } else {
        drawButton.textContent = `B√≥c B√†i (L√° ${currentDrawnCards.length+1}/${numCardsToDraw})`;
      }
    }
    function finalizeCurrentRoundIntoRounds(){
      if(currentDrawnCards.length===numCardsToDraw){ roundsCards.push([...currentDrawnCards]); currentDrawnCards=[]; currentSpreadDisplay.innerHTML=''; }
    }
    function completeSpread(){
      if(deepMode && currentDrawnCards.length===numCardsToDraw){ finalizeCurrentRoundIntoRounds(); }
      const timestamp=nowTS();

      if(deepMode){
        if(roundsCards.length===0){ showMessage('Ch∆∞a c√≥ l∆∞·ª£t n√†o ho√†n t·∫•t trong deep mode.', 'error'); return; }
        historySpreads.push({ timestamp, mode:'deep-multi', spreadType:numCardsToDraw, rounds: roundsCards.map(r=>[...r]), cards: roundsCards.flat(), aiLogs:[...sessionAiLogs], combinedSummary: sessionCombinedSummary?{...sessionCombinedSummary}:null });
      } else {
        if(currentDrawnCards.length!==numCardsToDraw){
          if(currentDrawnCards.length===0 && historySpreads.length>0){ resetAllSession(); showMessage('B·∫Øt ƒë·∫ßu l∆∞·ª£t m·ªõi.', 'info'); return; }
          showMessage(`Ch∆∞a ƒë·ªß ${numCardsToDraw} l√°.`, 'error'); return;
        }
        historySpreads.push({ timestamp, mode:'single', spreadType:numCardsToDraw, cards:[...currentDrawnCards], aiLogs:[...sessionAiLogs] });
      }
      updateHistoryDisplay(); resetAllSession(); showMessage('ƒê√£ l∆∞u v√†o l·ªãch s·ª≠.', 'success');
    }
    function resetAllSession(){
      deepMode=false; roundsCards=[]; currentRoundIndex=1; sessionAiLogs=[]; sessionCombinedSummary=null;
      currentDrawnCards=[]; currentSpreadDisplay.innerHTML=''; resetGameVisuals(); shuffleDeck();
    }

    /* ==================== Question ==================== */
    function getUserQuestion(){
      const type=document.querySelector('input[name="question-type"]:checked').value;
      if(type==='manual') return (questionInput.value||'').trim();
      const parts=[];
      if(topicSelect.value) parts.push(`Ch·ªß ƒë·ªÅ: ${topicSelect.value}.`);
      if(timeframeSelect.value) parts.push(`Th·ªùi gian mu·ªën bi·∫øt: ${timeframeSelect.value}.`);
      if(additionalQuestionInput.value.trim()) parts.push(`C√¢u h·ªèi c·ª• th·ªÉ: ${additionalQuestionInput.value.trim()}.`);
      return parts.join(' ');
    }

    /* ==================== Call AI ==================== */
    async function safeFetchJSON(url, options){
      const res = await fetch(url, options);
      const ct = res.headers.get('content-type') || '';
      if (!ct.includes('application/json')) {
        const text = await res.text();
        // C·∫Øt g·ªçn ƒë·ªÉ d·ªÖ ƒë·ªçc l·ªói
        const snippet = text.slice(0,120).replace(/\s+/g,' ');
        throw new Error((res.status===404?'API kh√¥ng t·ªìn t·∫°i. ':'') + `Ph·∫£n h·ªìi kh√¥ng ph·∫£i JSON (status ${res.status}). Snippet: ${snippet}`);
      }
      const data = await res.json();
      if (!res.ok) throw new Error(data?.error || `API error ${res.status}`);
      return data;
    }

    async function getAiReading(){
      const userQuestion=getUserQuestion();
      if(!userQuestion){ showMessage('Vui l√≤ng nh·∫≠p/ch·ªçn c√¢u h·ªèi.', 'error'); return; }

      let meta={mode:'single'}, cardsForAi=[];
      if(deepMode){
        const roundsComplete=[...roundsCards];
        if(currentDrawnCards.length===numCardsToDraw) roundsComplete.push([...currentDrawnCards]);
        if(roundsComplete.length===0){ showMessage('Ch∆∞a c√≥ l∆∞·ª£t n√†o ho√†n t·∫•t trong deep mode.', 'error'); return; }
        meta={mode:'deep', rounds: roundsComplete}; cardsForAi = roundsComplete.flat();
      } else {
        if(currentDrawnCards.length!==numCardsToDraw){ showMessage(`H√£y b√≥c ƒë·ªß ${numCardsToDraw} l√° tr∆∞·ªõc ho·∫∑c b·∫•m ‚ÄúHo√†n t·∫•t‚Äù.`, 'error'); return; }
        cardsForAi=[...currentDrawnCards];
      }

      clearAiResponseDisplay(); loadingAiResponse.classList.remove('hidden'); getAiReadingButton.disabled=true;

      try{
        const data = await safeFetchJSON(`${API_BASE}/ai-reading`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ cards: cardsForAi, question: userQuestion, meta })
        });

        // Render
        aiCardInterpretationsRow.innerHTML='';
        if(Array.isArray(data.cardInterpretations) && data.cardInterpretations.length){
          data.cardInterpretations.forEach(item=>{
            const div=document.createElement('div'); div.className='ai-card-interpretation';
            div.innerHTML = `<strong>${item.cardName}:</strong> <div>${item.interpretation}</div>`;
            aiCardInterpretationsRow.appendChild(div);
          });
          aiCardInterpretationsContainer.classList.remove('hidden');
        }
        overallText.textContent=data.overallInterpretation||''; aiOverallInterpretation.classList.remove('hidden');
        suggestionsText.textContent=data.nextStepsSuggestion||''; aiSuggestions.classList.remove('hidden');

        const ts=nowTS();
        let roundsIncluded=[];
        if(deepMode){ roundsIncluded=[...roundsCards.map((_,i)=>i+1)]; if(currentDrawnCards.length===numCardsToDraw) roundsIncluded.push(roundsCards.length+1); }
        else { roundsIncluded=[1]; }
        sessionAiLogs.push({ ts, type: deepMode?'deep':'single', roundsIncluded, question:userQuestion, overall:data.overallInterpretation||'', suggestion:data.nextStepsSuggestion||'' });

        bocBaiMoiBtn.disabled=false; completeSpreadButton.disabled=false; coiSauThemBtn.disabled=false;
        if(deepMode && roundsCards.length + (currentDrawnCards.length===numCardsToDraw?1:0) >= 2) combineSummaryBtn.disabled=false;
        showMessage('AI ƒë√£ ph·∫£n h·ªìi.', 'success');
      } catch(err){
        console.error(err); showMessage('L·ªói AI: ' + err.message, 'error');
      } finally{
        loadingAiResponse.classList.add('hidden'); getAiReadingButton.disabled=false;
      }
    }

    async function combineAndSummarize(){
      const roundsComplete=[...roundsCards]; if(currentDrawnCards.length===numCardsToDraw) roundsComplete.push([...currentDrawnCards]);
      if(roundsComplete.length<2){ showMessage('C·∫ßn √≠t nh·∫•t 2 l∆∞·ª£t ƒë·ªÉ k·∫øt h·ª£p.', 'error'); return; }
      const userQuestion=getUserQuestion() || 'T·ªïng h·ª£p chung cho c√°c l∆∞·ª£t ƒë√£ b√≥c';
      clearAiResponseDisplay(); loadingAiResponse.classList.remove('hidden');
      try{
        const data = await safeFetchJSON(`${API_BASE}/ai-reading`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ cards: roundsComplete.flat(), question: userQuestion, meta: { mode:'combine', rounds: roundsComplete } })
        });
        overallText.textContent=data.overallInterpretation||''; aiOverallInterpretation.classList.remove('hidden');
        suggestionsText.textContent=data.nextStepsSuggestion||''; aiSuggestions.classList.remove('hidden');
        sessionCombinedSummary={ ts:nowTS(), question:userQuestion, overall:data.overallInterpretation||'', suggestion:data.nextStepsSuggestion||'' };
        bocBaiMoiBtn.disabled=false; completeSpreadButton.disabled=false;
        showMessage('ƒê√£ t·∫°o t·ªïng quan k·∫øt h·ª£p 4‚Äì5 d√≤ng.', 'success');
      } catch(err){
        console.error(err); showMessage('L·ªói AI: ' + err.message, 'error');
      } finally{
        loadingAiResponse.classList.add('hidden');
      }
    }

    /* ==================== Events ==================== */
    document.addEventListener('DOMContentLoaded', ()=>{
      drawButton.addEventListener('click', drawCard);
      completeSpreadButton.addEventListener('click', completeSpread);
      bocBaiMoiBtn.addEventListener('click', completeSpread);
      getAiReadingButton.addEventListener('click', getAiReading);
      coiSauThemBtn.addEventListener('click', ()=>{
        if(currentDrawnCards.length!==numCardsToDraw){ showMessage(`H√£y b√≥c ƒë·ªß ${numCardsToDraw} l√° tr∆∞·ªõc khi coi s√¢u.`, 'error'); return; }
        deepMode=true; finalizeCurrentRoundIntoRounds(); currentRoundIndex=roundsCards.length+1;
        drawButton.disabled=false; getAiReadingButton.disabled=false; completeSpreadButton.disabled=false; bocBaiMoiBtn.disabled=false;
        combineSummaryBtn.disabled=!(roundsCards.length>=2);
        showMessage('Deep mode: r√∫t L·∫ßn ti·∫øp theo, h·ªèi AI, ho·∫∑c ‚ÄúK·∫øt h·ª£p & T·ªïng quan‚Äù.', 'info');
      });
      combineSummaryBtn.addEventListener('click', combineAndSummarize);

      spreadTypeRadios.forEach(r=>r.addEventListener('change', e=>{
        numCardsToDraw=parseInt(e.target.value,10);
        deepMode=false; roundsCards=[]; currentRoundIndex=1; sessionAiLogs=[]; sessionCombinedSummary=null;
        currentDrawnCards=[]; currentSpreadDisplay.innerHTML='';
        resetGameVisuals(); shuffleDeck();
        showMessage(`B·∫°n ƒë√£ ch·ªçn b√≥c ${numCardsToDraw} l√°.`, 'info');
      }));

      questionTypeRadios.forEach(r=>r.addEventListener('change', e=>{
        const guided=e.target.value==='guided';
        guidedQuestionOptions.classList.toggle('hidden', !guided);
        questionInput.classList.toggle('hidden', guided);
      }));

      historyContainer.addEventListener('click', e=>{
        const group=e.target.closest('.history-spread-group'); if(!group) return;
        const idx=parseInt(group.dataset.realIndex,10); openHistoryModal(idx);
      });
      modalCloseBtn.addEventListener('click', closeHistoryModal);
      $('history-modal').addEventListener('click', e=>{ if(e.target===$('history-modal')) closeHistoryModal(); });

      shuffleDeck(); resetGameVisuals();
    });

    document.addEventListener('keydown', (e)=>{
      const tag=(e.target.tagName||'').toLowerCase(); if(tag==='input'||tag==='textarea') return;
      const k=e.key.toLowerCase();
      if(k==='b') drawCard();
      if(k==='h') completeSpread();
      if(k==='x'){ shuffleDeck(); showMessage('ƒê√£ x√°o b√†i.', 'success'); }
    });
  </script>
</body>
</html>
