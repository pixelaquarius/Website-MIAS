<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ứng Dụng Bóc Bài Tarot Với Hình Ảnh</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Màu nền nhẹ nhàng */
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Căn trên cùng */
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        .app-container {
            background-color: #ffffff;
            border-radius: 1.5rem; 
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); 
            padding: 2rem;
            width: 100%;
            max-width: 850px; /* Tăng chiều rộng tối đa */
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
        }
        .card-display-area {
            width: 100%;
            display: flex;
            justify-content: center;
            margin-bottom: 1rem;
        }
        .card {
            width: 180px; /* Kích thước lá bài chính */
            height: 300px;
            background-color: #2c3e50; /* Màu mặt sau lá bài */
            border-radius: 0.75rem; 
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            display: flex;
            justify-content: center;
            align-items: center;
            border: 3px solid #f39c12; /* Viền vàng cam nổi bật */
            overflow: hidden; 
            position: relative;
        }
        .card-image-back, .card-image-front {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Phủ kín khung */
            border-radius: 0.75rem;
            transition: opacity 0.5s ease-in-out;
        }
        .card.drawn .card-image-back {
            opacity: 0;
            display: none;
        }
        .card:not(.drawn) .card-image-front {
            opacity: 0;
            display: none;
        }

        .current-spread-display {
            display: flex;
            gap: 0.75rem;
            justify-content: center;
            align-items: flex-start; 
            min-height: 180px; 
            width: 100%;
            margin-top: 0.5rem;
            flex-wrap: wrap; 
        }
        .current-spread-card {
            width: calc(33.33% - 0.5rem); /* 3 cards per row */
            max-width: 110px; 
            height: 180px;
            background-color: #ecf0f1; 
            border-radius: 0.5rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #2c3e50;
            text-align: center;
            border: 2px solid #3498db;
            overflow: hidden;
            position: relative;
        }
        .current-spread-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 0.5rem;
        }
        .card-name-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 4px 2px;
            font-size: 0.65rem;
            line-height: 1.2;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }

        /* Responsive adjustments */
        @media (max-width: 640px) {
            .app-container {
                padding: 1rem;
            }
            .card {
                width: 150px;
                height: 250px;
            }
            .current-spread-card {
                width: calc(50% - 0.375rem); /* 2 cards per row on mobile */
                max-width: 140px;
                height: 220px;
            }
        }

        .button-area {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }
        .button-area button {
            background-color: #3498db; 
            color: white;
            padding: 0.75rem 2rem;
            border-radius: 9999px; 
            font-size: 1.125rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4); 
        }
        .button-area button:hover:not(:disabled) {
            background-color: #2980b9; 
            transform: translateY(-2px); 
        }
        .button-area button:active:not(:disabled) {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(52, 152, 219, 0.4);
        }
        .button-area button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        /* AI Reading Area Styles */
        .ai-reading-area {
            background-color: #f5f5f5;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-top: 0.5rem;
            width: 100%;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        .ai-reading-actions {
            display: flex;
            flex-wrap: wrap; 
            gap: 0.75rem; 
            margin-top: 1rem;
            justify-content: center;
        }
        .ai-reading-actions button {
            padding: 0.6rem 1.2rem;
            border-radius: 9999px;
            font-size: 0.95rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
            border: none;
        }
        .ai-reading-actions .primary-btn {
            background-color: #f39c12; /* Orange */
        }
        .ai-reading-actions .primary-btn:hover:not(:disabled) {
            background-color: #e67e22;
        }
        .ai-reading-actions .secondary-btn {
            background-color: #3498db; /* Blue */
        }
        .ai-reading-actions .secondary-btn:hover:not(:disabled) {
            background-color: #2980b9;
        }
        .ai-reading-actions .reset-btn {
            background-color: #e74c3c; /* Red */
        }
        .ai-reading-actions .reset-btn:hover:not(:disabled) {
            background-color: #c0392b;
        }
        .ai-reading-actions button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .ai-response.loading {
            text-align: center;
            font-style: italic;
            color: #555;
            padding: 1rem;
        }

        /* History and Message Box styles (kept clean) */
        .message-box {
            background-color: #e74c3c; 
            color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            font-size: 1rem;
            text-align: center;
            opacity: 0;
            transform: translateY(-10px);
            transition: opacity 0.3s, transform 0.3s;
            max-width: 80%;
        }
        .message-box.show {
            opacity: 1;
            transform: translateY(0);
        }
        .history-container {
            width: 100%;
            max-height: 350px; 
            overflow-y: auto; 
            border: 1px solid #e0e0e0;
            border-radius: 0.75rem;
            padding: 1rem;
            background-color: #f9fafb;
        }
        .history-spread-group {
            border: 1px solid #dcdcdc;
            border-radius: 0.75rem;
            padding: 0.75rem;
            margin-bottom: 1.5rem;
            background-color: #ffffff;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        .history-spread-cards {
            display: flex;
            flex-wrap: wrap; 
            gap: 0.5rem; 
            justify-content: center;
        }
        .history-card-item {
            width: calc(25% - 0.4rem); /* 4 cards per row for history */
            max-width: 70px;
            height: 110px;
            background-color: #ecf0f1;
            border-radius: 0.5rem;
            border: 1px solid #3498db;
            overflow: hidden;
            position: relative;
        }
        .history-card-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 0.5rem;
        }
        .history-card-item .card-name-overlay {
            font-size: 0.55rem;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <h1 class="text-3xl font-extrabold text-gray-800 mb-4">Ứng Dụng Bóc Bài Tarot (Có Hình Ảnh)</h1>
        <p class="text-gray-600 text-center">Bóc bài, đặt câu hỏi, và nhận giải thích chuyên sâu từ AI.</p>

        <!-- Spread Options -->
        <div class="selection-area w-full bg-gray-50 p-4 rounded-lg shadow-sm">
            <h3 class="font-bold text-gray-700 mb-2 text-center">Chọn cách trải bài:</h3>
            <div class="radio-group flex flex-wrap gap-x-4 gap-y-2 mb-4 justify-center">
                <label>
                    <input type="radio" name="spread-type" value="1" checked> 1 Lá Tổng Quan
                </label>
                <label>
                    <input type="radio" name="spread-type" value="3"> 3 Lá (Quá Khứ - Hiện Tại - Tương Lai)
                </label>
                <label>
                    <input type="radio" name="spread-type" value="5"> 5 Lá (Giải quyết Vấn Đề)
                </label>
            </div>
        </div>

        <!-- Main Card Display -->
        <div class="card-display-area">
            <div id="current-card" class="card">
                <!-- Mặt sau (luôn hiển thị khi chưa bóc) -->
                <img id="card-image-back" class="card-image-back" 
                    src="https://placehold.co/180x300/2c3e50/f39c12?text=B%C3%92C+B%C3%80I" 
                    alt="Mặt sau lá bài Tarot"
                >
                <!-- Mặt trước (hiển thị khi bóc) - Placeholder sẽ được thay đổi bằng JS -->
                <img id="card-image-front" class="card-image-front" 
                    src="" 
                    alt="Lá bài Tarot đã bóc"
                >
            </div>
        </div>

        <!-- Current Spread Area -->
        <div id="current-spread-display" class="current-spread-display">
            <!-- Các lá bài đang bóc trong lượt hiện tại sẽ hiển thị ở đây -->
        </div>

        <div class="button-area">
            <button id="draw-button">Bóc Bài</button>
            <button id="complete-spread-button" disabled>Hoàn Tất Lượt Bóc</button>
        </div>
        <div class="message-box" id="message-box"></div>

        <!-- AI Reading Area -->
        <div class="ai-reading-area">
            <h3 class="text-lg font-bold text-gray-700 mb-2 text-center">Bước 2: Đặt Câu Hỏi và Nhận Giải Thích</h3>
            
            <textarea id="question-input" 
                      placeholder="Nhập câu hỏi của bạn cho bộ bài (ví dụ: Tương lai tài chính của tôi sẽ ra sao?)" 
                      class="w-full p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-300"
                      rows="3"></textarea>

            <div class="ai-reading-actions">
                <button id="get-ai-reading-button" disabled class="primary-btn">Nhận Giải Thích Từ AI</button>
                <button id="coi-sau-them-btn" disabled class="secondary-btn">Hỏi Sâu Thêm (Cùng Bộ Bài)</button>
                <button id="boc-bai-moi-btn" disabled class="reset-btn">Bóc Bài Mới</button>
            </div>

            <div id="ai-response-display" class="mt-4">
                <div id="loading-ai-response" class="ai-response loading hidden">
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-600 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Đang phân tích và giải thích bài Tarot...
                </div>

                <!-- AI Response Sections -->
                <div id="ai-card-interpretations-container" class="mt-4 hidden p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <h4 class="text-md font-bold text-blue-800 mb-3 text-center">Giải Thích Từng Lá Bài:</h4>
                    <div id="ai-card-interpretations-row" class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                        <!-- Individual card interpretations -->
                    </div>
                </div>

                <div id="ai-overall-interpretation" class="mt-4 hidden p-4 bg-green-50 border border-green-200 rounded-lg">
                    <h4 class="text-md font-bold text-green-800 mb-2 text-center">Tổng Quan và Trả Lời Câu Hỏi:</h4>
                    <p id="overall-text" class="text-gray-700"></p>
                </div>
                <div id="ai-suggestions" class="mt-4 hidden p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <h4 class="text-md font-bold text-yellow-800 mb-2 text-center">Gợi Ý và Lời Khuyên:</h4>
                    <p id="suggestions-text" class="text-gray-700"></p>
                </div>
            </div>
        </div>

        <h2 class="text-xl font-bold text-gray-700 mt-6">Lịch Sử Các Lượt Bóc:</h2>
        <div id="history-container" class="history-container">
            <!-- Lịch sử các lượt bóc đã hoàn tất -->
        </div>
    </div>

    <script>
        // API Key for Gemini API.
        // CẢNH BÁO BẢO MẬT: Storing API keys trực tiếp trong client-side code (như file HTML này)
        // và công khai nó (trên GitHub/Server Public) là RỦI RO LỚN.
        // Trong môi trường Canvas này, key được tự động cung cấp (const apiKey = "";). 
        // Khi triển khai bên ngoài, BẠN PHẢI sử dụng một BACKEND SERVER để giấu key.
        const apiKey = ""; 

        // Danh sách đầy đủ 78 lá bài Tarot 
        const allTarotCards = [
            "0 - The Fool", "I - The Magician", "II - The High Priestess", "III - The Empress",
            "IV - The Emperor", "V - The Hierophant", "VI - The Lovers", "VII - The Chariot",
            "VIII - Strength", "IX - The Hermit", "X - Wheel of Fortune", "XI - Justice",
            "XII - The Hanged Man", "XIII - Death", "XIV - Temperance", "XV - The Devil",
            "XVI - The Tower", "XVII - The Star", "XVIII - The Moon", "XIX - The Sun",
            "XX - Judgement", "XXI - The World",
            "Ace of Wands", "Two of Wands", "Three of Wands", "Four of Wands", "Five of Wands",
            "Six of Wands", "Seven of Wands", "Eight of Wands", "Nine of Wands", "Ten of Wands",
            "Page of Wands", "Knight of Wands", "Queen of Wands", "King of Wands",
            "Ace of Cups", "Two of Cups", "Three of Cups", "Four of Cups", "Five of Cups",
            "Six of Cups", "Seven of Cups", "Eight of Cups", "Nine of Cups", "Ten of Cups",
            "Page of Cups", "Knight of Cups", "Queen of Cups", "King of Cups",
            "Ace of Swords", "Two of Swords", "Three of Swords", "Four of Swords", "Five of Swords",
            "Six of Swords", "Seven of Swords", "Eight of Swords", "Nine of Swords", "Ten of Swords",
            "Page of Swords", "Knight of Swords", "Queen of Swords", "King of Swords",
            "Ace of Pentacles", "Two of Pentacles", "Three of Pentacles", "Four of Pentacles",
            "Five of Pentacles", "Six of Pentacles", "Seven of Pentacles", "Eight of Pentacles",
            "Nine of Pentacles", "Ten of Pentacles", "Page of Pentacles", "Knight of Pentacles",
            "Queen of Pentacles", "King of Pentacles"
        ];

        let currentDeck = []; 
        let currentDrawnCards = []; 
        let historySpreads = []; 

        let numCardsToDraw = 1; 

        // DOM Elements
        const currentCardElement = document.getElementById('current-card');
        const cardImageFront = document.getElementById('card-image-front');
        const drawButton = document.getElementById('draw-button');
        const completeSpreadButton = document.getElementById('complete-spread-button');
        const messageBox = document.getElementById('message-box');
        const currentSpreadDisplay = document.getElementById('current-spread-display');
        const historyContainer = document.getElementById('history-container');

        const spreadTypeRadios = document.querySelectorAll('input[name="spread-type"]');
        const questionInput = document.getElementById('question-input');

        const getAiReadingButton = document.getElementById('get-ai-reading-button');
        const coiSauThemBtn = document.getElementById('coi-sau-them-btn'); 
        const bocBaiMoiBtn = document.getElementById('boc-bai-moi-btn');   

        const loadingAiResponse = document.getElementById('loading-ai-response');
        const aiCardInterpretationsContainer = document.getElementById('ai-card-interpretations-container');
        const aiCardInterpretationsRow = document.getElementById('ai-card-interpretations-row');
        const aiOverallInterpretation = document.getElementById('ai-overall-interpretation');
        const overallText = document.getElementById('overall-text');
        const aiSuggestions = document.getElementById('ai-suggestions');
        const suggestionsText = document.getElementById('suggestions-text');

        const MAX_RETRIES = 5;
        const INITIAL_BACKOFF_DELAY = 1000; 

        /**
         * Tạo URL hình ảnh placeholder độc đáo cho mỗi lá bài.
         * Sử dụng placehold.co với màu sắc và chữ khác nhau.
         * @param {string} cardName - Tên lá bài (ví dụ: "I - The Magician").
         * @returns {string} URL hình ảnh.
         */
        function getCardImageUrl(cardName) {
            // Loại bỏ khoảng trắng và ký tự đặc biệt để dùng làm seed màu
            const cleanName = cardName.replace(/[^a-zA-Z0-9]/g, ''); 
            const seed = cleanName.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
            
            // Tạo màu sắc và văn bản placeholder
            const hue = (seed * 137.508) % 360; 
            const saturation = 50 + (seed % 30); 
            const lightness = 70 + (seed % 20);
            const color = `hsl(${hue}, ${saturation}%, ${lightness}%)`;
            
            // Màu nền tối và màu chữ sáng
            const bgColorHex = '1c305a'; // Màu xanh đậm
            const textColorHex = 'ffffff'; 

            // Rút ngắn tên để hiển thị trên placeholder (dễ nhận biết hơn)
            const shortName = cardName.split(' ').map(word => {
                if (word.length > 2 && !['of', 'The', 'and', 'or'].includes(word)) {
                    return word.substring(0, 3);
                }
                return word;
            }).join('+');

            return `https://placehold.co/400x600/${bgColorHex}/${textColorHex}?text=${shortName}`;
        }

        /**
         * Hiển thị thông báo.
         */
        function showMessage(message, type = 'info') {
            messageBox.textContent = message;
            messageBox.className = 'message-box show'; 
            messageBox.classList.remove('bg-red-500', 'bg-green-500', 'bg-blue-500');

            if (type === 'error') {
                messageBox.classList.add('bg-red-500');
            } else if (type === 'success') {
                messageBox.classList.add('bg-green-500');
            } else {
                messageBox.classList.add('bg-blue-500');
            }
            setTimeout(() => {
                messageBox.classList.remove('show');
            }, 3000); 
        }

        /**
         * Xáo trộn bộ bài và reset trạng thái.
         */
        function shuffleDeck() {
            currentDeck = [...allTarotCards]; 
            for (let i = currentDeck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [currentDeck[i], currentDeck[j]] = [currentDeck[j], currentDeck[i]]; 
            }
            showMessage("Bộ bài đã được xáo trộn! Mời bạn bóc lá đầu tiên.", "success");
        }

        /**
         * Cập nhật hiển thị lá bài chính (lá mới nhất).
         */
        function updateCurrentCardDisplay(cardName) {
            currentCardElement.classList.add('drawn');
            
            cardImageFront.src = getCardImageUrl(cardName);
            cardImageFront.alt = `Lá bài: ${cardName}`;
        }

        /**
         * Cập nhật hiển thị các lá bài trong lượt hiện tại.
         */
        function updateCurrentSpreadDisplay() {
            currentSpreadDisplay.innerHTML = ''; 
            currentDrawnCards.forEach(cardName => {
                const cardDiv = document.createElement('div');
                cardDiv.classList.add('current-spread-card');
                
                const img = document.createElement('img');
                img.src = getCardImageUrl(cardName);
                img.alt = cardName;

                const overlay = document.createElement('div');
                overlay.classList.add('card-name-overlay');
                overlay.textContent = cardName;

                cardDiv.appendChild(img);
                cardDiv.appendChild(overlay);
                currentSpreadDisplay.appendChild(cardDiv);
            });
        }

        /**
         * Cập nhật hiển thị toàn bộ lịch sử.
         */
        function updateHistoryDisplay() {
            historyContainer.innerHTML = ''; 
            historySpreads.slice().reverse().forEach((spread, index) => {
                const spreadGroupDiv = document.createElement('div');
                spreadGroupDiv.classList.add('history-spread-group');

                const headerDiv = document.createElement('div');
                headerDiv.classList.add('history-spread-header', 'mb-2', 'flex', 'justify-between', 'items-center', 'text-sm', 'font-semibold');
                headerDiv.innerHTML = `
                    <span>Bộ ${historySpreads.length - index}: ${spread.spreadType} Lá</span>
                    <span class="text-gray-500">${spread.timestamp}</span>
                `;
                spreadGroupDiv.appendChild(headerDiv);

                const cardsDiv = document.createElement('div');
                cardsDiv.classList.add('history-spread-cards');

                spread.cards.forEach(cardName => {
                    const cardItemDiv = document.createElement('div');
                    cardItemDiv.classList.add('history-card-item');

                    const img = document.createElement('img');
                    img.src = getCardImageUrl(cardName);
                    img.alt = cardName;

                    const overlay = document.createElement('div');
                    overlay.classList.add('card-name-overlay');
                    overlay.textContent = cardName;

                    cardItemDiv.appendChild(img);
                    cardItemDiv.appendChild(overlay);
                    cardsDiv.appendChild(cardItemDiv);
                });
                spreadGroupDiv.appendChild(cardsDiv);
                historyContainer.appendChild(spreadGroupDiv); 
            });
            historyContainer.scrollTop = 0; 
        }

        /**
         * Bóc một lá bài.
         */
        function drawCard() {
            if (currentDrawnCards.length >= numCardsToDraw) {
                showMessage(`Bạn đã bóc đủ ${numCardsToDraw} lá. Vui lòng nhấn 'Nhận Giải Thích Từ AI'.`, "info");
                return;
            }

            if (currentDeck.length === 0) {
                shuffleDeck(); 
            }

            const randomIndex = Math.floor(Math.random() * currentDeck.length);
            const drawnCard = currentDeck.splice(randomIndex, 1)[0]; 
            currentDrawnCards.push(drawnCard); 

            updateCurrentCardDisplay(drawnCard); 
            updateCurrentSpreadDisplay(); 

            if (currentDrawnCards.length === numCardsToDraw) {
                drawButton.disabled = true; 
                completeSpreadButton.disabled = false; 
                getAiReadingButton.disabled = false; 
                showMessage(`Bạn đã bóc đủ ${numCardsToDraw} lá! Mời bạn nhập câu hỏi và nhấn 'Nhận Giải Thích Từ AI'.`, "success");
            } else {
                drawButton.textContent = `Bóc Bài (Lá ${currentDrawnCards.length + 1} / ${numCardsToDraw})`;
            }
        }

        /**
         * Hoàn tất lượt bóc, lưu vào lịch sử và bắt đầu lượt mới.
         */
        function completeSpread() {
            if (currentDrawnCards.length > 0) {
                const timestamp = new Date().toLocaleString('vi-VN', {
                    year: 'numeric', month: '2-digit', day: '2-digit',
                    hour: '2-digit', minute: '2-digit', second: '2-digit',
                    hour12: false
                });
                historySpreads.push({
                    timestamp: timestamp,
                    cards: [...currentDrawnCards], 
                    spreadType: numCardsToDraw
                });
                showMessage("Lượt bóc đã được lưu vào lịch sử!", "success");
            }

            // Reset và bắt đầu lượt mới
            currentDrawnCards = []; 
            currentSpreadDisplay.innerHTML = ''; 
            clearAiResponseDisplay(); 
            questionInput.value = ''; 

            updateHistoryDisplay(); 
            resetGameVisuals(); 
            shuffleDeck(); 
        }

        /**
         * Đặt lại giao diện về trạng thái ban đầu.
         */
        function resetGameVisuals() {
            currentCardElement.classList.remove('drawn');
            cardImageFront.src = ""; // Clear front image
            
            drawButton.textContent = "Bóc Bài";
            drawButton.disabled = false;
            completeSpreadButton.disabled = true;
            getAiReadingButton.disabled = true; 
            coiSauThemBtn.disabled = true;       
            bocBaiMoiBtn.disabled = true;       
        }

        /**
         * Clear AI response display sections.
         */
        function clearAiResponseDisplay() {
            aiCardInterpretationsRow.innerHTML = '';
            overallText.textContent = '';
            suggestionsText.textContent = '';

            aiCardInterpretationsContainer.classList.add('hidden');
            aiOverallInterpretation.classList.add('hidden');
            aiSuggestions.classList.add('hidden');
            loadingAiResponse.classList.add('hidden');
        }

        /**
         * Hàm chính để gọi API Gemini và nhận giải thích Tarot.
         */
        async function getAiReading(retries = 0) {
            if (currentDrawnCards.length !== numCardsToDraw) {
                showMessage(`Vui lòng bóc đủ ${numCardsToDraw} lá bài trước khi yêu cầu AI đọc bài.`, "error");
                return;
            }

            const userQuestion = questionInput.value.trim();
            if (!userQuestion) {
                showMessage("Vui lòng nhập câu hỏi của bạn.", "error");
                return;
            }

            clearAiResponseDisplay(); 
            loadingAiResponse.classList.remove('hidden'); 
            getAiReadingButton.disabled = true;

            const cardsString = currentDrawnCards.join(", ");
            const cardInterpretationsPrompt = currentDrawnCards.map((card, index) => 
                `{ "cardName": "${card}", "interpretation": "Giải thích chi tiết cho lá bài ${index + 1} (${card}), bao gồm ý nghĩa của nó trong bối cảnh trải bài, liên hệ với câu hỏi của người dùng và đưa ra lời khuyên ngắn gọn." }`
            ).join(',');

            const prompt = `Bạn là một người đọc bài Tarot chuyên nghiệp, tập trung vào việc tư vấn các vấn đề về sự nghiệp, kinh doanh, và tối ưu hiệu suất. Tôi đã bóc được ${numCardsToDraw} lá bài Tarot: "${cardsString}". Câu hỏi của tôi là: "${userQuestion}".
            Vui lòng phân tích và đưa ra lời giải thích chi tiết, tập trung vào mối liên hệ giữa các lá bài và câu hỏi của tôi, đặc biệt là trong bối cảnh kinh doanh, marketing (CPM, GMV) và phát triển bản thân. Phản hồi của bạn phải theo định dạng JSON sau:
            {
              "cardInterpretations": [
                ${cardInterpretationsPrompt}
              ],
              "overallInterpretation": "Đây là phần tổng quan và tóm tắt ý nghĩa của cả ${numCardsToDraw} lá bài khi kết hợp lại, trả lời trực tiếp câu hỏi của người dùng. Hãy đưa ra cái nhìn sâu sắc và lời khuyên tổng thể dựa trên bộ bài, liên hệ với mục tiêu sự nghiệp/kinh doanh của người dùng.",
              "nextStepsSuggestion": "Dựa trên bài đọc, hãy đưa ra 3 gợi ý cụ thể về hành động tiếp theo mà người dùng có thể cân nhắc, hoặc gợi ý câu hỏi tiếp theo họ có thể đặt để làm rõ hơn vấn đề liên quan đến sự nghiệp/kinh doanh (ví dụ: Tối ưu CPM, mục tiêu GMV tiếp theo)."
            }
            Đảm bảo phản hồi chỉ là một đối tượng JSON hợp lệ và không chứa bất kỳ văn bản nào khác ngoài JSON.`;

            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });
            const payload = {
                contents: chatHistory,
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "cardInterpretations": {
                                type: "ARRAY",
                                items: {
                                    type: "OBJECT",
                                    properties: {
                                        "cardName": { "type": "STRING" },
                                        "interpretation": { "type": "STRING" }
                                    }
                                }
                            },
                            "overallInterpretation": { "type": "STRING" },
                            "nextStepsSuggestion": { "type": "STRING" }
                        },
                        "propertyOrdering": ["cardInterpretations", "overallInterpretation", "nextStepsSuggestion"]
                    }
                }
            };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    if (response.status === 429 && retries < MAX_RETRIES) {
                        const delay = INITIAL_BACKOFF_DELAY * Math.pow(2, retries) + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        return getAiReading(retries + 1); // Retry
                    } else {
                        throw new Error(`API request failed with status ${response.status}: ${response.statusText}`);
                    }
                }

                const result = await response.json();
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (jsonText) {
                    try {
                        const parsedJson = JSON.parse(jsonText);
                        displayAiResponse(parsedJson);
                        showMessage("AI đã đưa ra lời giải thích!", "success");
                        coiSauThemBtn.disabled = false;
                        bocBaiMoiBtn.disabled = false;
                        getAiReadingButton.disabled = false; // Re-enable for subsequent deep dive questions
                    } catch (parseError) {
                        console.error("Lỗi khi phân tích JSON từ AI:", parseError);
                        loadingAiResponse.textContent = "Lỗi: AI trả về định dạng không hợp lệ. Vui lòng thử lại.";
                        showMessage("Lỗi: Định dạng phản hồi AI không đúng.", "error");
                    }
                } else {
                    loadingAiResponse.textContent = "Không thể nhận được giải thích từ AI. Vui lòng thử lại.";
                    showMessage("Lỗi: Không có phản hồi từ AI.", "error");
                }
            } catch (error) {
                console.error("Lỗi khi gọi API AI:", error);
                loadingAiResponse.textContent = "Đã xảy ra lỗi khi kết nối với AI. Vui lòng thử lại sau.";
                showMessage(`Lỗi: ${error.message}`, "error");
            } finally {
                loadingAiResponse.classList.add('hidden'); 
            }
        }

        /**
         * Hiển thị phản hồi AI có cấu trúc.
         */
        function displayAiResponse(responseData) {
            aiCardInterpretationsRow.innerHTML = ''; 
            if (responseData.cardInterpretations && responseData.cardInterpretations.length > 0) {
                responseData.cardInterpretations.forEach(card => {
                    const cardInterpretationDiv = document.createElement('div');
                    cardInterpretationDiv.classList.add('p-3', 'bg-white', 'rounded-lg', 'shadow-md');
                    cardInterpretationDiv.innerHTML = `<h5 class="font-bold text-gray-800 mb-1">${card.cardName}:</h5><p class="text-sm text-gray-600">${card.interpretation}</p>`;
                    aiCardInterpretationsRow.appendChild(cardInterpretationDiv);
                });
                aiCardInterpretationsContainer.classList.remove('hidden');
            } else {
                 aiCardInterpretationsContainer.classList.add('hidden');
            }

            overallText.innerHTML = responseData.overallInterpretation.replace(/\n/g, '<br>');
            aiOverallInterpretation.classList.remove('hidden');

            suggestionsText.innerHTML = responseData.nextStepsSuggestion.replace(/\n/g, '<br>');
            aiSuggestions.classList.remove('hidden');
        }

        // Event Listeners
        spreadTypeRadios.forEach(radio => {
            radio.addEventListener('change', (event) => {
                numCardsToDraw = parseInt(event.target.value);
                currentDrawnCards = []; 
                currentSpreadDisplay.innerHTML = ''; 
                resetGameVisuals(); 
                shuffleDeck(); 
                showMessage(`Bạn đã chọn trải bài ${numCardsToDraw} lá.`, "info");
            });
        });

        coiSauThemBtn.addEventListener('click', () => {
            coiSauThemBtn.disabled = true; 
            bocBaiMoiBtn.disabled = false; 
            questionInput.value = ''; // Clear question for the new deep dive
            clearAiResponseDisplay();
            showMessage("Mời bạn nhập câu hỏi mới cho bộ bài hiện tại và nhấn 'Nhận Giải Thích Từ AI'.", "info");
        });

        bocBaiMoiBtn.addEventListener('click', () => {
            completeSpread(); 
        });


        // Initialize the game
        document.addEventListener('DOMContentLoaded', () => {
            drawButton.addEventListener('click', drawCard);
            completeSpreadButton.addEventListener('click', completeSpread);
            getAiReadingButton.addEventListener('click', getAiReading); 

            shuffleDeck(); 
            resetGameVisuals(); 
        });
    </script>
</body>
</html>
