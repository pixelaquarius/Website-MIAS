<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>·ª®ng D·ª•ng B√≥c B√†i Tarot ‚Äì Vercel (Deep Mode)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#f0f4f8; margin:0; padding:20px; display:flex; min-height:100vh; align-items:center; justify-content:center; }
    .app-container { background:#fff; border-radius:1.5rem; box-shadow:0 10px 25px rgba(0,0,0,.1); padding:2rem; width:100%; max-width:840px; display:flex; flex-direction:column; gap:1.25rem; }
    .card { width:160px; height:260px; background:#2c3e50; border-radius:.75rem; box-shadow:0 4px 10px rgba(0,0,0,.2); display:flex; align-items:center; justify-content:center; color:#fff; font-weight:700; border:3px solid #f39c12; position:relative; overflow:hidden; transition:.3s; }
    .card.drawn { background:#ecf0f1; color:#2c3e50; border-color:#3498db; }
    .card-image { width:100%; height:100%; object-fit:cover; border-radius:.75rem; }
    .card-text-overlay { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; padding:10px; text-align:center; color:#1f2937; font-weight:800; }
    .current-spread-display { display:flex; gap:.8rem; justify-content:center; flex-wrap:wrap; min-height:180px; width:100%; }
    .current-spread-card { width:110px; height:160px; background:#ecf0f1; border-radius:.6rem; border:2px solid #3498db; display:flex; align-items:center; justify-content:center; text-align:center; font-size:.75rem; padding:6px; line-height:1.2; }
    .button-area { display:flex; gap:.7rem; flex-wrap:wrap; justify-content:center; }
    .button-area button { background:#3498db; color:#fff; padding:.7rem 1.4rem; border:none; border-radius:9999px; font-weight:800; box-shadow:0 5px 15px rgba(52,152,219,.4); cursor:pointer; }
    .button-area button.bg-amber { background:#f59e0b; }
    .button-area button.bg-blue { background:#3b82f6; }
    .button-area button.bg-red { background:#ef4444; }
    .button-area button:disabled { background:#c8ccd1; cursor:not-allowed; box-shadow:none; }
    .ai-reading-area { width:100%; background:#f5f5f5; border-radius:.75rem; padding:1.1rem; box-shadow:0 5px 15px rgba(0,0,0,.05); }
    .ai-reading-actions { display:flex; flex-wrap:wrap; gap:.6rem; justify-content:center; margin-top:.6rem; }
    .ai-reading-actions button { background:#f39c12; color:#fff; padding:.55rem 1.1rem; border:none; border-radius:9999px; font-weight:700; }
    .ai-reading-actions button.bg-blue { background:#3b82f6; }
    .ai-reading-actions button.bg-red { background:#ef4444; }
    .ai-response-sections { display:flex; flex-direction:column; gap:.8rem; margin-top:.8rem; }
    .ai-card-interpretation, .ai-overall-interpretation, .ai-suggestions { background:#e8f0fe; border:1px solid #a7c5ed; border-radius:.5rem; padding:.75rem; font-size:.95rem; }
    .history-container { width:100%; max-height:380px; overflow:auto; background:#f9fafb; border:1px solid #e0e0e0; border-radius:.75rem; padding:.9rem; }
    .history-spread-group { background:#fff; border:1px solid #dcdcdc; border-radius:.75rem; padding:.75rem; margin-bottom:.9rem; box-shadow:0 2px 8px rgba(0,0,0,.05); }
    .history-badge { font-size:.7rem; padding:.15rem .45rem; border-radius:.4rem; background:#eef2ff; color:#3730a3; border:1px solid #c7d2fe; }
    .history-row { display:flex; gap:.5rem; flex-wrap:wrap; justify-content:center; margin-top:.4rem; }
    .history-card-item { width:86px; height:120px; background:#ecf0f1; border-radius:.5rem; border:2px solid #3498db; display:flex; align-items:center; justify-content:center; font-size:.65rem; text-align:center; padding:5px; line-height:1.2; }
    .message-box { background:#e74c3c; color:#fff; padding:.85rem; border-radius:.6rem; opacity:0; transform:translateY(-8px); transition:.25s; text-align:center; }
    .message-box.show { opacity:1; transform:translateY(0); }
    .muted { color:#6b7280; font-size:.85rem; }
  </style>
</head>
<body>
  <div class="app-container">
    <h1 class="text-2xl md:text-3xl font-extrabold text-gray-800 text-center">üîÆ ·ª®ng D·ª•ng B√≥c B√†i Tarot</h1>

    <!-- Ch·ªçn s·ªë l√° -->
    <div class="w-full bg-gray-50 p-4 rounded-lg shadow-sm">
      <h3 class="font-bold text-gray-700 mb-1">Ch·ªçn s·ªë l√° b√†i:</h3>
      <div class="flex flex-wrap gap-x-6 gap-y-2 justify-center">
        <label class="cursor-pointer"><input type="radio" name="spread-type" value="1" checked> 1 L√° T·ªïng Quan</label>
        <label class="cursor-pointer"><input type="radio" name="spread-type" value="3"> 3 L√° N·ªôi Dung S·∫Øp T·ªõi</label>
        <label class="cursor-pointer"><input type="radio" name="spread-type" value="5"> 5 L√° C·∫£ Cu·ªôc ƒê·ªùi</label>
      </div>
    </div>

    <!-- L√° l·ªõn -->
    <div class="flex justify-center">
      <div id="current-card" class="card">
        <img id="card-back-img" class="card-image" src="https://placehold.co/160x260/111111/FFFFFF?text=B%C3%93C+B%C3%80I" alt="M·∫∑t sau l√° b√†i">
      </div>
    </div>

    <!-- L√° ƒëang b√≥c -->
    <div id="current-spread-display" class="current-spread-display"></div>

    <!-- N√∫t h√†nh ƒë·ªông ch√≠nh -->
    <div class="button-area">
      <button id="draw-button">B√≥c B√†i</button>
      <button id="complete-spread-button" disabled>Ho√†n T·∫•t</button>
      <button id="coi-sau-them-btn" class="bg-amber" disabled>Coi S√¢u Th√™m</button>
      <button id="boc-bai-moi-btn" class="bg-red" disabled>B√≥c B√†i M·ªõi</button>
    </div>

    <div class="message-box" id="message-box"></div>

    <!-- ƒê·ªçc b√†i AI -->
    <div class="ai-reading-area">
      <h3 class="text-lg font-bold text-gray-700">ƒê·ªçc B√†i B·∫±ng AI</h3>

      <div class="flex gap-5 justify-center mb-2">
        <label><input type="radio" name="question-type" value="manual" checked> T·ª± nh·∫≠p c√¢u h·ªèi</label>
        <label><input type="radio" name="question-type" value="guided"> Ch·ªçn theo h∆∞·ªõng d·∫´n</label>
      </div>

      <textarea id="question-input" class="w-full p-2 border rounded-lg" placeholder="Nh·∫≠p c√¢u h·ªèi (vd: S·ª± nghi·ªáp 3 th√°ng t·ªõi?)"></textarea>

      <div id="guided-question-options" class="hidden mt-2">
        <select id="topic-select" class="w-full p-2 border rounded-lg mb-2">
          <option value="">-- Ch·ªçn Ch·ªß ƒê·ªÅ --</option>
          <option value="T√¨nh y√™u v√† m·ªëi quan h·ªá">T√¨nh y√™u v√† m·ªëi quan h·ªá</option>
          <option value="S·ª± nghi·ªáp v√† c√¥ng vi·ªác">S·ª± nghi·ªáp v√† c√¥ng vi·ªác</option>
          <option value="T√†i ch√≠nh v√† ti·ªÅn b·∫°c">T√†i ch√≠nh v√† ti·ªÅn b·∫°c</option>
          <option value="S·ª©c kh·ªèe v√† tinh th·∫ßn">S·ª©c kh·ªèe v√† tinh th·∫ßn</option>
          <option value="Ph√°t tri·ªÉn c√° nh√¢n">Ph√°t tri·ªÉn c√° nh√¢n</option>
          <option value="Gia ƒë√¨nh v√† b·∫°n b√®">Gia ƒë√¨nh v√† b·∫°n b√®</option>
          <option value="Quy·∫øt ƒë·ªãnh quan tr·ªçng">Quy·∫øt ƒë·ªãnh quan tr·ªçng</option>
        </select>
        <select id="timeframe-select" class="w-full p-2 border rounded-lg mb-2">
          <option value="">-- Ch·ªçn Th·ªùi Gian --</option>
          <option value="hi·ªán t·∫°i">Hi·ªán t·∫°i</option>
          <option value="trong 3 th√°ng t·ªõi">3 th√°ng t·ªõi</option>
          <option value="trong 6 th√°ng t·ªõi">6 th√°ng t·ªõi</option>
          <option value="trong 1 nƒÉm t·ªõi">1 nƒÉm t·ªõi</option>
        </select>
        <input id="additional-question" class="w-full p-2 border rounded-lg" placeholder="C√¢u h·ªèi b·ªï sung (n·∫øu c√≥)"/>
      </div>

      <p class="muted text-center">B·∫°n c√≥ th·ªÉ ƒë·ªïi ch·ªß ƒë·ªÅ ho·∫∑c nh·∫≠p c√¢u h·ªèi m·ªõi b·∫•t k·ª≥ l√∫c n√†o (k·ªÉ c·∫£ sau khi b·∫•m ‚ÄúCoi s√¢u th√™m‚Äù).</p>

      <div class="ai-reading-actions">
        <button id="get-ai-reading-button" disabled>Nh·∫≠n Gi·∫£i Th√≠ch T·ª´ AI</button>
      </div>

      <div id="ai-response-display" class="ai-response-sections">
        <div id="loading-ai-response" class="hidden italic text-center text-gray-600">ƒêang ph√¢n t√≠ch...</div>

        <div id="ai-card-interpretations-container" class="hidden">
          <h4 class="font-bold text-gray-700">Gi·∫£i th√≠ch t·ª´ng l√°:</h4>
          <div id="ai-card-interpretations-row" class="flex gap-2 flex-wrap"></div>
        </div>

        <div id="ai-overall-interpretation" class="ai-overall-interpretation hidden">
          <h4 class="font-bold text-gray-700 mb-1">T·ªïng Quan:</h4>
          <p id="overall-text"></p>
        </div>

        <div id="ai-suggestions" class="ai-suggestions hidden">
          <h4 class="font-bold text-gray-700 mb-1">G·ª£i √ù / B∆∞·ªõc Ti·∫øp:</h4>
          <p id="suggestions-text"></p>
        </div>
      </div>
    </div>

    <h2 class="text-xl font-bold text-gray-700">L·ªãch S·ª≠ C√°c L∆∞·ª£t B√≥c</h2>
    <div id="history-container" class="history-container"></div>
  </div>

  <script>
    // ====== B·ªô b√†i 78 l√° ======
    const allTarotCards = [
      "0 - The Fool","I - The Magician","II - The High Priestess","III - The Empress",
      "IV - The Emperor","V - The Hierophant","VI - The Lovers","VII - The Chariot",
      "VIII - Strength","IX - The Hermit","X - Wheel of Fortune","XI - Justice",
      "XII - The Hanged Man","XIII - Death","XIV - Temperance","XV - The Devil",
      "XVI - The Tower","XVII - The Star","XVIII - The Moon","XIX - The Sun",
      "XX - Judgement","XXI - The World",
      "Ace of Wands","Two of Wands","Three of Wands","Four of Wands","Five of Wands",
      "Six of Wands","Seven of Wands","Eight of Wands","Nine of Wands","Ten of Wands",
      "Page of Wands","Knight of Wands","Queen of Wands","King of Wands",
      "Ace of Cups","Two of Cups","Three of Cups","Four of Cups","Five of Cups",
      "Six of Cups","Seven of Cups","Eight of Cups","Nine of Cups","Ten of Cups",
      "Page of Cups","Knight of Cups","Queen of Cups","King of Cups",
      "Ace of Swords","Two of Swords","Three of Swords","Four of Swords","Five of Swords",
      "Six of Swords","Seven of Swords","Eight of Swords","Nine of Swords","Ten of Swords",
      "Page of Swords","Knight of Swords","Queen of Swords","King of Swords",
      "Ace of Pentacles","Two of Pentacles","Three of Pentacles","Four of Pentacles",
      "Five of Pentacles","Six of Pentacles","Seven of Pentacles","Eight of Pentacles",
      "Nine of Pentacles","Ten of Pentacles","Page of Pentacles","Knight of Pentacles",
      "Queen of Pentacles","King of Pentacles"
    ];

    // ====== State & DOM ======
    let currentDeck = [];
    let currentDrawnCards = [];
    let historySpreads = [];
    let numCardsToDraw = 1;

    // Deep mode
    let firstRoundCards = []; // gi·ªØ b·ªô l·∫ßn 1
    let deepMode = false;     // true khi ƒëang coi s√¢u
    let roundIndex = 1;       // 1 = l·∫ßn 1, 2 = l·∫ßn 2

    const currentCardElement = document.getElementById('current-card');
    const cardBackImg = document.getElementById('card-back-img');
    const drawButton = document.getElementById('draw-button');
    const completeSpreadButton = document.getElementById('complete-spread-button');
    const coiSauThemBtn = document.getElementById('coi-sau-them-btn');
    const bocBaiMoiBtn = document.getElementById('boc-bai-moi-btn');
    const messageBox = document.getElementById('message-box');
    const currentSpreadDisplay = document.getElementById('current-spread-display');
    const historyContainer = document.getElementById('history-container');

    const spreadTypeRadios = document.querySelectorAll('input[name="spread-type"]');
    const questionTypeRadios = document.querySelectorAll('input[name="question-type"]');
    const questionInput = document.getElementById('question-input');
    const guidedQuestionOptions = document.getElementById('guided-question-options');
    const topicSelect = document.getElementById('topic-select');
    const timeframeSelect = document.getElementById('timeframe-select');
    const additionalQuestionInput = document.getElementById('additional-question');

    const getAiReadingButton = document.getElementById('get-ai-reading-button');

    const aiCardInterpretationsContainer = document.getElementById('ai-card-interpretations-container');
    const aiCardInterpretationsRow = document.getElementById('ai-card-interpretations-row');
    const aiOverallInterpretation = document.getElementById('ai-overall-interpretation');
    const overallText = document.getElementById('overall-text');
    const aiSuggestions = documentElementByIdSafe('ai-suggestions');
    const suggestionsText = document.getElementById('suggestions-text');
    const loadingAiResponse = document.getElementById('loading-ai-response');

    function documentElementByIdSafe(id){ return document.getElementById(id); }

    // ====== Helpers ======
    function getCardColorHSL(name){
      const seed = [...name].reduce((a,c)=>a+c.charCodeAt(0),0);
      const hue = (seed*137.508)%360, sat=70+(seed%30), light=60+(seed%20);
      return `hsl(${hue}, ${sat}%, ${light}%)`;
    }
    function showMessage(msg,type='info'){
      messageBox.textContent = msg;
      messageBox.className = 'message-box show';
      messageBox.style.backgroundColor = type==='error' ? '#ef4444' : (type==='success' ? '#10b981' : '#3b82f6');
      setTimeout(()=>messageBox.classList.remove('show'), 2200);
    }
    function shuffleDeck(){
      currentDeck = [...allTarotCards];
      for (let i=currentDeck.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [currentDeck[i],currentDeck[j]] = [currentDeck[j],currentDeck[i]];
      }
      showMessage('B·ªô b√†i ƒë√£ ƒë∆∞·ª£c x√°o!', 'success');
    }
    function updateCurrentCardDisplay(cardName){
      currentCardElement.classList.add('drawn');
      currentCardElement.style.backgroundColor = getCardColorHSL(cardName);
      if (cardBackImg) cardBackImg.style.display='none';
      let overlay = currentCardElement.querySelector('.card-text-overlay');
      if (!overlay) {
        overlay = document.createElement('div');
        overlay.className = 'card-text-overlay';
        currentCardElement.appendChild(overlay);
      }
      overlay.textContent = cardName;
    }
    function updateCurrentSpreadDisplay(){
      currentSpreadDisplay.innerHTML='';
      currentDrawnCards.forEach(name=>{
        const d=document.createElement('div');
        d.className='current-spread-card';
        d.style.backgroundColor=getCardColorHSL(name);
        d.innerHTML=`<span class="card-name-text">${name}</span>`;
        currentSpreadDisplay.appendChild(d);
      });
    }
    function renderHistoryRow(cards, label){
      const rowWrap = document.createElement('div');
      if (label){
        const cap = document.createElement('div');
        cap.className='text-xs font-semibold text-gray-600 text-center mt-1';
        cap.textContent = label;
        rowWrap.appendChild(cap);
      }
      const row = document.createElement('div');
      row.className='history-row';
      cards.forEach(n=>{
        const c=document.createElement('div'); c.className='history-card-item';
        c.style.backgroundColor=getCardColorHSL(n);
        c.innerHTML=`<span class="card-name-text">${n}</span>`;
        row.appendChild(c);
      });
      rowWrap.appendChild(row);
      return rowWrap;
    }
    function updateHistoryDisplay(){
      historyContainer.innerHTML='';
      historySpreads.slice().reverse().forEach((entry, idx)=>{
        const wrap=document.createElement('div'); wrap.className='history-spread-group';
        const head=document.createElement('div');
        head.className='flex items-center justify-between text-sm font-bold text-gray-700';
        const badge = entry.mode==='deep'
          ? `<span class="history-badge">Deep</span>`
          : `<span class="history-badge">Single</span>`;
        head.innerHTML=`<span>B·ªô ${historySpreads.length-idx}</span><span class="flex items-center gap-2">${badge}<span>${entry.timestamp}</span></span>`;
        wrap.appendChild(head);

        if (entry.mode==='deep' && entry.rounds){
          wrap.appendChild(renderHistoryRow(entry.rounds.r1, 'L·∫ßn 1'));
          wrap.appendChild(renderHistoryRow(entry.rounds.r2, 'L·∫ßn 2'));
        } else {
          wrap.appendChild(renderHistoryRow(entry.cards, null));
        }
        historyContainer.appendChild(wrap);
      });
      historyContainer.scrollTop=0;
    }
    function clearAiResponseDisplay(){
      aiCardInterpretationsRow.innerHTML='';
      aiCardInterpretationsContainer.classList.add('hidden');
      aiOverallInterpretation.classList.add('hidden'); overallText.textContent='';
      aiSuggestions.classList.add('hidden'); suggestionsText.textContent='';
      loadingAiResponse.classList.add('hidden');
    }
    function resetGameVisuals(){
      currentCardElement.classList.remove('drawn');
      currentCardElement.style.backgroundColor='';
      if (cardBackImg) cardBackImg.style.display='block';
      const ov=currentCardElement.querySelector('.card-text-overlay'); if (ov) ov.remove();

      drawButton.textContent='B√≥c B√†i';
      drawButton.disabled=false;
      completeSpreadButton.disabled=true;
      getAiReadingButton.disabled=true;
      coiSauThemBtn.disabled=true;
      bocBaiMoiBtn.disabled=true;

      clearAiResponseDisplay();
      questionInput.value='';
      topicSelect.value=''; timeframeSelect.value=''; additionalQuestionInput.value='';
    }

    // ====== Game actions ======
    function drawCard(){
      // Trong deep mode, l·∫ßn 2 c≈©ng c·∫ßn ƒë·ªß numCardsToDraw l√°
      if (currentDrawnCards.length >= numCardsToDraw){
        showMessage(`B·∫°n ƒë√£ b√≥c ƒë·ªß ${numCardsToDraw} l√°.`, 'info'); return;
      }
      if (!currentDeck.length) shuffleDeck();
      const idx = Math.floor(Math.random()*currentDeck.length);
      const card = currentDeck.splice(idx,1)[0];
      currentDrawnCards.push(card);
      updateCurrentCardDisplay(card);
      updateCurrentSpreadDisplay();

      // K√≠ch ho·∫°t n√∫t khi ƒë·ªß l√° cho v√≤ng hi·ªán t·∫°i
      if (currentDrawnCards.length === numCardsToDraw){
        drawButton.disabled=true;
        completeSpreadButton.disabled=false;
        getAiReadingButton.disabled=false;
        coiSauThemBtn.disabled = !deepMode && roundIndex===1; // ch·ªâ hi·ªán sau khi xong l·∫ßn 1
        bocBaiMoiBtn.disabled=false;
        if (!deepMode) showMessage(`ƒê·ªß ${numCardsToDraw} l√°. B·∫°n c√≥ th·ªÉ 'AI' / 'Ho√†n t·∫•t' / 'Coi s√¢u th√™m'.`, 'success');
        else showMessage(`L·∫ßn 2 ƒë√£ ƒë·ªß ${numCardsToDraw} l√°. C√≥ th·ªÉ 'AI' ho·∫∑c 'Ho√†n t·∫•t'.`, 'success');
      } else {
        drawButton.textContent = `B√≥c B√†i (L√° ${currentDrawnCards.length+1}/${numCardsToDraw})`;
      }
    }

    function completeSpread(){
      const timestamp = new Date().toLocaleString('vi-VN',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false});

      // N·∫øu deep mode
      if (deepMode && roundIndex===2){
        if (currentDrawnCards.length === numCardsToDraw){
          // L∆∞u deep: r1 + r2
          const secondRoundCards = [...currentDrawnCards];
          historySpreads.push({
            timestamp, spreadType: numCardsToDraw, mode:'deep',
            rounds:{ r1:firstRoundCards, r2:secondRoundCards }, cards:[...firstRoundCards, ...secondRoundCards]
          });
          firstRoundCards=[]; deepMode=false; roundIndex=1;
          currentDrawnCards=[]; currentSpreadDisplay.innerHTML='';
          updateHistoryDisplay(); resetGameVisuals(); shuffleDeck();
          showMessage('ƒê√£ l∆∞u (L·∫ßn 1 + L·∫ßn 2) v√†o l·ªãch s·ª≠.', 'success');
          return;
        }
        if (currentDrawnCards.length === 0){
          // Ng∆∞·ªùi d√πng ƒë·ªïi √Ω, ch·ªâ l∆∞u L·∫ßn 1
          historySpreads.push({
            timestamp, spreadType: numCardsToDraw, mode:'single', cards:[...firstRoundCards]
          });
          firstRoundCards=[]; deepMode=false; roundIndex=1;
          updateHistoryDisplay(); resetGameVisuals(); shuffleDeck();
          showMessage('ƒê√£ l∆∞u L·∫ßn 1 (b·ªè coi s√¢u).', 'success');
          return;
        }
        // ƒêang d·ªü L·∫ßn 2
        showMessage(`Ch∆∞a ƒë·ªß ${numCardsToDraw} l√° ·ªü L·∫ßn 2.`, 'error');
        return;
      }

      // Kh√¥ng deep mode (l·∫ßn 1 b√¨nh th∆∞·ªùng)
      if (currentDrawnCards.length !== numCardsToDraw){
        if (currentDrawnCards.length===0 && historySpreads.length>0){
          resetGameVisuals(); shuffleDeck(); showMessage('B·∫Øt ƒë·∫ßu l∆∞·ª£t m·ªõi.', 'info'); return;
        }
        showMessage(`Ch∆∞a ƒë·ªß ${numCardsToDraw} l√°.`, 'error'); 
        return;
      }

      historySpreads.push({
        timestamp, spreadType:numCardsToDraw, mode:'single', cards:[...currentDrawnCards]
      });

      currentDrawnCards=[]; currentSpreadDisplay.innerHTML='';
      updateHistoryDisplay(); resetGameVisuals(); shuffleDeck();
      showMessage('ƒê√£ l∆∞u v√†o l·ªãch s·ª≠.', 'success');
    }

    // ====== Question builder ======
    function getUserQuestion(){
      const type = document.querySelector('input[name="question-type"]:checked').value;
      if (type==='manual') return (questionInput.value||'').trim();
      const parts=[];
      if (topicSelect.value) parts.push(`Ch·ªß ƒë·ªÅ: ${topicSelect.value}.`);
      if (timeframeSelect.value) parts.push(`Th·ªùi gian mu·ªën bi·∫øt: ${timeframeSelect.value}.`);
      if (additionalQuestionInput.value.trim()) parts.push(`C√¢u h·ªèi c·ª• th·ªÉ: ${additionalQuestionInput.value.trim()}.`);
      return parts.join(' ');
    }

    // ====== AI call via Vercel route ======
    async function getAiReading(){
      const userQuestion = getUserQuestion();
      if (!userQuestion){ showMessage('Vui l√≤ng nh·∫≠p/ch·ªçn c√¢u h·ªèi.', 'error'); return; }

      // X√°c ƒë·ªãnh cards g·ª≠i cho AI
      let cardsForAi = [];
      let meta = { mode: 'single' };

      if (deepMode && roundIndex===2){
        if (currentDrawnCards.length === numCardsToDraw){
          // d√πng r1 + r2 ƒë·∫ßy ƒë·ªß
          cardsForAi = [...firstRoundCards, ...currentDrawnCards];
          meta = { mode:'deep', round1:firstRoundCards, round2:currentDrawnCards };
        } else if (currentDrawnCards.length === 0){
          // ng∆∞·ªùi d√πng ƒë·ªïi √Ω: ch·ªâ d√πng L·∫ßn 1
          cardsForAi = [...firstRoundCards];
          meta = { mode:'deep', round1:firstRoundCards, round2:[] };
          showMessage('ƒêang d√πng L·∫ßn 1 (ch∆∞a r√∫t L·∫ßn 2).', 'info');
        } else {
          // ƒêang d·ªü L·∫ßn 2 ‚Üí v·∫´n cho ph√¢n t√≠ch t·∫°m th·ªùi r1 + ph·∫ßn ƒë√£ r√∫t
          cardsForAi = [...firstRoundCards, ...currentDrawnCards];
          meta = { mode:'deep', round1:firstRoundCards, round2:currentDrawnCards };
          showMessage('Ph√¢n t√≠ch t·∫°m th·ªùi v·ªõi L·∫ßn 2 ch∆∞a ƒë·ªß l√°.', 'info');
        }
      } else {
        // b√¨nh th∆∞·ªùng
        if (currentDrawnCards.length !== numCardsToDraw){
          showMessage(`H√£y b√≥c ƒë·ªß ${numCardsToDraw} l√° tr∆∞·ªõc ho·∫∑c b·∫•m ‚ÄúHo√†n t·∫•t‚Äù.`, 'error'); return;
        }
        cardsForAi = [...currentDrawnCards];
      }

      clearAiResponseDisplay();
      loadingAiResponse.classList.remove('hidden');
      getAiReadingButton.disabled = true;

      try{
        const res = await fetch('/api/ai-reading', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ cards: cardsForAi, question: userQuestion, meta })
        });
        const data = await res.json();
        if (!res.ok){ throw new Error(data?.error || 'AI error'); }

        // Render
        aiCardInterpretationsRow.innerHTML='';
        if (Array.isArray(data.cardInterpretations)){
          data.cardInterpretations.forEach(item=>{
            const div=document.createElement('div');
            div.className='ai-card-interpretation';
            div.innerHTML = `<strong>${item.cardName}:</strong> <div>${item.interpretation}</div>`;
            aiCardInterpretationsRow.appendChild(div);
          });
          aiCardInterpretationsContainer.classList.remove('hidden');
        }
        overallText.textContent = data.overallInterpretation || '';
        aiOverallInterpretation.classList.remove('hidden');
        suggestionsText.textContent = data.nextStepsSuggestion || '';
        document.getElementById('ai-suggestions').classList.remove('hidden');

        // Sau khi AI tr·∫£ l·ªùi: user v·∫´n c√≥ th·ªÉ ‚ÄúCoi s√¢u th√™m‚Äù n·∫øu ch∆∞a v√†o deep
        if (!deepMode && roundIndex===1 && currentDrawnCards.length===numCardsToDraw){
          coiSauThemBtn.disabled = false;
        }
        bocBaiMoiBtn.disabled = false;
        completeSpreadButton.disabled = false;
        showMessage('AI ƒë√£ ph·∫£n h·ªìi.', 'success');
      } catch(err){
        showMessage(`L·ªói AI: ${err.message}`, 'error');
      } finally{
        loadingAiResponse.classList.add('hidden');
        // Cho ph√©p h·ªèi ti·∫øp c√¢u kh√°c ngay
        getAiReadingButton.disabled = false;
      }
    }

    // ====== Events ======
    document.addEventListener('DOMContentLoaded', ()=>{
      // N√∫t ch√≠nh
      drawButton.addEventListener('click', drawCard);
      completeSpreadButton.addEventListener('click', completeSpread);
      bocBaiMoiBtn.addEventListener('click', completeSpread);
      getAiReadingButton.addEventListener('click', getAiReading);

      coiSauThemBtn.addEventListener('click', ()=>{
        // Ch·ªâ cho v√†o deep khi l·∫ßn 1 ƒë√£ ƒë·ªß
        if (currentDrawnCards.length !== numCardsToDraw){
          showMessage(`H√£y b√≥c ƒë·ªß ${numCardsToDraw} l√° tr∆∞·ªõc khi coi s√¢u th√™m.`, 'error');
          return;
        }
        firstRoundCards = [...currentDrawnCards];
        deepMode = true;
        roundIndex = 2;

        currentDrawnCards = [];
        currentSpreadDisplay.innerHTML = '';
        drawButton.disabled = false;
        completeSpreadButton.disabled = false; // cho ph√©p l∆∞u L·∫ßn 1 n·∫øu ƒë·ªïi √Ω
        getAiReadingButton.disabled = false;   // cho ph√©p h·ªèi AI ch·ªâ v·ªõi L·∫ßn 1
        bocBaiMoiBtn.disabled = false;

        showMessage('ƒêang ·ªü ch·∫ø ƒë·ªô coi s√¢u: h√£y b√≥c L·∫¶N 2 ho·∫∑c h·ªèi AI v·ªõi L·∫ßn 1.', 'info');
      });

      // Spread size change
      spreadTypeRadios.forEach(r=>r.addEventListener('change', e=>{
        numCardsToDraw = parseInt(e.target.value,10);
        // reset to√†n b·ªô tr·∫°ng th√°i
        firstRoundCards=[]; deepMode=false; roundIndex=1;
        currentDrawnCards=[]; currentSpreadDisplay.innerHTML='';
        resetGameVisuals(); shuffleDeck();
        showMessage(`B·∫°n ƒë√£ ch·ªçn b√≥c ${numCardsToDraw} l√°.`, 'info');
      }));

      // Question type toggle
      questionTypeRadios.forEach(r=>r.addEventListener('change', e=>{
        const guided = e.target.value==='guided';
        guidedQuestionOptions.classList.toggle('hidden', !guided);
        questionInput.classList.toggle('hidden', guided);
      }));

      // Kh·ªüi t·∫°o
      shuffleDeck(); resetGameVisuals();
    });
  </script>
</body>
</html>
