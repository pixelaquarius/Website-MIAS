<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Ứng Dụng Bói Bài Tarot</title>

  <!-- Đặt API BASE = domain hiện tại -->
  <script>window.__API_BASE = location.origin + "/api";</script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&family=Be+Vietnam+Pro:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --glass: rgba(255,255,255,.06); --bd: rgba(255,255,255,.12); }
    body{font-family:"Be Vietnam Pro",system-ui,Segoe UI,Roboto; background: radial-gradient(1200px 600px at 10% -10%, #1c2750 0, transparent 60%), radial-gradient(1000px 500px at 100% 10%, #13203e 0, transparent 60%), #0b0f1a;}
    .font-title{font-family:"Merriweather",serif}
    .glass{background:var(--glass); border:1px solid var(--bd); backdrop-filter: blur(10px)}
    .btn{padding:.7rem 1.2rem;border-radius:999px;background:#334155;color:#e5e7eb;font-weight:700;box-shadow:0 8px 24px rgba(0,0,0,.25);transition:.2s}
    .btn:hover{filter:brightness(1.1); transform:translateY(-1px)}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn-accent{background:#1e3a8a}
    .btn-danger{background:#7f1d1d}
    .btn-merge{background:#065f46}
    .btn-gold{background:linear-gradient(180deg,#b88422,#8b5e12)}
    .btn-muted{background:#374151}
    .chip{display:inline-flex;align-items:center;gap:.5rem;padding:.5rem .9rem;border-radius:999px;background:#1f2937;border:1px solid #334155}
    .chip input{accent-color:#f59e0b}
    .label{color:#cbd5e1}
    .hint{font-size:.9rem;color:#94a3b8}
    .msg{margin-top:.5rem;padding:.6rem .8rem;border-radius:.6rem}
    .msg.ok{background:#0f5132;color:#d1fae5} .msg.err{background:#5c1414;color:#fecaca}

    /* Big card */
    .big-card{width:220px; height:360px; border-radius:1rem; margin-top:8px; position:relative; overflow:hidden;
      box-shadow: 0 20px 50px rgba(0,0,0,.45), inset 0 0 0 1px rgba(255,255,255,.06);}
    .big-card .card-back{position:absolute;inset:0;
      background-image:url('https://images.unsplash.com/photo-1610544474326-4a9b101f06b2?q=80&w=1200&auto=format&fit=crop'); /* mặt sau tarot */
      background-size:cover;background-position:center;filter:contrast(1.1) saturate(1.2)}
    .big-card img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
    .card-title{position:absolute;left:0;right:0;bottom:0;padding:.6rem 1rem;background:linear-gradient(180deg,transparent,rgba(0,0,0,.65));
      color:#fff;font-weight:700;text-shadow:0 2px 10px rgba(0,0,0,.6)}

    /* Current row (lá nhỏ) */
    .current-row{display:flex;gap:.6rem;justify-content:center;flex-wrap:wrap;margin-top:14px}
    .mini{width:90px;height:140px;border-radius:.6rem;overflow:hidden;border:1px solid rgba(255,255,255,.08);box-shadow:0 10px 18px rgba(0,0,0,.32)}
    .mini img{width:100%;height:100%;object-fit:cover}

    /* AI sections */
    .textarea{width:100%;min-height:96px;padding:12px;border-radius:.8rem;background:#0f172a;border:1px solid #1f2a44;color:#e2e8f0}
    .select{width:100%;padding:.75rem;border-radius:.8rem;background:#0f172a;border:1px solid #1f2a44;color:#e2e8f0}
    .tips .chips{display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.5rem}
    .tip-chip{background:#1f2937;color:#cbd5e1;border:1px solid #334155;border-radius:999px;padding:.35rem .7rem;font-size:.85rem}
    .section-title{font-size:1.35rem;margin-bottom:.5rem}
    .sub-title{font-size:1.1rem;margin:.3rem 0 .4rem}
    .ai-cards-row{display:grid;grid-template-columns:repeat(auto-fill,minmax(230px,1fr));gap:.75rem}
    .ai-item{border:1px solid #2b365a;background:#0f172a;border-radius:.8rem;padding:.75rem}
    .ai-panel{border:1px solid #2b365a;background:#0f172a;border-radius:.8rem;padding:1rem}
    .ai-loading{margin-top:10px;color:#9ca3af}
    .btn-loading{display:none;margin-left:.6rem}
    #ask-ai-btn.loading .btn-text{display:none}
    #ask-ai-btn.loading .btn-loading{display:inline-flex;align-items:center;gap:.45rem}
    .spinner{width:16px;height:16px;border-radius:50%;border:2px solid #fbbf24;border-top-color:transparent;animation:sp .8s linear infinite}
    @keyframes sp{to{transform:rotate(360deg)}}

    /* History */
    .history{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:.9rem}
    .history-card{padding:.6rem;border-radius:.9rem;background:#0f172a;border:1px solid #1f2a44;cursor:pointer}
    .history-strip{display:flex;gap:.35rem}
    .history-strip .mini{width:48px;height:75px;box-shadow:none}
    .history-strip .mini img{width:100%;height:100%;object-fit:cover}

    /* Modal */
    .modal{border:none;background:transparent}
    .modal::backdrop{background:rgba(0,0,0,.55)}
    .modal-box{max-width:780px;width:calc(100vw - 2rem);background:#0b1224;border:1px solid #1f2a44;border-radius:1rem;padding:1rem}
  </style>
</head>
<body class="text-slate-100">
  <main class="container mx-auto px-4 py-6 max-w-6xl">
    <header class="text-center mb-6">
      <h1 class="font-title text-3xl sm:text-5xl font-bold tracking-wide">ỨNG DỤNG BÓI BÀI TAROT</h1>
      <p class="mt-2 text-slate-300">Giao diện ma thuật, ảnh lá bài thật, mượt trên máy tính & điện thoại.</p>
    </header>

    <!-- 1) Chọn số lá -->
    <section class="glass p-4 rounded-2xl mb-6">
      <div class="flex flex-wrap items-center gap-3 justify-center">
        <span class="label">Số lá/lượt:</span>
        <label class="chip"><input type="radio" name="spread-type" value="1" checked> 1 Lá</label>
        <label class="chip"><input type="radio" name="spread-type" value="3"> 3 Lá</label>
        <label class="chip"><input type="radio" name="spread-type" value="5"> 5 Lá</label>
      </div>
      <p class="hint mt-3 text-center">Bạn có thể “Coi sâu thêm” nhiều lần cho cùng bộ. Nếu đổi chủ đề, chỉ cần hỏi mới — không cần bóc lại.</p>
      <div id="msg" class="msg hidden"></div>
    </section>

    <!-- 2) Khu hiển thị bài + CÁC NÚT HÀNH ĐỘNG ĐÃ DỊCH XUỐNG ĐÂY -->
    <section class="glass p-4 rounded-2xl mb-6">
      <div class="big-card mx-auto" id="big-card">
        <div class="card-back"></div>
        <img id="big-card-img" alt="" class="hidden" />
        <div id="big-card-title" class="card-title hidden"></div>
      </div>
      <div id="current-row" class="current-row"></div>

      <div class="mt-4 flex flex-wrap items-center gap-3 justify-center">
        <button id="draw-btn" class="btn">Bóc Bài</button>
        <button id="complete-btn" class="btn btn-muted" disabled>Hoàn Tất</button>
        <button id="deepen-btn" class="btn btn-accent" disabled>Coi Sâu Thêm</button>
        <button id="merge-btn" class="btn btn-merge" disabled>Kết hợp & Tổng quan</button>
        <button id="new-spread-btn" class="btn btn-danger" disabled>Bóc Bài Mới</button>
      </div>
    </section>

    <!-- 3) AI -->
    <section class="glass p-4 rounded-2xl mb-8">
      <h2 class="section-title font-title">Đọc Bài Bằng AI</h2>

      <div class="flex flex-wrap items-center gap-3 mb-3">
        <label class="chip"><input type="radio" name="q-type" value="manual" checked> Tự nhập câu hỏi</label>
        <label class="chip"><input type="radio" name="q-type" value="guided"> Chọn theo hướng dẫn</label>
      </div>

      <div id="manual-box">
        <textarea id="question" class="textarea" placeholder="Nhập câu hỏi của bạn..."></textarea>
        <div class="tips mt-2">
          <div class="text-slate-300 text-sm">Gợi ý cấu trúc: <b>Bối cảnh</b> + <b>Chủ đề</b> + <b>Thời gian</b> + <b>Mong muốn</b> (+ <b>ràng buộc</b>).</div>
          <div class="chips">
            <button class="tip-chip" data-insert="Tổng quan tình cảm trong 3 tháng tới, điều gì nổi bật và cần tránh?">Tình cảm • 3 tháng</button>
            <button class="tip-chip" data-insert="Sự nghiệp 6 tháng tới, rủi ro và cơ hội chính là gì?">Sự nghiệp • 6 tháng</button>
            <button class="tip-chip" data-insert="Tôi đang đứng trước một quyết định quan trọng, hướng đi phù hợp trong tháng tới?">Quyết định • 1 tháng</button>
          </div>
        </div>
      </div>

      <div id="guided-box" class="hidden grid gap-3 sm:grid-cols-3">
        <select id="topic" class="select">
          <option value="">-- Chủ đề --</option>
          <option>Tình yêu và mối quan hệ</option>
          <option>Sự nghiệp và công việc</option>
          <option>Tài chính và tiền bạc</option>
          <option>Sức khỏe và tinh thần</option>
          <option>Phát triển cá nhân</option>
          <option>Quyết định quan trọng</option>
        </select>
        <select id="timeframe" class="select">
          <option value="">-- Thời gian --</option>
          <option>hiện tại</option>
          <option>trong 3 tháng tới</option>
          <option>trong 6 tháng tới</option>
          <option>trong 1 năm tới</option>
          <option>trong tương lai xa</option>
        </select>
        <input id="extra" class="select" placeholder="Câu hỏi bổ sung (nếu có)"/>
      </div>

      <div class="text-center mt-4">
        <button id="ask-ai-btn" class="btn btn-gold">
          <span class="btn-text">Nhận Giải Thích Từ AI</span>
          <span class="btn-loading"><span class="spinner"></span> Đang gọi AI...</span>
        </button>
      </div>

      <div id="ai-loading" class="ai-loading hidden">Đang phân tích...</div>

      <div id="ai-cards" class="hidden">
        <h3 class="sub-title font-title">Giải thích từng lá</h3>
        <div id="ai-cards-row" class="ai-cards-row"></div>
      </div>

      <div id="ai-overall" class="ai-panel hidden">
        <h3 class="sub-title font-title">Tổng Quan</h3>
        <p id="overall-text"></p>
      </div>
      <div id="ai-next" class="ai-panel hidden">
        <h3 class="sub-title font-title">Gợi ý & Bước tiếp theo</h3>
        <p id="next-text"></p>
      </div>
    </section>

    <!-- 4) Lịch sử -->
    <section class="glass p-4 rounded-2xl">
      <h2 class="section-title font-title">Lịch Sử Các Lượt Bóc</h2>
      <div id="history" class="history"></div>
    </section>
  </main>

  <!-- Modal lịch sử -->
  <dialog id="history-modal" class="modal">
    <div class="modal-box">
      <div class="flex items-start justify-between gap-4">
        <h3 class="text-xl font-semibold font-title">Chi tiết lượt bóc</h3>
        <button id="close-modal" class="btn btn-danger px-3">Đóng</button>
      </div>
      <div id="modal-content" class="mt-4 space-y-6"></div>
    </div>
  </dialog>

  <script src="./script.js"></script>
</body>
</html>
